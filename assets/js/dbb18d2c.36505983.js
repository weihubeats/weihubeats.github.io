"use strict";(globalThis.webpackChunkweihubeats_website=globalThis.webpackChunkweihubeats_website||[]).push([[8723],{7141(e,n,r){r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>u,frontMatter:()=>a,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"\u5b89\u5168/\u7528\u6237\u6743\u9650/\u4ece\u96f6\u5230\u4e00\u8bbe\u8ba1\u4e00\u5957\u591a\u79df\u6237\u6743\u9650\u63a7\u5236","title":"\u4ece\u96f6\u5230\u4e00\u8bbe\u8ba1\u4e00\u5957\u591a\u79df\u6237\u6743\u9650\u63a7\u5236","description":"\u80cc\u666f","source":"@site/docs/\u5b89\u5168/\u7528\u6237\u6743\u9650/\u4ece\u96f6\u5230\u4e00\u8bbe\u8ba1\u4e00\u5957\u591a\u79df\u6237\u6743\u9650\u63a7\u5236.md","sourceDirName":"\u5b89\u5168/\u7528\u6237\u6743\u9650","slug":"/\u5b89\u5168/\u7528\u6237\u6743\u9650/\u4ece\u96f6\u5230\u4e00\u8bbe\u8ba1\u4e00\u5957\u591a\u79df\u6237\u6743\u9650\u63a7\u5236","permalink":"/docs/\u5b89\u5168/\u7528\u6237\u6743\u9650/\u4ece\u96f6\u5230\u4e00\u8bbe\u8ba1\u4e00\u5957\u591a\u79df\u6237\u6743\u9650\u63a7\u5236","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/\u5b89\u5168/\u7528\u6237\u6743\u9650/\u4ece\u96f6\u5230\u4e00\u8bbe\u8ba1\u4e00\u5957\u591a\u79df\u6237\u6743\u9650\u63a7\u5236.md","tags":[],"version":"current","lastUpdatedAt":1768388265000,"frontMatter":{},"sidebar":"\u5b89\u5168_\u7528\u6237\u6743\u9650","previous":{"title":"OIDC\u662f\u4ec0\u4e48\uff0c\u4e3a\u4ec0\u4e48\u9700\u8981OIDC","permalink":"/docs/\u5b89\u5168/\u7528\u6237\u6743\u9650/OIDC\u662f\u4ec0\u4e48\uff0c\u4e3a\u4ec0\u4e48\u9700\u8981OIDC"},"next":{"title":"\u4f7f\u7528Sa-Token\u5b9e\u73b0\u4e09\u65b9\u767b\u5165-OAuth 2.0","permalink":"/docs/\u5b89\u5168/\u7528\u6237\u6743\u9650/\u4f7f\u7528Sa-Token\u5b9e\u73b0\u4e09\u65b9\u767b\u5165-OAuth 2.0"}}');var i=r(74848),s=r(28453);const a={},d=void 0,l={},o=[{value:"\u80cc\u666f",id:"\u80cc\u666f",level:2},{value:"\u8868\u7ed3\u6784\u8bbe\u8ba1",id:"\u8868\u7ed3\u6784\u8bbe\u8ba1",level:2},{value:"\u7cfb\u7edf\u6ce8\u518c\u8868",id:"\u7cfb\u7edf\u6ce8\u518c\u8868",level:3},{value:"\u83dc\u5355/\u6309\u94ae\u6743\u9650\u8868 (\u5b9a\u4e49\u903b\u8f91\u6743\u9650\uff0c\u4e0d\u5305\u542b\u5177\u4f53URL)",id:"\u83dc\u5355\u6309\u94ae\u6743\u9650\u8868-\u5b9a\u4e49\u903b\u8f91\u6743\u9650\u4e0d\u5305\u542b\u5177\u4f53url",level:3},{value:"API \u63a5\u53e3\u8868 (\u5b9a\u4e49\u540e\u7aef\u6240\u6709\u63a5\u53e3\u8d44\u6e90)",id:"api-\u63a5\u53e3\u8868-\u5b9a\u4e49\u540e\u7aef\u6240\u6709\u63a5\u53e3\u8d44\u6e90",level:3},{value:"\u83dc\u5355-API \u7ed1\u5b9a\u8868 (\u4e00\u4e2a\u6309\u94ae -&gt; \u591a\u4e2aAPI)",id:"\u83dc\u5355-api-\u7ed1\u5b9a\u8868-\u4e00\u4e2a\u6309\u94ae---\u591a\u4e2aapi",level:3},{value:"\u89d2\u8272-\u83dc\u5355\u7ed1\u5b9a\u8868",id:"\u89d2\u8272-\u83dc\u5355\u7ed1\u5b9a\u8868",level:3},{value:"\u7528\u6237\u8868",id:"\u7528\u6237\u8868",level:3},{value:"\u89d2\u8272\u8868(\u5f52\u5c5e\u4e8e\u7279\u5b9a\u5e94\u7528)",id:"\u89d2\u8272\u8868\u5f52\u5c5e\u4e8e\u7279\u5b9a\u5e94\u7528",level:3},{value:"\u6743\u9650/\u83dc\u5355\u8868 (\u83dc\u5355\u3001\u6309\u94ae\u3001API\u7ed1\u5b9a)",id:"\u6743\u9650\u83dc\u5355\u8868-\u83dc\u5355\u6309\u94aeapi\u7ed1\u5b9a",level:3},{value:"\u7528\u6237-\u89d2\u8272\u5173\u8054\u8868",id:"\u7528\u6237-\u89d2\u8272\u5173\u8054\u8868",level:3},{value:"\u89d2\u8272-\u6743\u9650\u5173\u8054\u8868",id:"\u89d2\u8272-\u6743\u9650\u5173\u8054\u8868",level:3},{value:"java\u4ee3\u7801\u5b9e\u73b0",id:"java\u4ee3\u7801\u5b9e\u73b0",level:2},{value:"\u9274\u6743\u6838\u5fc3\u67b6\u6784 (\u52a8\u6001 URL \u9274\u6743)",id:"\u9274\u6743\u6838\u5fc3\u67b6\u6784-\u52a8\u6001-url-\u9274\u6743",level:3},{value:"\u5168\u5c40\u62e6\u622a\u5668",id:"\u5168\u5c40\u62e6\u622a\u5668",level:3},{value:"\u6743\u9650\u7ef4\u62a4\u63a5\u53e3",id:"\u6743\u9650\u7ef4\u62a4\u63a5\u53e3",level:3},{value:"\u767b\u5165\u767b\u51fa\u63a5\u53e3\u5b9e\u73b0",id:"\u767b\u5165\u767b\u51fa\u63a5\u53e3\u5b9e\u73b0",level:3}];function c(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"\u80cc\u666f",children:"\u80cc\u666f"}),"\n",(0,i.jsx)(n.p,{children:"\u8bbe\u8ba1\u4e00\u5957\u5141\u8bb8\u591a\u7cfb\u7edf(\u79df\u6237)\u7684\u6743\u9650\u7cfb\u7edf"}),"\n",(0,i.jsx)(n.h2,{id:"\u8868\u7ed3\u6784\u8bbe\u8ba1",children:"\u8868\u7ed3\u6784\u8bbe\u8ba1"}),"\n",(0,i.jsx)(n.h3,{id:"\u7cfb\u7edf\u6ce8\u518c\u8868",children:"\u7cfb\u7edf\u6ce8\u518c\u8868"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE `sys_app` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `app_name` varchar(100) NOT NULL COMMENT '\u7cfb\u7edf\u540d\u79f0',\n  `app_code` varchar(50) NOT NULL COMMENT '\u7cfb\u7edf\u7f16\u7801 (\u5982: CRM, ERP)',\n  `status` tinyint(4) DEFAULT '1' COMMENT '\u72b6\u6001 1:\u6b63\u5e38 0:\u7981\u7528',\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `uk_app_code` (`app_code`)\n) ENGINE=InnoDB COMMENT='\u5e94\u7528\u6ce8\u518c\u8868';\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u83dc\u5355\u6309\u94ae\u6743\u9650\u8868-\u5b9a\u4e49\u903b\u8f91\u6743\u9650\u4e0d\u5305\u542b\u5177\u4f53url",children:"\u83dc\u5355/\u6309\u94ae\u6743\u9650\u8868 (\u5b9a\u4e49\u903b\u8f91\u6743\u9650\uff0c\u4e0d\u5305\u542b\u5177\u4f53URL)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE `sys_menu` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `parent_id` bigint(20) DEFAULT '0',\n  `app_code` varchar(50) NOT NULL,\n  `name` varchar(50) NOT NULL COMMENT '\u83dc\u5355\u6216\u6309\u94ae\u540d\u79f0',\n  `type` tinyint(4) NOT NULL COMMENT '1:\u83dc\u5355 2:\u6309\u94ae',\n  `perm_code` varchar(100) NOT NULL COMMENT '\u6743\u9650\u6807\u8bc6 (\u5982: user:add)',\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `uk_perm` (`perm_code`)\n) COMMENT='\u524d\u7aef\u8d44\u6e90(\u83dc\u5355/\u6309\u94ae)';\n"})}),"\n",(0,i.jsx)(n.h3,{id:"api-\u63a5\u53e3\u8868-\u5b9a\u4e49\u540e\u7aef\u6240\u6709\u63a5\u53e3\u8d44\u6e90",children:"API \u63a5\u53e3\u8868 (\u5b9a\u4e49\u540e\u7aef\u6240\u6709\u63a5\u53e3\u8d44\u6e90)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE `sys_api` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `app_code` varchar(50) NOT NULL,\n  `path` varchar(200) NOT NULL COMMENT '\u63a5\u53e3\u8def\u5f84 (\u5982: /api/user/**)',\n  `method` varchar(10) DEFAULT 'ALL' COMMENT '\u8bf7\u6c42\u65b9\u5f0f: GET, POST, PUT, DELETE, ALL',\n  `name` varchar(100) DEFAULT NULL COMMENT '\u63a5\u53e3\u63cf\u8ff0',\n  PRIMARY KEY (`id`)\n) COMMENT='\u540e\u7aefAPI\u63a5\u53e3';\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u83dc\u5355-api-\u7ed1\u5b9a\u8868-\u4e00\u4e2a\u6309\u94ae---\u591a\u4e2aapi",children:"\u83dc\u5355-API \u7ed1\u5b9a\u8868 (\u4e00\u4e2a\u6309\u94ae -> \u591a\u4e2aAPI)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE `sys_menu_api` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `menu_id` bigint(20) NOT NULL COMMENT '\u5173\u8054sys_menu.id',\n  `api_id` bigint(20) NOT NULL COMMENT '\u5173\u8054sys_api.id',\n  PRIMARY KEY (`id`)\n) COMMENT='\u6743\u9650\u4e0eAPI\u7684\u7ed1\u5b9a\u5173\u7cfb';\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u89d2\u8272-\u83dc\u5355\u7ed1\u5b9a\u8868",children:"\u89d2\u8272-\u83dc\u5355\u7ed1\u5b9a\u8868"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE `sys_role_menu` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `role_id` bigint(20) NOT NULL,\n  `menu_id` bigint(20) NOT NULL,\n  PRIMARY KEY (`id`)\n);\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u7528\u6237\u8868",children:"\u7528\u6237\u8868"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"sys_user"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE `sys_user` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `username` varchar(50) NOT NULL COMMENT '\u8d26\u53f7',\n  `password` varchar(100) NOT NULL COMMENT '\u52a0\u5bc6\u5bc6\u7801',\n  `real_name` varchar(50) DEFAULT NULL COMMENT '\u771f\u5b9e\u59d3\u540d',\n  `status` tinyint(4) DEFAULT '1' COMMENT '\u72b6\u6001 1:\u6b63\u5e38 0:\u7981\u7528',\n  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `uk_username` (`username`)\n) ENGINE=InnoDB COMMENT='\u7528\u6237\u8868';\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u89d2\u8272\u8868\u5f52\u5c5e\u4e8e\u7279\u5b9a\u5e94\u7528",children:"\u89d2\u8272\u8868(\u5f52\u5c5e\u4e8e\u7279\u5b9a\u5e94\u7528)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"sys_role"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE `sys_role` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `app_code` varchar(50) NOT NULL COMMENT '\u5f52\u5c5e\u5e94\u7528\u7f16\u7801',\n  `role_name` varchar(50) NOT NULL COMMENT '\u89d2\u8272\u540d\u79f0',\n  `role_code` varchar(50) NOT NULL COMMENT '\u89d2\u8272\u6807\u8bc6 (\u5982: admin, user)',\n  `status` tinyint(4) DEFAULT '1',\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB COMMENT='\u89d2\u8272\u8868';\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u6743\u9650\u83dc\u5355\u8868-\u83dc\u5355\u6309\u94aeapi\u7ed1\u5b9a",children:"\u6743\u9650/\u83dc\u5355\u8868 (\u83dc\u5355\u3001\u6309\u94ae\u3001API\u7ed1\u5b9a)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE `sys_permission` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `parent_id` bigint(20) DEFAULT '0' COMMENT '\u7236ID',\n  `app_code` varchar(50) NOT NULL COMMENT '\u5f52\u5c5e\u5e94\u7528\u7f16\u7801',\n  `name` varchar(50) NOT NULL COMMENT '\u540d\u79f0 (\u5982: \u7528\u6237\u7ba1\u7406, \u65b0\u589e\u7528\u6237)',\n  `type` tinyint(4) NOT NULL COMMENT '\u7c7b\u578b 1:\u76ee\u5f55 2:\u83dc\u5355 3:\u6309\u94ae/API',\n  `perms` varchar(100) DEFAULT NULL COMMENT '\u6743\u9650\u6807\u8bc6 (\u5982: sys:user:add)',\n  `api_path` varchar(200) DEFAULT NULL COMMENT '\u540e\u7aef\u63a5\u53e3\u8def\u5f84 (\u53ef\u9009\uff0c\u7528\u4e8e\u7f51\u5173\u9274\u6743)',\n  `route_path` varchar(200) DEFAULT NULL COMMENT '\u524d\u7aef\u8def\u7531\u8def\u5f84',\n  `order_num` int(11) DEFAULT '0' COMMENT '\u6392\u5e8f',\n  PRIMARY KEY (`id`)\n) ENGINE=InnoDB COMMENT='\u6743\u9650\u8d44\u6e90\u8868';\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u7528\u6237-\u89d2\u8272\u5173\u8054\u8868",children:"\u7528\u6237-\u89d2\u8272\u5173\u8054\u8868"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE `sys_user_role` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `user_id` bigint(20) NOT NULL,\n  `role_id` bigint(20) NOT NULL,\n  PRIMARY KEY (`id`),\n  UNIQUE KEY `uk_user_role` (`user_id`,`role_id`)\n) ENGINE=InnoDB COMMENT='\u7528\u6237\u89d2\u8272\u5173\u8054\u8868';\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u89d2\u8272-\u6743\u9650\u5173\u8054\u8868",children:"\u89d2\u8272-\u6743\u9650\u5173\u8054\u8868"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE `sys_role_permission` (\n  `id` bigint(20) NOT NULL AUTO_INCREMENT,\n  `role_id` bigint(20) NOT NULL,\n  `permission_id` bigint(20) NOT NULL,\n  PRIMARY KEY (`id`),\n  KEY `idx_role_id` (`role_id`)\n) ENGINE=InnoDB COMMENT='\u89d2\u8272\u6743\u9650\u5173\u8054\u8868';\n"})}),"\n",(0,i.jsx)(n.h2,{id:"java\u4ee3\u7801\u5b9e\u73b0",children:"java\u4ee3\u7801\u5b9e\u73b0"}),"\n",(0,i.jsxs)(n.p,{children:["\u6846\u67b6\u4e3b\u8981\u662f",(0,i.jsx)(n.code,{children:"Spring Boot"})," + ",(0,i.jsx)(n.code,{children:"Sa-Token"})," + ",(0,i.jsx)(n.code,{children:"MyBatis Plus"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",children:"<dependencies>\n    <dependency>\n        <groupId>org.springframework.boot</groupId>\n        <artifactId>spring-boot-starter-web</artifactId>\n    </dependency>\n    <dependency>\n        <groupId>com.baomidou</groupId>\n        <artifactId>mybatis-plus-spring-boot3-starter</artifactId>\n        <version>3.5.5</version>\n    </dependency>\n    <dependency>\n        <groupId>mysql</groupId>\n        <artifactId>mysql-connector-java</artifactId>\n        <version>8.0.33</version>\n    </dependency>\n    <dependency>\n        <groupId>cn.dev33</groupId>\n        <artifactId>sa-token-spring-boot3-starter</artifactId>\n        <version>1.37.0</version>\n    </dependency>\n    <dependency>\n        <groupId>org.projectlombok</groupId>\n        <artifactId>lombok</artifactId>\n    </dependency>\n    <dependency>\n        <groupId>cn.hutool</groupId>\n        <artifactId>hutool-all</artifactId>\n        <version>5.8.25</version>\n    </dependency>\n</dependencies>\n\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u9274\u6743\u6838\u5fc3\u67b6\u6784-\u52a8\u6001-url-\u9274\u6743",children:"\u9274\u6743\u6838\u5fc3\u67b6\u6784 (\u52a8\u6001 URL \u9274\u6743)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Service\n@Slf4j\npublic class AuthStrategyService {\n\n    @Autowired\n    private SysApiMapper apiMapper; // \u5047\u8bbe\u5df2\u6709 Mapper\n\n    // \u7f13\u5b58\uff1aKey="POST:/api/user", Value=["user:add", "user:edit"]\n    private Map<String, Set<String>> urlPermCache = new ConcurrentHashMap<>();\n    private AntPathMatcher pathMatcher = new AntPathMatcher();\n\n    /**\n     * \u521d\u59cb\u5316\uff1a\u4ece\u6570\u636e\u5e93\u52a0\u8f7d "API\u8def\u5f84 -> \u6743\u9650\u6807\u8bc6" \u7684\u6620\u5c04\n     * SQL\u903b\u8f91: \n     * SELECT a.path, a.method, m.perm_code \n     * FROM sys_api a \n     * LEFT JOIN sys_menu_api ma ON a.id = ma.api_id\n     * LEFT JOIN sys_menu m ON ma.menu_id = m.id\n     * WHERE m.perm_code IS NOT NULL\n     */\n    @PostConstruct\n    public void loadUrlPermMap() {\n        List<UrlPermDto> list = apiMapper.selectUrlPermList(); \n        Map<String, Set<String>> temp = new HashMap<>();\n        \n        for (UrlPermDto dto : list) {\n            String key = dto.getMethod() + ":" + dto.getPath();\n            temp.computeIfAbsent(key, k -> new HashSet<>()).add(dto.getPermCode());\n        }\n        this.urlPermCache = temp;\n        log.info("\u6743\u9650\u89c4\u5219\u52a0\u8f7d\u5b8c\u6210\uff0c\u5171 {} \u6761\u63a5\u53e3\u89c4\u5219", temp.size());\n    }\n\n    /**\n     * \u6839\u636e\u8bf7\u6c42\u67e5\u627e\u9700\u8981\u7684\u6743\u9650\n     */\n    public Set<String> getRequiredPerms(String method, String path) {\n        // 1. \u76f4\u63a5\u5339\u914d\n        String key = method + ":" + path;\n        if (urlPermCache.containsKey(key)) {\n            return urlPermCache.get(key);\n        }\n        // 2. Ant \u98ce\u683c\u5339\u914d (\u5982 /api/user/**) - \u904d\u5386\u7f13\u5b58 Key\n        for (String ruleKey : urlPermCache.keySet()) {\n            String[] split = ruleKey.split(":"); // [0]=Method, [1]=Path\n            if (split[0].equalsIgnoreCase(method) || "ALL".equalsIgnoreCase(split[0])) {\n                if (pathMatcher.match(split[1], path)) {\n                    return urlPermCache.get(ruleKey);\n                }\n            }\n        }\n        return null; // \u8fd4\u56de null \u4ee3\u8868\u8be5\u63a5\u53e3\u4e0d\u9700\u8981\u7279\u5b9a\u6743\u9650\uff08\u6216\u672a\u914d\u7f6e\uff09\n    }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u5168\u5c40\u62e6\u622a\u5668",children:"\u5168\u5c40\u62e6\u622a\u5668"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Configuration\npublic class SaTokenConfigure {\n\n    @Autowired\n    private AuthStrategyService authStrategyService;\n\n    @Bean\n    public SaServletFilter getSaServletFilter() {\n        return new SaServletFilter()\n            .addInclude("/**")\n            .addExclude("/favicon.ico", "/auth/login") // \u6392\u9664\u767b\u5f55\u63a5\u53e3\n            .setAuth(obj -> {\n                SaRequest req = SaHolder.getRequest();\n                \n                // 1. \u8de8\u57df\u9884\u68c0\u8bf7\u6c42\u653e\u884c\n                if (req.getMethod().equals("OPTIONS")) return;\n\n                // 2. \u5fc5\u987b\u767b\u5f55\u6821\u9a8c\n                StpUtil.checkLogin();\n\n                // 3. \u52a8\u6001\u6743\u9650\u6821\u9a8c\n                Set<String> neededPerms = authStrategyService.getRequiredPerms(req.getMethod(), req.getRequestPath());\n                \n                if (neededPerms != null && !neededPerms.isEmpty()) {\n                    // \u5982\u679c\u5f53\u524d\u7528\u6237\u62e5\u6709 neededPerms \u4e2d\u7684\u4efb\u610f\u4e00\u4e2a\uff0c\u5219\u901a\u8fc7\n                    boolean hasAuth = false;\n                    for (String perm : neededPerms) {\n                        if (StpUtil.hasPermission(perm)) {\n                            hasAuth = true;\n                            break;\n                        }\n                    }\n                    if (!hasAuth) {\n                        throw new NotPermissionException(neededPerms.toString());\n                    }\n                }\n                // neededPerms \u4e3a null \u65f6\uff0c\u4ec5\u9700\u767b\u5f55\u5373\u53ef\u8bbf\u95ee\n            })\n            .setError(e -> {\n                // \u5f02\u5e38\u5904\u7406\u8f6c\u4ea4\u7ed9 GlobalExceptionHandler \u6216\u8005\u5728\u8fd9\u91cc\u76f4\u63a5\u8fd4\u56de JSON\n                // \u4e3a\u7edf\u4e00\u67b6\u6784\uff0c\u8fd9\u91cc\u53ea\u8d1f\u8d23\u8bbe\u7f6e Response Header\uff0c\u5185\u5bb9\u7531 JSON \u5de5\u5177\u751f\u6210\n                SaHolder.getResponse().setHeader("Content-Type", "application/json;charset=UTF-8");\n                return JSONUtil.toJsonStr(AjaxJson.getError(e.getMessage()));\n            });\n    }\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u6743\u9650\u7ef4\u62a4\u63a5\u53e3",children:"\u6743\u9650\u7ef4\u62a4\u63a5\u53e3"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"@Data\npublic class MenuTreeVO {\n    private Long id;\n    private Long parentId;\n    private String title;      // \u83dc\u5355/\u6309\u94ae\u540d\u79f0\n    private String key;        // \u552f\u4e00\u6807\u8bc6\n    private Boolean isLeaf;    // \u662f\u5426\u53f6\u5b50\u8282\u70b9\n    private Boolean checked;   // \u5f53\u524d\u89d2\u8272\u662f\u5426\u5df2\u62e5\u6709\u8be5\u6743\u9650\n    private List<MenuTreeVO> children;\n}\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"@Data\npublic class RolePermDto {\n    private Long roleId;\n    private List<Long> menuIds; // \u52fe\u9009\u7684\u83dc\u5355/\u6309\u94aeID\u96c6\u5408\n}\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@RestController\n@RequestMapping("/api/sys")\npublic class SysManagerController {\n\n    @Autowired\n    private SysUserService userService;\n    @Autowired\n    private SysRoleService roleService;\n    @Autowired\n    private SysMenuService menuService;\n\n    // ================= \u7528\u6237\u7ba1\u7406 =================\n\n    /**\n     * \u65b0\u589e\u7528\u6237\n     * URL: POST /api/sys/user\n     * \u6743\u9650\u7ed1\u5b9a: \u5728\u6570\u636e\u5e93 sys_menu_api \u7ed1\u5b9a\u7ed9 \'user:add\'\n     */\n    @PostMapping("/user")\n    public AjaxJson addUser(@RequestBody SysUser user) {\n        // \u5bc6\u7801\u52a0\u5bc6\u7b49\u903b\u8f91...\n        user.setPassword(BCrypt.hashpw(user.getPassword()));\n        userService.save(user);\n        return AjaxJson.getSuccess("\u7528\u6237\u521b\u5efa\u6210\u529f");\n    }\n\n    /**\n     * \u5220\u9664\u7528\u6237\n     */\n    @DeleteMapping("/user/{id}")\n    public AjaxJson deleteUser(@PathVariable Long id) {\n        userService.removeById(id);\n        return AjaxJson.getSuccess("\u5220\u9664\u6210\u529f");\n    }\n\n    // ================= \u89d2\u8272\u7ba1\u7406 =================\n\n    /**\n     * \u65b0\u589e\u89d2\u8272\n     */\n    @PostMapping("/role")\n    public AjaxJson addRole(@RequestBody SysRole role) {\n        roleService.save(role);\n        return AjaxJson.getSuccess(role);\n    }\n\n    /**\n     * \u5220\u9664\u89d2\u8272\n     * \u903b\u8f91: \u5220\u9664\u89d2\u8272\u7684\u540c\u65f6\uff0c\u9700\u8981\u5220\u9664 sys_role_menu, sys_user_role \u4e2d\u7684\u5173\u8054\u6570\u636e\n     */\n    @DeleteMapping("/role/{id}")\n    public AjaxJson deleteRole(@PathVariable Long id) {\n        roleService.deleteRoleDeeply(id);\n        return AjaxJson.getSuccess("\u89d2\u8272\u5220\u9664\u6210\u529f");\n    }\n\n    // ================= \u6743\u9650\u6838\u5fc3\u63a5\u53e3 =================\n\n    /**\n     * [\u6838\u5fc3] \u83b7\u53d6\u89d2\u8272\u6743\u9650\u6811\n     * \u524d\u7aef\u6253\u5f00\u201c\u5206\u914d\u6743\u9650\u201d\u5f39\u7a97\u65f6\u8c03\u7528\n     * @param roleId \u5f53\u524d\u6b63\u5728\u7f16\u8f91\u7684\u89d2\u8272ID (\u82e5\u662f\u65b0\u589e\u89d2\u8272\u5219\u4f20 0 \u6216 null)\n     */\n    @GetMapping("/role/permission_tree")\n    public AjaxJson getRolePermissionTree(@RequestParam(required = false) Long roleId) {\n        List<MenuTreeVO> tree = menuService.buildMenuTreeForRole(roleId);\n        return AjaxJson.getSuccess(tree);\n    }\n\n    /**\n     * [\u6838\u5fc3] \u4fdd\u5b58\u89d2\u8272-\u6743\u9650\u5173\u8054\n     */\n    @PostMapping("/role/permissions")\n    public AjaxJson updateRolePermissions(@RequestBody RolePermDto dto) {\n        roleService.updateRoleMenus(dto.getRoleId(), dto.getMenuIds());\n        \n        // \u91cd\u8981\uff1a\u66f4\u65b0\u540e\uff0c\u53ef\u80fd\u9700\u8981\u6e05\u9664\u8be5\u89d2\u8272\u4e0b\u6240\u6709\u7528\u6237\u7684\u6743\u9650\u7f13\u5b58\uff0c\u8ba9\u5176\u91cd\u65b0\u52a0\u8f7d\n        // StpUtil.getSession().delete("Permission_Cache"); \u89c6\u7f13\u5b58\u7b56\u7565\u800c\u5b9a\n        return AjaxJson.getSuccess("\u6743\u9650\u5206\u914d\u6210\u529f");\n    }\n}\n\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u767b\u5165\u767b\u51fa\u63a5\u53e3\u5b9e\u73b0",children:"\u767b\u5165\u767b\u51fa\u63a5\u53e3\u5b9e\u73b0"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'\n@RestController\n@RequestMapping("/auth")\npublic class AuthController {\n\n    @Autowired\n    private SysUserService userService;\n\n    @PostMapping("/login")\n    public SaResult login(@RequestBody LoginDto loginDto) {\n        // 1. \u6821\u9a8c\u8d26\u53f7\u5bc6\u7801 (\u4f2a\u4ee3\u7801)\n        SysUser user = userService.getByUsername(loginDto.getUsername());\n        if(user == null || !checkPwd(loginDto.getPassword(), user.getPassword())) {\n            return SaResult.error("\u8d26\u53f7\u6216\u5bc6\u7801\u9519\u8bef");\n        }\n\n        // 2. \u767b\u5f55 (Sa-Token \u4f1a\u81ea\u52a8\u751f\u6210 Token \u5e76\u6ce8\u5165 Cookie/Header)\n        StpUtil.login(user.getId());\n        \n        // 3. \u8fd4\u56de Token \u4fe1\u606f\u7ed9\u524d\u7aef\n        SaTokenInfo tokenInfo = StpUtil.getTokenInfo();\n        return SaResult.data(tokenInfo);\n    }\n    \n    @RequestMapping("/logout")\n    public SaResult logout() {\n        StpUtil.logout();\n        return SaResult.ok();\n    }\n}\n\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Service\npublic class SysMenuService extends ServiceImpl<SysMenuMapper, SysMenu> {\n    \n    @Autowired\n    private SysRoleMenuMapper roleMenuMapper;\n\n    /**\n     * \u6784\u5efa\u5305\u542b "checked" \u72b6\u6001\u7684\u6743\u9650\u6811\n     */\n    public List<MenuTreeVO> buildMenuTreeForRole(Long roleId) {\n        // 1. \u67e5\u8be2\u6240\u6709\u6709\u6548\u83dc\u5355/\u6309\u94ae\n        List<SysMenu> allMenus = this.list(new LambdaQueryWrapper<SysMenu>().orderByAsc(SysMenu::getOrderNum));\n        \n        // 2. \u5982\u679c roleId \u5b58\u5728\uff0c\u67e5\u8be2\u8be5\u89d2\u8272\u5df2\u62e5\u6709\u7684 menu_id \u96c6\u5408\n        Set<Long> ownedMenuIds = new HashSet<>();\n        if (roleId != null) {\n            List<SysRoleMenu> rms = roleMenuMapper.selectList(new LambdaQueryWrapper<SysRoleMenu>().eq(SysRoleMenu::getRoleId, roleId));\n            rms.forEach(rm -> ownedMenuIds.add(rm.getMenuId()));\n        }\n\n        // 3. \u8f6c\u6362 VO \u5e76\u6807\u8bb0 checked\n        List<MenuTreeVO> allNodes = allMenus.stream().map(m -> {\n            MenuTreeVO vo = new MenuTreeVO();\n            vo.setId(m.getId());\n            vo.setParentId(m.getParentId());\n            vo.setTitle(m.getName());\n            vo.setKey(m.getId().toString());\n            // \u5982\u679c\u96c6\u5408\u5305\u542b\uff0c\u524d\u7aef\u590d\u9009\u6846\u6253\u52fe\n            vo.setChecked(ownedMenuIds.contains(m.getId())); \n            return vo;\n        }).collect(Collectors.toList());\n\n        // 4. list \u8f6c tree (\u4f7f\u7528 Hutool TreeUtil \u6216\u624b\u5199\u9012\u5f52)\n        return buildTreeStructure(allNodes);\n    }\n\n    // \u7b80\u5355\u7684\u9012\u5f52\u6784\u5efa\u6811\n    private List<MenuTreeVO> buildTreeStructure(List<MenuTreeVO> nodes) {\n        List<MenuTreeVO> tree = new ArrayList<>();\n        for (MenuTreeVO node : nodes) {\n            if (node.getParentId() == 0) { // \u6839\u8282\u70b9\n                node.setChildren(getChildren(node.getId(), nodes));\n                tree.add(node);\n            }\n        }\n        return tree;\n    }\n\n    private List<MenuTreeVO> getChildren(Long pid, List<MenuTreeVO> nodes) {\n        List<MenuTreeVO> children = new ArrayList<>();\n        for (MenuTreeVO node : nodes) {\n            if (node.getParentId().equals(pid)) {\n                node.setChildren(getChildren(node.getId(), nodes));\n                children.add(node);\n            }\n        }\n        return children;\n    }\n}\n'})})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},28453(e,n,r){r.d(n,{R:()=>a,x:()=>d});var t=r(96540);const i={},s=t.createContext(i);function a(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);