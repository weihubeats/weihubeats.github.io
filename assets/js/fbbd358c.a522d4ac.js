"use strict";(globalThis.webpackChunkweihubeats_website=globalThis.webpackChunkweihubeats_website||[]).push([[2442],{13858(e,a,n){n.r(a),n.d(a,{assets:()=>c,contentTitle:()=>s,default:()=>d,frontMatter:()=>i,metadata:()=>r,toc:()=>p});const r=JSON.parse('{"id":"java/\u5206\u5e03\u5f0f\u4e8b\u52a1/\u57fa\u4e8eNarayana\u5b9e\u73b0\u5206\u5e03\u5f0f\u4e8b\u52a1-XA","title":"\u57fa\u4e8eNarayana\u5b9e\u73b0\u5206\u5e03\u5f0f\u4e8b\u52a1-XA","description":"Narayana \u662f\u4ec0\u4e48","source":"@site/docs/java/\u5206\u5e03\u5f0f\u4e8b\u52a1/\u57fa\u4e8eNarayana\u5b9e\u73b0\u5206\u5e03\u5f0f\u4e8b\u52a1-XA.md","sourceDirName":"java/\u5206\u5e03\u5f0f\u4e8b\u52a1","slug":"/java/\u5206\u5e03\u5f0f\u4e8b\u52a1/\u57fa\u4e8eNarayana\u5b9e\u73b0\u5206\u5e03\u5f0f\u4e8b\u52a1-XA","permalink":"/docs/java/\u5206\u5e03\u5f0f\u4e8b\u52a1/\u57fa\u4e8eNarayana\u5b9e\u73b0\u5206\u5e03\u5f0f\u4e8b\u52a1-XA","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/java/\u5206\u5e03\u5f0f\u4e8b\u52a1/\u57fa\u4e8eNarayana\u5b9e\u73b0\u5206\u5e03\u5f0f\u4e8b\u52a1-XA.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"\u4e0a\u7ebf\u6a21\u677f","permalink":"/docs/java/\u4ee3\u7801\u89c4\u8303/\u4e0a\u7ebf\u6a21\u677f"},"next":{"title":"\u672c\u5730\u6d88\u606f\u8868\u5b9e\u73b0\u6700\u7ec8\u4e00\u81f4\u6027","permalink":"/docs/java/\u5206\u5e03\u5f0f\u4e8b\u52a1/\u672c\u5730\u6d88\u606f\u8868\u5b9e\u73b0\u6700\u7ec8\u4e00\u81f4\u6027"}}');var t=n(74848),o=n(28453);const i={},s=void 0,c={},p=[{value:"Narayana \u662f\u4ec0\u4e48",id:"narayana-\u662f\u4ec0\u4e48",level:2},{value:"\u4f7f\u7528",id:"\u4f7f\u7528",level:2},{value:"\u6570\u636e\u521d\u59cb\u5316",id:"\u6570\u636e\u521d\u59cb\u5316",level:2},{value:"\u6838\u5fc3\u539f\u7406",id:"\u6838\u5fc3\u539f\u7406",level:2}];function l(e){const a={code:"code",h2:"h2",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(a.h2,{id:"narayana-\u662f\u4ec0\u4e48",children:"Narayana \u662f\u4ec0\u4e48"}),"\n",(0,t.jsx)(a.p,{children:"Narayana \u662f\u4e00\u4e2a\u8001\u724c\u4e14\u8457\u540d\u7684\u5206\u5e03\u5f0f\u4e8b\u52a1\u7ba1\u7406\u5668\uff08JTA Transaction Manager\uff09\uff0c\u4e3b\u8981\u7531 Red Hat\uff08\u7ea2\u5e3d\uff09\u548c JBoss \u793e\u533a\u7ef4\u62a4"}),"\n",(0,t.jsxs)(a.ul,{children:["\n",(0,t.jsxs)(a.li,{children:["\n",(0,t.jsx)(a.p,{children:"\u4f5c\u7528\uff1a\u786e\u4fdd\u5728\u590d\u6742\u7684\u8f6f\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u6d89\u53ca\u591a\u4e2a\u6570\u636e\u5e93\uff08\u5982 MySQL + Oracle\uff09\u6216\u6d88\u606f\u961f\u5217\uff08\u5982 Kafka/JMS\uff09\u7684\u64cd\u4f5c\u80fd\u4fdd\u6301\u6570\u636e\u4e00\u81f4\u6027"}),"\n"]}),"\n",(0,t.jsxs)(a.li,{children:["\n",(0,t.jsx)(a.p,{children:"\u6838\u5fc3\u529f\u80fd:\u5b83\u652f\u6301 JTA\uff08Java Transaction API\uff09\u3001JTS\u3001Web Service \u4e8b\u52a1\u7b49\u6807\u51c6"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(a.h2,{id:"\u4f7f\u7528",children:"\u4f7f\u7528"}),"\n",(0,t.jsxs)(a.ol,{children:["\n",(0,t.jsx)(a.li,{children:"\u5f15\u5165\u4f9d\u8d56"}),"\n"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-xml",children:"<dependencies>\n    <dependency>\n        <groupId>org.springframework.boot</groupId>\n        <artifactId>spring-boot-starter-web</artifactId>\n    </dependency>\n\n    <dependency>\n        <groupId>me.snowdrop</groupId>\n        <artifactId>narayana-spring-boot-starter</artifactId>\n        <version>2.6.5</version>\n    </dependency>\n\n    <dependency>\n        <groupId>com.baomidou</groupId>\n        <artifactId>mybatis-plus-boot-starter</artifactId>\n        <version>3.5.3.1</version>\n    </dependency>\n\n    <dependency>\n        <groupId>com.h2database</groupId>\n        <artifactId>h2</artifactId>\n        <scope>runtime</scope>\n    </dependency>\n    \n    <dependency>\n        <groupId>org.projectlombok</groupId>\n        <artifactId>lombok</artifactId>\n    </dependency>\n</dependencies>\n"})}),"\n",(0,t.jsxs)(a.ol,{start:"2",children:["\n",(0,t.jsx)(a.li,{children:"\u9879\u76ee\u7ed3\u6784"}),"\n"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{children:"src/main/java/com/example\n\u251c\u2500\u2500 config\n\u2502   \u251c\u2500\u2500 UserDbConfig.java   (\u914d\u7f6e DB_A)\n\u2502   \u2514\u2500\u2500 OrderDbConfig.java  (\u914d\u7f6e DB_B)\n\u251c\u2500\u2500 entity\n\u2502   \u251c\u2500\u2500 User.java\n\u2502   \u2514\u2500\u2500 Order.java\n\u251c\u2500\u2500 mapper\n\u2502   \u251c\u2500\u2500 user                (\u5b58\u653e UserMapper)\n\u2502   \u2502   \u2514\u2500\u2500 UserMapper.java\n\u2502   \u2514\u2500\u2500 order               (\u5b58\u653e OrderMapper)\n\u2502       \u2514\u2500\u2500 OrderMapper.java\n\u2514\u2500\u2500 service...\n"})}),"\n",(0,t.jsxs)(a.ol,{start:"2",children:["\n",(0,t.jsx)(a.li,{children:"\u5b9e\u4f53\u7c7b\u5b9a\u4e49"}),"\n"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-java",children:'// User.java\n@Data\n@TableName("account")\npublic class User {\n    private String username;\n    private Integer balance;\n}\n\n// Order.java\n@Data\n@TableName("orders")\npublic class Order {\n    private String id;\n    private Integer amount;\n}\n\n'})}),"\n",(0,t.jsxs)(a.ol,{start:"4",children:["\n",(0,t.jsx)(a.li,{children:"mapper\u5b9a\u4e49"}),"\n"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-java",children:"// package com.example.mapper.user;\npublic interface UserMapper extends BaseMapper<User> {}\n\n// package com.example.mapper.order;\npublic interface OrderMapper extends BaseMapper<Order> {}\n\n"})}),"\n",(0,t.jsxs)(a.ol,{start:"5",children:["\n",(0,t.jsx)(a.li,{children:"\u591a\u6570\u636e\u6e90\u914d\u7f6e"}),"\n"]}),"\n",(0,t.jsxs)(a.ul,{children:["\n",(0,t.jsx)(a.li,{children:"user\u5e93"}),"\n"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-java",children:'package com.example.config;\n\nimport com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean;\nimport org.apache.ibatis.session.SqlSessionFactory;\nimport org.h2.jdbcx.JdbcDataSource;\nimport org.mybatis.spring.annotation.MapperScan;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.context.annotation.Primary;\nimport javax.sql.DataSource;\n\n@Configuration\n@MapperScan(basePackages = "com.example.mapper.user", sqlSessionFactoryRef = "userSqlSessionFactory")\npublic class UserDbConfig {\n\n    // 1. \u521b\u5efa XA \u6570\u636e\u6e90\n    @Bean\n    @Primary\n    public DataSource userDataSource() {\n        JdbcDataSource h2XaDataSource = new JdbcDataSource();\n        h2XaDataSource.setUrl("jdbc:h2:mem:userDb;DB_CLOSE_DELAY=-1");\n        h2XaDataSource.setUser("sa");\n        h2XaDataSource.setPassword("");\n        return h2XaDataSource;\n    }\n\n    // 2. \u521b\u5efa MyBatis Plus \u7684 SqlSessionFactory\n    // \u6ce8\u610f\uff1a\u8fd9\u91cc\u4f7f\u7528\u7684\u662f MybatisSqlSessionFactoryBean\uff0c\u4e0d\u662f\u539f\u751f\u7684 SqlSessionFactoryBean\n    @Bean\n    @Primary\n    public SqlSessionFactory userSqlSessionFactory(DataSource userDataSource) throws Exception {\n        MybatisSqlSessionFactoryBean bean = new MybatisSqlSessionFactoryBean();\n        bean.setDataSource(userDataSource);\n        // \u5982\u679c\u6709 xml \u6587\u4ef6\uff0c\u8fd9\u91cc\u8bbe\u7f6e\uff1abean.setMapperLocations(...)\n        return bean.getObject();\n    }\n}\n'})}),"\n",(0,t.jsxs)(a.ul,{children:["\n",(0,t.jsx)(a.li,{children:"\u8ba2\u5355\u5e93"}),"\n"]}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-java",children:'package com.example.config;\n\nimport com.baomidou.mybatisplus.extension.spring.MybatisSqlSessionFactoryBean;\nimport org.apache.ibatis.session.SqlSessionFactory;\nimport org.h2.jdbcx.JdbcDataSource;\nimport org.mybatis.spring.annotation.MapperScan;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport javax.sql.DataSource;\n\n@Configuration\n// \u3010\u5173\u952e\u3011\uff1a\u626b\u63cf com.example.mapper.order \u4e0b\u7684\u63a5\u53e3\uff0c\u5e76\u7ed1\u5b9a\u5230 orderSqlSessionFactory\n@MapperScan(basePackages = "com.example.mapper.order", sqlSessionFactoryRef = "orderSqlSessionFactory")\npublic class OrderDbConfig {\n\n    @Bean\n    public DataSource orderDataSource() {\n        JdbcDataSource h2XaDataSource = new JdbcDataSource();\n        h2XaDataSource.setUrl("jdbc:h2:mem:orderDb;DB_CLOSE_DELAY=-1");\n        h2XaDataSource.setUser("sa");\n        h2XaDataSource.setPassword("");\n        return h2XaDataSource;\n    }\n\n    @Bean\n    public SqlSessionFactory orderSqlSessionFactory(DataSource orderDataSource) throws Exception {\n        MybatisSqlSessionFactoryBean bean = new MybatisSqlSessionFactoryBean();\n        bean.setDataSource(orderDataSource);\n        return bean.getObject();\n    }\n}\n'})}),"\n",(0,t.jsxs)(a.ol,{start:"6",children:["\n",(0,t.jsx)(a.li,{children:"\u4e1a\u52a1\u5c42 (Service)"}),"\n"]}),"\n",(0,t.jsx)(a.p,{children:"\u73b0\u5728\u4f60\u53ef\u4ee5\u50cf\u5e73\u65f6\u4e00\u6837\u6ce8\u5165 Mapper\uff0cNarayana \u4f1a\u81ea\u52a8\u5904\u7406\u8de8\u5e93\u4e8b\u52a1\u3002"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-java",children:'@Service\npublic class OrderService {\n\n    @Autowired\n    private UserMapper userMapper;   // \u81ea\u52a8\u6307\u5411 DB_A\n    @Autowired\n    private OrderMapper orderMapper; // \u81ea\u52a8\u6307\u5411 DB_B\n\n    // \u521d\u59cb\u5316\u8868 (H2\u5185\u5b58\u5e93\u9700\u8981)\n    @Transactional\n    public void init() {\n        // \u4f7f\u7528 MyBatis Plus \u6ca1\u4ec0\u4e48\u597d\u529e\u6cd5\u76f4\u63a5\u5efa\u8868\uff0c\u8fd9\u91cc\u4e34\u65f6\u7528\u539f\u751f SQL \u6a21\u62df\u4e00\u4e0b\u521d\u59cb\u5316\n        // \u5b9e\u9645\u751f\u4ea7\u4e2d\u8868\u662f\u5b58\u5728\u7684\uff0c\u4e0d\u9700\u8981\u8fd9\u6b65\n        // (\u4e3a\u4e86\u6f14\u793a\u7b80\u6d01\uff0c\u8fd9\u91cc\u7565\u53bb\u5efa\u8868\u4ee3\u7801\uff0c\u5047\u8bbe\u8868\u5df2\u901a\u8fc7 application.yml \u6216 schema.sql \u5efa\u7acb)\n        // \u4f60\u53ef\u4ee5\u5728\u914d\u7f6e DataSource \u65f6\u6307\u5b9a init-script\n    }\n\n    @Transactional(rollbackFor = Exception.class)\n    public void placeOrder(boolean simulateError) {\n        System.out.println(">>> \u4e8b\u52a1\u5f00\u59cb (MyBatis Plus) <<<");\n\n        // 1. \u6263\u51cf\u4f59\u989d (DB_A)\n        // \u8fd9\u91cc\u6f14\u793a MP \u7684 Wrapper \u7528\u6cd5\n        UpdateWrapper<User> updateWrapper = new UpdateWrapper<>();\n        updateWrapper.setSql("balance = balance - 10").eq("username", "zhangsan");\n        userMapper.update(null, updateWrapper);\n        System.out.println(">>> \u4f59\u989d\u5df2\u6263\u51cf <<<");\n\n        // 2. \u63d2\u5165\u8ba2\u5355 (DB_B)\n        Order order = new Order();\n        order.setId("ORDER_MP_001");\n        order.setAmount(10);\n        orderMapper.insert(order);\n        System.out.println(">>> \u8ba2\u5355\u5df2\u63d2\u5165 <<<");\n\n        // 3. \u6a21\u62df\u5f02\u5e38\n        if (simulateError) {\n            throw new RuntimeException("MyBatis Plus \u9047\u5230\u5f02\u5e38\uff0c\u5168\u90e8\u56de\u6eda\uff01");\n        }\n    }\n}\n'})}),"\n",(0,t.jsx)(a.h2,{id:"\u6570\u636e\u521d\u59cb\u5316",children:"\u6570\u636e\u521d\u59cb\u5316"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-java",children:'// \u5728 UserDbConfig \u4e2d\u6dfb\u52a0\n@Bean\npublic DataSourceInitializer userDbInit(DataSource userDataSource) {\n    ResourceDatabasePopulator populator = new ResourceDatabasePopulator();\n    populator.addScript(new ByteArrayResource("CREATE TABLE IF NOT EXISTS account (username VARCHAR(50), balance INT); INSERT INTO account VALUES (\'zhangsan\', 100);".getBytes()));\n    DataSourceInitializer initializer = new DataSourceInitializer();\n    initializer.setDataSource(userDataSource);\n    initializer.setDatabasePopulator(populator);\n    return initializer;\n}\n\n// \u5728 OrderDbConfig \u4e2d\u6dfb\u52a0\n@Bean\npublic DataSourceInitializer orderDbInit(DataSource orderDataSource) {\n    ResourceDatabasePopulator populator = new ResourceDatabasePopulator();\n    populator.addScript(new ByteArrayResource("CREATE TABLE IF NOT EXISTS orders (id VARCHAR(50), amount INT);".getBytes()));\n    DataSourceInitializer initializer = new DataSourceInitializer();\n    initializer.setDataSource(orderDataSource);\n    initializer.setDatabasePopulator(populator);\n    return initializer;\n}\n'})}),"\n",(0,t.jsx)(a.h2,{id:"\u6838\u5fc3\u539f\u7406",children:"\u6838\u5fc3\u539f\u7406"}),"\n",(0,t.jsx)(a.mermaid,{value:'sequenceDiagram\n    autonumber\n    participant Caller as \u8c03\u7528\u8005\n    participant Proxy as Spring AOP\u4ee3\u7406\n    participant TM as Narayana (JTA Manager)\n    participant Thread as \u5f53\u524d\u7ebf\u7a0b (ThreadLocal)\n    participant Service as \u4f60\u7684\u4e1a\u52a1\u4ee3\u7801\n    participant MyBatis as MyBatis/JDBC\n    participant XA_DS as XA\u6570\u636e\u6e90 (UserDB)\n\n    Note over Caller, XA_DS: === \u9636\u6bb5\u4e00\uff1a\u5f00\u542f\u4e8b\u52a1 ===\n    Caller->>Proxy: \u8c03\u7528 placeOrder()\n    Proxy->>TM: \u5f00\u542f\u4e8b\u52a1 (getTransaction)\n    TM->>TM: \u751f\u6210\u5168\u5c40\u4e8b\u52a1ID (XID: 1001)\n    TM->>Thread: \u5c06 XID:1001 \u7ed1\u5b9a\u5230 ThreadLocal\n    \n    Note over Caller, XA_DS: === \u9636\u6bb5\u4e8c\uff1a\u4e1a\u52a1\u6267\u884c & \u6084\u6084\u6ce8\u518c ===\n    Proxy->>Service: \u6267\u884c target.placeOrder()\n    Service->>MyBatis: userMapper.update()\n    MyBatis->>XA_DS: \u8bf7\u6c42getConnection()\n    \n    rect rgb(255, 240, 240)\n        Note right of XA_DS: \u3010\u9b54\u6cd5\u53d1\u751f\u5730\u3011\n        XA_DS->>Thread: \u68c0\u67e5\u5f53\u524d\u6709\u65e0\u4e8b\u52a1? -> \u6709 (XID:1001)\n        XA_DS->>TM: "\u6211\u662fUserDB\uff0c\u8bf7\u6c42\u52a0\u5165 XID:1001" (Enlist)\n        TM->>TM: \u5c06 UserDB \u52a0\u5165\u8d44\u6e90\u5217\u8868\n    end\n    \n    XA_DS--\x3e>MyBatis: \u8fd4\u56de\u53d7\u63a7\u7684 Connection\n    MyBatis->>XA_DS: \u6267\u884c SQL (\u6b64\u65f6\u4e0d\u4f1a\u63d0\u4ea4)\n    \n    Note over Caller, XA_DS: === \u9636\u6bb5\u4e09\uff1a\u63d0\u4ea4 ===\n    Service--\x3e>Proxy: \u65b9\u6cd5\u8fd4\u56de\n    Proxy->>TM: \u63d0\u4ea4\u4e8b\u52a1 (commit)\n    TM->>XA_DS: \u5bf9\u5217\u8868\u4e2d\u7684\u8d44\u6e90\u6267\u884c 2PC (Prepare/Commit)'})]})}function d(e={}){const{wrapper:a}={...(0,o.R)(),...e.components};return a?(0,t.jsx)(a,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},28453(e,a,n){n.d(a,{R:()=>i,x:()=>s});var r=n(96540);const t={},o=r.createContext(t);function i(e){const a=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(a):{...a,...e}},[a,e])}function s(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),r.createElement(o.Provider,{value:a},e.children)}}}]);