"use strict";(self.webpackChunkweihubeats_website=self.webpackChunkweihubeats_website||[]).push([[8092],{861:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/ScheduleMessageService-executeOnTimeup-code-73919cc5e6f27f48bde08b3e205972f5.png"},1722:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/DeliverDelayedMessageTimerTask-executeOnTimeup-43481ceb099c68fddbbbd14587270853.png"},1863:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/SendMessageProcessor-processRequest-5e8e6f34b5d76a88c9ae870885faa580.png"},2038:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/deleay-msgExt-debug-882bc50e805a7f9b4e2cd1619fd6feb7.png"},2044:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>a,contentTitle:()=>i,default:()=>g,frontMatter:()=>l,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"MQ/RocketMQ/\u6e90\u7801\u5206\u6790/RocketMQ 5.x\u56fa\u5b9a\u7b49\u7ea7\u5ef6\u65f6\u6d88\u606f\u6e90\u7801\u5206\u6790","title":"RocketMQ 5.x\u56fa\u5b9a\u7b49\u7ea7\u5ef6\u65f6\u6d88\u606f\u6e90\u7801\u5206\u6790","description":"\u8fd9\u91cc\u662f\u5c0f\u594f,\u89c9\u5f97\u6587\u7ae0\u4e0d\u9519\u53ef\u4ee5\u5173\u6ce8\u516c\u4f17\u53f7\u5c0f\u594f\u6280\u672f\uff0c\u6587\u7ae0\u9996\u53d1\u3002\u62d2\u7edd\u8425\u9500\u53f7\uff0c\u62d2\u7edd\u6807\u9898\u515a","source":"@site/docs/MQ/RocketMQ/\u6e90\u7801\u5206\u6790/RocketMQ 5.x\u56fa\u5b9a\u7b49\u7ea7\u5ef6\u65f6\u6d88\u606f\u6e90\u7801\u5206\u6790.md","sourceDirName":"MQ/RocketMQ/\u6e90\u7801\u5206\u6790","slug":"/MQ/RocketMQ/\u6e90\u7801\u5206\u6790/RocketMQ 5.x\u56fa\u5b9a\u7b49\u7ea7\u5ef6\u65f6\u6d88\u606f\u6e90\u7801\u5206\u6790","permalink":"/docs/MQ/RocketMQ/\u6e90\u7801\u5206\u6790/RocketMQ 5.x\u56fa\u5b9a\u7b49\u7ea7\u5ef6\u65f6\u6d88\u606f\u6e90\u7801\u5206\u6790","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/MQ/RocketMQ/\u6e90\u7801\u5206\u6790/RocketMQ 5.x\u56fa\u5b9a\u7b49\u7ea7\u5ef6\u65f6\u6d88\u606f\u6e90\u7801\u5206\u6790.md","tags":[],"version":"current","frontMatter":{},"sidebar":"RocketMQ","previous":{"title":"RocketMQ 5.x\u4efb\u610f\u5ef6\u65f6\u6d88\u606f\u6e90\u7801\u5206\u6790","permalink":"/docs/MQ/RocketMQ/\u6e90\u7801\u5206\u6790/RocketMQ 5.x\u4efb\u610f\u5ef6\u65f6\u6d88\u606f\u6e90\u7801\u5206\u6790"},"next":{"title":"RocketMQ 5.x\u5fc3\u8df3\u673a\u5236\u4f18\u5316","permalink":"/docs/MQ/RocketMQ/\u6e90\u7801\u5206\u6790/RocketMQ 5.x\u5fc3\u8df3\u673a\u5236\u4f18\u5316"}}');var r=n(4848),c=n(8453);const l={},i=void 0,a={},o=[{value:"RocketMQ\u7248\u672c",id:"rocketmq\u7248\u672c",level:2},{value:"\u80cc\u666f",id:"\u80cc\u666f",level:2},{value:"\u5ef6\u65f6\u6d88\u606f\u57fa\u7840\u77e5\u8bc6",id:"\u5ef6\u65f6\u6d88\u606f\u57fa\u7840\u77e5\u8bc6",level:2},{value:"\u5ef6\u65f6\u6d88\u606f\u7684\u7b80\u5355\u4f7f\u7528",id:"\u5ef6\u65f6\u6d88\u606f\u7684\u7b80\u5355\u4f7f\u7528",level:3},{value:"\u6e90\u7801\u5206\u6790",id:"\u6e90\u7801\u5206\u6790",level:2},{value:"\u6e90\u7801\u5165\u53e3",id:"\u6e90\u7801\u5165\u53e3",level:3},{value:"broker\u5904\u7406\u8bf7\u6c42",id:"broker\u5904\u7406\u8bf7\u6c42",level:3},{value:"handleScheduleMessage",id:"handleschedulemessage",level:3},{value:"\u5ef6\u65f6\u6d88\u606f\u6d88\u8d39",id:"\u5ef6\u65f6\u6d88\u606f\u6d88\u8d39",level:3},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}];function d(e){const s={blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,c.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(s.blockquote,{children:["\n",(0,r.jsxs)(s.p,{children:["\u8fd9\u91cc\u662f",(0,r.jsx)(s.strong,{children:"\u5c0f\u594f"}),",\u89c9\u5f97\u6587\u7ae0\u4e0d\u9519\u53ef\u4ee5\u5173\u6ce8\u516c\u4f17\u53f7",(0,r.jsx)(s.strong,{children:"\u5c0f\u594f\u6280\u672f"}),"\uff0c\u6587\u7ae0\u9996\u53d1\u3002\u62d2\u7edd\u8425\u9500\u53f7\uff0c\u62d2\u7edd\u6807\u9898\u515a"]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"rocketmq\u7248\u672c",children:"RocketMQ\u7248\u672c"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"5.1.0"}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"\u80cc\u666f",children:"\u80cc\u666f"}),"\n",(0,r.jsxs)(s.p,{children:["\u9996\u5148\u8bf4\u660e\u672c\u6b21\u6e90\u7801\u5206\u6790\u4ec5\u5206\u6790",(0,r.jsx)(s.strong,{children:"\u65f6\u95f4\u8f6e"}),"\u4e4b\u524d\u7684\u5ef6\u65f6\u6d88\u606f\u8bbe\u8ba1"]}),"\n",(0,r.jsxs)(s.blockquote,{children:["\n",(0,r.jsxs)(s.p,{children:["\u73b0\u5728\u7684",(0,r.jsx)(s.code,{children:"RocketMQ"}),"\u5df2\u7ecf\u652f\u6301\u57fa\u4e8e",(0,r.jsx)(s.strong,{children:"\u65f6\u95f4\u8f6e"}),"\u7684\u4efb\u610f\u7ea7\u522b\u5ef6\u65f6\u6d88\u606f"]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"\u5ef6\u65f6\u6d88\u606f\u57fa\u7840\u77e5\u8bc6",children:"\u5ef6\u65f6\u6d88\u606f\u57fa\u7840\u77e5\u8bc6"}),"\n",(0,r.jsxs)(s.p,{children:["\u9ed8\u8ba4",(0,r.jsx)(s.code,{children:"RocketMQ"}),"\u5ef6\u65f6\u6d88\u606f\u5171\u670918\u4e2a\u7b49\u7ea7"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"alt text",src:n(4383).A+"",width:"2263",height:"675"})}),"\n",(0,r.jsxs)(s.blockquote,{children:["\n",(0,r.jsx)(s.p,{children:"1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h"}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"\u5ef6\u65f6\u6d88\u606f\u7684\u7b80\u5355\u4f7f\u7528",children:"\u5ef6\u65f6\u6d88\u606f\u7684\u7b80\u5355\u4f7f\u7528"}),"\n",(0,r.jsx)(s.p,{children:"\u53d1\u9001\u5ef6\u65f6\u6d88\u606f"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-java",children:'        DefaultMQProducer producer = new DefaultMQProducer(producerGroup);\n        producer.setNamesrvAddr(namesrvAddr);\n        try {\n            producer.start();\n        } catch (MQClientException e) {\n            throw new RuntimeException(e);\n        }\n\n        Message msg = new Message(TOPIC /* Topic */,\n                TAG /* Tag */,\n                ("Hello RocketMQ " + i).getBytes(RemotingHelper.DEFAULT_CHARSET) /* Message body */\n        );\n\n        msg.setDelayTimeLevel(2);\n        producer.send(msg);\n\n'})}),"\n",(0,r.jsx)(s.p,{children:"\u548c\u666e\u901a\u6d88\u606f\u4e0d\u540c\u7684\u6211\u4eec\u65b0\u589e\u4e86\u5ef6\u65f6\u6d88\u606f\u7b49\u7ea7\u7684\u8bbe\u7f6e"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-java",children:"        msg.setDelayTimeLevel(2);\n\n"})}),"\n",(0,r.jsx)(s.h2,{id:"\u6e90\u7801\u5206\u6790",children:"\u6e90\u7801\u5206\u6790"}),"\n",(0,r.jsxs)(s.p,{children:["\u6d88\u606f\u53d1\u9001\u672c\u8eab\u548c\u666e\u901a\u6d88\u606f\u53d1\u9001\u6ca1\u6709\u592a\u5927\u5dee\u522b\uff0c\u4f46\u662f\u65b0\u589e\u4e86\u4e00\u4e2a",(0,r.jsx)(s.code,{children:"DELAY"}),"\u5c5e\u6027"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-java",children:'public static final String PROPERTY_DELAY_TIME_LEVEL = "DELAY";\n'})}),"\n",(0,r.jsx)(s.p,{children:"\u6d88\u606f\u53d1\u9001\u7684\u8bf7\u6c42code\u662f"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-java",children:"public static final int SEND_BATCH_MESSAGE = 320;\n"})}),"\n",(0,r.jsx)(s.h3,{id:"\u6e90\u7801\u5165\u53e3",children:"\u6e90\u7801\u5165\u53e3"}),"\n",(0,r.jsx)(s.p,{children:"\u8fd9\u91cc\u7684\u6211\u4eec\u5148\u4ece\u6d88\u606f\u7684\u53d1\u9001\u5f00\u59cb"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"alt text",src:n(8255).A+"",width:"2076",height:"495"})}),"\n",(0,r.jsx)(s.p,{children:"\u6d88\u606f\u53d1\u9001\u6700\u7ec8\u7684\u8bf7\u6c42\u72b6\u6001\u7801\u662f"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-java",children:"public static final int SEND_MESSAGE_V2 = 310;\n"})}),"\n",(0,r.jsxs)(s.p,{children:["\u53ef\u4ee5\u770b\u5230\u5b9e\u9645\u6d88\u606f\u53d1\u9001\u548c\u666e\u901a\u6d88\u606f\u6ca1\u6709\u4ec0\u4e48\u533a\u522b\uff0c\u6240\u4ee5\u6211\u4eec\u8fd8\u662f\u8981\u53bb",(0,r.jsx)(s.code,{children:"broker"}),"\u90a3\u8fb9\u770b\u770b\u6709\u6ca1\u6709\u4ec0\u4e48\u7279\u6b8a\u5904\u7406"]}),"\n",(0,r.jsx)(s.h3,{id:"broker\u5904\u7406\u8bf7\u6c42",children:"broker\u5904\u7406\u8bf7\u6c42"}),"\n",(0,r.jsxs)(s.p,{children:["\u6d88\u606f\u5904\u7406\u65b9\u6cd5\n",(0,r.jsx)(s.code,{children:"org.apache.rocketmq.broker.processor.SendMessageProcessor#processRequest"})]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"alt text",src:n(1863).A+"",width:"2164",height:"667"})}),"\n",(0,r.jsx)(s.p,{children:"\u5b9e\u9645\u7684\u6d88\u606f\u53d1\u9001\u903b\u8f91\u5728\u65b9\u6cd5"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-java",children:"this.sendMessage(ctx, request, sendMessageContext, requestHeader, mappingContext,\n                        (ctx12, response12) -> executeSendMessageHookAfter(response12, ctx12));\n"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"alt text",src:n(9266).A+"",width:"1667",height:"725"})}),"\n",(0,r.jsx)(s.p,{children:"\u8fd9\u91cc\u6211\u4eec\u8fdb\u53bb\u8fd9\u4e2a\u65b9\u6cd5\u770b\u770b"}),"\n",(0,r.jsx)(s.p,{children:"\u7531\u4e8e\u662f\u5206\u6790\u5ef6\u65f6\u6d88\u606f\uff0c\u6240\u4ee5\u6211\u4eec\u4e0d\u5173\u6ce8\u6d88\u606f\u53d1\u9001\u7684\u4e00\u4e9b\u5176\u4ed6\u7ec6\u8282\u3002\u4e3b\u8981\u5173\u6ce8\u5ef6\u65f6\u6d88\u606f\u548c\u666e\u901a\u6d88\u606f\u7684\u5904\u7406\u533a\u522b\n\u6211\u4eec\u770b\u65b9\u6cd5"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-java",children:"org.apache.rocketmq.store.DefaultMessageStore#asyncPutMessage\n"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"alt text",src:n(4015).A+"",width:"2200",height:"655"})}),"\n",(0,r.jsxs)(s.p,{children:["\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\u73b0\u5728\u7684",(0,r.jsx)(s.code,{children:"topic"}),"\u8fd8\u662f\u6211\u4eec\u6b63\u5e38\u6307\u5b9a\u7684",(0,r.jsx)(s.code,{children:"xiao-zou-topic"})]}),"\n",(0,r.jsxs)(s.p,{children:["\u4f46\u662f\u8fd9\u91cc\u4f1a\u6267\u884c\u591a\u4e2a\u6d88\u606f\u7684\u540e\u7f6e\u5904\u7406\u5668",(0,r.jsx)(s.code,{children:"putMessageHookList"})]}),"\n",(0,r.jsxs)(s.p,{children:["\u6211\u4eec\u770b\u770b",(0,r.jsx)(s.code,{children:"putMessageHookList"}),"\u6709\u54ea\u4e9b"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-java",children:'    public void registerMessageStoreHook() {\n        List<PutMessageHook> putMessageHookList = messageStore.getPutMessageHookList();\n\n        putMessageHookList.add(new PutMessageHook() {\n            @Override\n            public String hookName() {\n                return "checkBeforePutMessage";\n            }\n\n            @Override\n            public PutMessageResult executeBeforePutMessage(MessageExt msg) {\n                return HookUtils.checkBeforePutMessage(BrokerController.this, msg);\n            }\n        });\n\n        putMessageHookList.add(new PutMessageHook() {\n            @Override\n            public String hookName() {\n                return "innerBatchChecker";\n            }\n\n            @Override\n            public PutMessageResult executeBeforePutMessage(MessageExt msg) {\n                if (msg instanceof MessageExtBrokerInner) {\n                    return HookUtils.checkInnerBatch(BrokerController.this, msg);\n                }\n                return null;\n            }\n        });\n\n        putMessageHookList.add(new PutMessageHook() {\n            @Override\n            public String hookName() {\n                return "handleScheduleMessage";\n            }\n\n            @Override\n            public PutMessageResult executeBeforePutMessage(MessageExt msg) {\n                if (msg instanceof MessageExtBrokerInner) {\n                    return HookUtils.handleScheduleMessage(BrokerController.this, (MessageExtBrokerInner) msg);\n                }\n                return null;\n            }\n        });\n\n        SendMessageBackHook sendMessageBackHook = new SendMessageBackHook() {\n            @Override\n            public boolean executeSendMessageBack(List<MessageExt> msgList, String brokerName, String brokerAddr) {\n                return HookUtils.sendMessageBack(BrokerController.this, msgList, brokerName, brokerAddr);\n            }\n        };\n\n        if (messageStore != null) {\n            messageStore.setSendMessageBackHook(sendMessageBackHook);\n        }\n    }\n'})}),"\n",(0,r.jsx)(s.p,{children:"\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\u4e3b\u8981\u662f\u4e09\u4e2a"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"checkBeforePutMessage"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"innerBatchChecker"})}),"\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"handleScheduleMessage"})}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["\u901a\u8fc7\u65b9\u6cd5\u540d\u6211\u4eec\u53ef\u4ee5\u5f88\u786e\u5b9a\u7684\u770b\u5230\u4e3b\u8981\u662f",(0,r.jsx)(s.code,{children:"handleScheduleMessage"}),"\u8fd9\u4e2a\u65b9\u6cd5\u51fa\u5904\u7406\u5ef6\u65f6\u6d88\u606f\uff0c\u6240\u4ee5\u6211\u4eec\u91cd\u70b9\u770b\u770b",(0,r.jsx)(s.code,{children:"handleScheduleMessage"})]}),"\n",(0,r.jsx)(s.h3,{id:"handleschedulemessage",children:"handleScheduleMessage"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"org.apache.rocketmq.broker.util.HookUtils#handleScheduleMessage "})}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-java",children:" public static PutMessageResult handleScheduleMessage(BrokerController brokerController,\n        final MessageExtBrokerInner msg) {\n        final int tranType = MessageSysFlag.getTransactionValue(msg.getSysFlag());\n        // \u4e8b\u52a1\u6d88\u606f \u6682\u65f6\u4e0d\u7ba1\n        if (tranType == MessageSysFlag.TRANSACTION_NOT_TYPE\n            || tranType == MessageSysFlag.TRANSACTION_COMMIT_TYPE) {\n            if (!isRolledTimerMessage(msg)) {\n                if (checkIfTimerMessage(msg)) {\n                    if (!brokerController.getMessageStoreConfig().isTimerWheelEnable()) {\n                        //wheel timer is not enabled, reject the message\n                        return new PutMessageResult(PutMessageStatus.WHEEL_TIMER_NOT_ENABLE, null);\n                    }\n                    PutMessageResult transformRes = transformTimerMessage(brokerController, msg);\n                    if (null != transformRes) {\n                        return transformRes;\n                    }\n                }\n            }\n            // Delay Delivery \u5ef6\u65f6\u6d88\u606f\n            if (msg.getDelayTimeLevel() > 0) {\n                transformDelayLevelMessage(brokerController, msg);\n            }\n        }\n        return null;\n    }\n"})}),"\n",(0,r.jsx)(s.p,{children:"\u8fd9\u91cc\u7684\u6838\u5fc3\u903b\u8f91\u8fd8\u662f"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-java",children:"if (msg.getDelayTimeLevel() > 0) {\n                transformDelayLevelMessage(brokerController, msg);\n            }\n"})}),"\n",(0,r.jsxs)(s.p,{children:["\u6211\u4eec\u770b\u770b",(0,r.jsx)(s.code,{children:"transformDelayLevelMessage"}),"\u65b9\u6cd5"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-java",children:"public static void transformDelayLevelMessage(BrokerController brokerController, MessageExtBrokerInner msg) {\n        // \u5224\u65ad\u662f\u5426\u8d85\u8fc7\u6700\u5927\u5ef6\u65f6\u7ea7\u522b18 \u5982\u679c\u8d85\u8fc7\u5219\u8bbe\u7f6e\u4e3a\u6700\u5927\u5ef6\u65f6\u7b49\u7ea7\n        if (msg.getDelayTimeLevel() > brokerController.getScheduleMessageService().getMaxDelayLevel()) {\n            msg.setDelayTimeLevel(brokerController.getScheduleMessageService().getMaxDelayLevel());\n        }\n\n        // Backup real topic, queueId \u5907\u4efd\u771f\u5b9e\u7684topic queueId\n        MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_TOPIC, msg.getTopic());\n        MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msg.getQueueId()));\n        msg.setPropertiesString(MessageDecoder.messageProperties2String(msg.getProperties()));\n        // \u8bbe\u7f6e\u5ef6\u65f6\u6d88\u606f\u4e3aSCHEDULE_TOPIC_XXXX \u8fd9\u4e2a\u56fa\u5b9a\u7684topic\n        msg.setTopic(TopicValidator.RMQ_SYS_SCHEDULE_TOPIC);    \n        // \u8bbe\u7f6e\u5ef6\u65f6\u6d88\u606f\u7684queueID delayLevel - 1 \n        msg.setQueueId(ScheduleMessageService.delayLevel2QueueId(msg.getDelayTimeLevel()));\n    }\n"})}),"\n",(0,r.jsxs)(s.p,{children:["\u5907\u4efd\u524d\u7684",(0,r.jsx)(s.code,{children:"message"}),"\u4fe1\u606f"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"alt text",src:n(6790).A+"",width:"1326",height:"583"})}),"\n",(0,r.jsx)(s.p,{children:"\u5907\u4efd\u540e"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"alt text",src:n(5853).A+"",width:"1409",height:"193"})}),"\n",(0,r.jsx)(s.p,{children:"\u603b\u7ed3\u5c31\u662f"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:["\u5c06\u539f\u59cbtopic\u66ff\u6362\u4e3a\u5ef6\u8fdf\u6d88\u606f\u56fa\u5b9a\u7684topic:",(0,r.jsx)(s.code,{children:"SCHEDULE_TOPIC_XXXX"})]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:["\u5c06\u539f\u59cbqueueid\u66ff\u6362\u4e3a",(0,r.jsx)(s.code,{children:"delayLevel - 1 "})]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:["\u5907\u4efd\u539f\u59cb",(0,r.jsx)(s.code,{children:"topic/queueid"}),", \u4fdd\u5b58\u5230\u539f\u59cb\u6d88\u606f\u7684",(0,r.jsx)(s.code,{children:"properties"}),"\u5c5e\u6027\u4e2d"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"\u5ef6\u65f6\u6d88\u606f\u6d88\u8d39",children:"\u5ef6\u65f6\u6d88\u606f\u6d88\u8d39"}),"\n",(0,r.jsxs)(s.p,{children:["\u6211\u4eec\u901a\u8fc7\u67e5\u770b",(0,r.jsx)(s.code,{children:"SCHEDULE_TOPIC_XXXX"}),"\u7684\u8c03\u7528\u53d1\u73b0\u6709\u4e00\u4e2a\u65b9\u6cd5"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"org.apache.rocketmq.broker.schedule.ScheduleMessageService.DeliverDelayedMessageTimerTask#executeOnTimeup"})}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"alt text",src:n(1722).A+"",width:"2383",height:"443"})}),"\n",(0,r.jsx)(s.p,{children:"\u6211\u4eec\u67e5\u770b\u8c03\u7528\u94fe"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"alt text",src:n(861).A+"",width:"1522",height:"388"})}),"\n",(0,r.jsx)(s.p,{children:"\u53d1\u73b0\u5f88\u660e\u663e\u5e94\u8be5\u662f\u4f7f\u7528\u4e86\u4e00\u4e2a\u5b9a\u65f6\u5668\u53bb\u6267\u884c\u7684\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u770b"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"alt text",src:n(8507).A+"",width:"1919",height:"642"})}),"\n",(0,r.jsx)(s.p,{children:"\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\u628a18\u4e2a\u5ef6\u65f6\u7b49\u7ea7\u7684\u4efb\u52a1\u90fd\u52a0\u8fdb\u53bb\u4e86"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"alt text",src:n(5658).A+"",width:"1430",height:"534"})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.code,{children:"deliverExecutorService"}),"\u7684\u6838\u5fc3\u7ebf\u7a0b\u6570\u4e5f\u662f18\u4e2a"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-java",children:'            this.deliverExecutorService = new ScheduledThreadPoolExecutor(this.maxDelayLevel, new ThreadFactoryImpl("ScheduleMessageTimerThread_"));\n'})}),"\n",(0,r.jsxs)(s.p,{children:["\u6211\u4eec\u8fd9\u91cc\u770b\u770b\u4e22\u8fdb\u53bb\u7684",(0,r.jsx)(s.code,{children:"DeliverDelayedMessageTimerTask"}),"\u7684\u4efb\u52a1\u91cc\u9762\u91cc\u9762\u7684\u903b\u8f91"]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:(0,r.jsx)(s.code,{children:"org.apache.rocketmq.broker.schedule.ScheduleMessageService.DeliverDelayedMessageTimerTask#executeOnTimeup"})}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"alt text",src:n(9846).A+"",width:"1205",height:"601"})}),"\n",(0,r.jsxs)(s.p,{children:["\u6838\u5fc3\u903b\u8f91\u90fd\u88ab\u5c01\u88c5\u5728",(0,r.jsx)(s.code,{children:"executeOnTimeup"})]}),"\n",(0,r.jsxs)(s.p,{children:["\u6211\u4eec\u8fdb\u53bb\u770b\u770b",(0,r.jsx)(s.code,{children:"executeOnTimeup"})]}),"\n",(0,r.jsx)(s.p,{children:"\u4ee3\u7801\u903b\u8f91\u6709\u70b9\u957f\u6211\u4eec\uff0c\u6162\u6162\u770b"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-java",children:'public void executeOnTimeup() {\n            // \u6839\u636e\u5ef6\u8fdftopic\u548c\u5ef6\u8fdfqueueid \u53bb\u83b7\u53d6Consumequeue\n            ConsumeQueueInterface cq =\n                ScheduleMessageService.this.brokerController.getMessageStore().getConsumeQueue(TopicValidator.RMQ_SYS_SCHEDULE_TOPIC,\n                    delayLevel2QueueId(delayLevel));\n            // \u5982\u679c Consumequeue \u4e3a\u7a7a\u5219\u65b0\u589e\u4e00\u4e2a DeliverDelayedMessageTimerTask \u4e22\u5230 deliverExecutorService\u518d\u5b9a\u65f6\u6267\u884c\uff0c\u5ef6\u65f6\u65f6\u95f4\u9ed8\u8ba4\u4e3a100\u6beb\u79d2\n            // Consumequeue\u5b58\u5728\u4f46\u662f\u6ca1\u6709\u6d88\u8d39\u6587\u4ef6 \u4e00\u6837\u5ef6\u65f6100\u6beb\u79d2\u540e\u7ee7\u7eed\u91cd\u590d\u6267\u884c\n            if (cq == null) {\n                this.scheduleNextTimerTask(this.offset, DELAY_FOR_A_WHILE);\n                return;\n            }\n\n            ReferredIterator<CqUnit> bufferCQ = cq.iterateFrom(this.offset);\n            if (bufferCQ == null) {\n                long resetOffset;\n                if ((resetOffset = cq.getMinOffsetInQueue()) > this.offset) {\n                    log.error("schedule CQ offset invalid. offset={}, cqMinOffset={}, queueId={}",\n                        this.offset, resetOffset, cq.getQueueId());\n                } else if ((resetOffset = cq.getMaxOffsetInQueue()) < this.offset) {\n                    log.error("schedule CQ offset invalid. offset={}, cqMaxOffset={}, queueId={}",\n                        this.offset, resetOffset, cq.getQueueId());\n                } else {\n                    resetOffset = this.offset;\n                }\n\n                this.scheduleNextTimerTask(resetOffset, DELAY_FOR_A_WHILE);\n                return;\n            }\n\n            long nextOffset = this.offset;\n            try {\n                while (bufferCQ.hasNext() && isStarted()) {\n                    CqUnit cqUnit = bufferCQ.next();\n                    long offsetPy = cqUnit.getPos();\n                    int sizePy = cqUnit.getSize();\n                    // \u8fd9\u91cc\u7684 tagCode\u5b9e\u9645\u662f\u6295\u9012\u65f6\u95f4\n                    long tagsCode = cqUnit.getTagsCode();\n\n                    if (!cqUnit.isTagsCodeValid()) {\n                        //can\'t find ext content.So re compute tags code.\n                        log.error("[BUG] can\'t find consume queue extend file content!addr={}, offsetPy={}, sizePy={}",\n                            tagsCode, offsetPy, sizePy);\n                        long msgStoreTime = ScheduleMessageService.this.brokerController.getMessageStore().getCommitLog().pickupStoreTimestamp(offsetPy, sizePy);\n                        tagsCode = computeDeliverTimestamp(delayLevel, msgStoreTime);\n                    }\n\n                    long now = System.currentTimeMillis();\n                    // \u5ef6\u65f6\u6d88\u606f\u65f6\u95f4\u6821\u9a8c \u5982\u679c\u8d85\u8fc7deliverTimestamp now+delayLevel \u65f6\u95f4\u5219\u77eb\u6b63\u4e3a now+delayLevel\n                    long deliverTimestamp = this.correctDeliverTimestamp(now, tagsCode);\n\n                    long currOffset = cqUnit.getQueueOffset();\n                    assert cqUnit.getBatchNum() == 1;\n                    nextOffset = currOffset + cqUnit.getBatchNum();\n\n                    long countdown = deliverTimestamp - now;\n                    // \u5982\u679c\u5ef6\u65f6\u65f6\u95f4\u8d85\u8fc7\u5f53\u524d\u65f6\u95f4\uff0c\u8bc1\u660e\u8fd8\u672a\u5230\u6d88\u606f\u5904\u7406\u65f6\u95f4\n                    if (countdown > 0) {\n                        this.scheduleNextTimerTask(currOffset, DELAY_FOR_A_WHILE);      \n                        ScheduleMessageService.this.updateOffset(this.delayLevel, currOffset);\n                        return;\n                    }\n                    // \u52a0\u8f7d\u51fa\u5ef6\u65f6\u6d88\u606f\n                    MessageExt msgExt = ScheduleMessageService.this.brokerController.getMessageStore().lookMessageByOffset(offsetPy, sizePy);\n                    if (msgExt == null) {\n                        continue;\n                    }\n                    // \u6784\u5efa\u65b0\u7684\u6d88\u606f\u4f53\uff0c\u5c06\u539f\u6765\u7684\u6d88\u606f\u4fe1\u606f\u8bbe\u7f6e\u5230\u8fd9\u91cc\uff0c\u5e76\u5c06topic\u548cqueueid\u8bbe\u7f6e\u4e3a\u539f\u59cb\u7684topic\u548cqueueid(\u524d\u9762\u5907\u4efd\u8fc7\uff09\n                    MessageExtBrokerInner msgInner = ScheduleMessageService.this.messageTimeup(msgExt);\n                    if (TopicValidator.RMQ_SYS_TRANS_HALF_TOPIC.equals(msgInner.getTopic())) {\n                        log.error("[BUG] the real topic of schedule msg is {}, discard the msg. msg={}",\n                            msgInner.getTopic(), msgInner);\n                        continue;\n                    }\n\n                    boolean deliverSuc;\n                    if (ScheduleMessageService.this.enableAsyncDeliver) {\n                        deliverSuc = this.asyncDeliver(msgInner, msgExt.getMsgId(), currOffset, offsetPy, sizePy);\n                    } else {\n                        // \u5c06\u6d88\u606f\u5199\u5165\u5230 commitlog\u4e2d\n                        deliverSuc = this.syncDeliver(msgInner, msgExt.getMsgId(), currOffset, offsetPy, sizePy);\n                    }\n\n                    if (!deliverSuc) {\n                        this.scheduleNextTimerTask(nextOffset, DELAY_FOR_A_WHILE);\n                        return;\n                    }\n                }\n            } catch (Exception e) {\n                log.error("ScheduleMessageService, messageTimeup execute error, offset = {}", nextOffset, e);\n            } finally {\n                bufferCQ.release();\n            }\n\n            this.scheduleNextTimerTask(nextOffset, DELAY_FOR_A_WHILE);\n        }\n'})}),"\n",(0,r.jsx)(s.p,{children:"\u4e0a\u9762\u7684\u4ee3\u7801\u6211\u4eec\u5c06\u6838\u5fc3\u903b\u8f91\u505a\u4e86\u6ce8\u91ca,\u6211\u4eec\u603b\u7ed3\u4e00\u4e0b\u5927\u81f4\u6d41\u7a0b"}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"\u6821\u9a8c\u5bf9\u5e94\u7684\u5ef6\u65f6\u7b49\u7ea7\u6d88\u606f\u662f\u5426\u5b58\u5728ConsumeQueue\uff0c\u5982\u679c\u4e0d\u5b58\u5728\u5219\u5ef6\u65f6100ms\u7ee7\u7eed\u8f6e\u8bad"}),"\n",(0,r.jsx)(s.li,{children:"\u6821\u9a8cConsumeQueue\u4e2d\u7684\u7d22\u5f15\u662f\u5426\u5b58\u5728\uff0c\u5982\u679c\u4e0d\u5b58\u5728\u5219\u5ef6\u65f6100ms\u7ee7\u7eed\u8f6e\u8bad"}),"\n",(0,r.jsx)(s.li,{children:"\u6821\u9a8c\u7d22\u5f15\u91cc\u9762\u7684tagsCode \u5b9e\u9645\u662f\u6295\u9012\u65f6\u95f4\u662f\u5426\u5230\u4e86\u9700\u8981\u6295\u9012\u7684\u65f6\u95f4\uff0c\u5982\u679c\u662f\u5219\u53d6\u51fa\u5ef6\u65f6\u6d88\u606f"}),"\n",(0,r.jsxs)(s.li,{children:["\u5c06\u5ef6\u65f6\u6d88\u606f\u8fd8\u539f\u4e3a\u539f\u59cb\u6d88\u606f\uff0c\u6295\u9012\u5230",(0,r.jsx)(s.code,{children:"commitLog"}),"\u4e2d\u7ee7\u7eed\u6d88\u8d39"]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"\u8fd9\u91cc\u6211\u4eec\u901a\u8fc7debug\u770b\u770b\u6d88\u606f\u8f6c\u6362\u524d\u540e\u7684\u53c2\u6570"}),"\n",(0,r.jsx)(s.p,{children:"\u8f6c\u6362\u524d\u7684\u5ef6\u65f6\u6d88\u606f"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"alt text",src:n(2038).A+"",width:"1185",height:"442"})}),"\n",(0,r.jsx)(s.p,{children:"\u8f6c\u6362\u540e\u7684\u539f\u59cb\u6d88\u606f"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"alt text",src:n(5278).A+"",width:"1258",height:"527"})}),"\n",(0,r.jsxs)(s.p,{children:["\u6d88\u606f\u7684\u91cd\u65b0\u6295\u9012\u662f\u901a\u8fc7",(0,r.jsx)(s.code,{children:"syncDeliver"}),"\u65b9\u6cd5"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-java",children:"deliverSuc = this.syncDeliver(msgInner, msgExt.getMsgId(), currOffset, offsetPy, sizePy);\n"})}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-java",children:"private boolean syncDeliver(MessageExtBrokerInner msgInner, String msgId, long offset, long offsetPy,\n            int sizePy) {\n            PutResultProcess resultProcess = deliverMessage(msgInner, msgId, offset, offsetPy, sizePy, false);\n            PutMessageResult result = resultProcess.get();\n            boolean sendStatus = result != null && result.getPutMessageStatus() == PutMessageStatus.PUT_OK;\n            if (sendStatus) {\n                ScheduleMessageService.this.updateOffset(this.delayLevel, resultProcess.getNextOffset());\n            }\n            return sendStatus;\n        }\n"})}),"\n",(0,r.jsx)(s.p,{children:"\u5982\u679c\u6210\u529f\u5219\u66f4\u65b0\u5ef6\u65f6\u6d88\u606f\u7684\u6d88\u8d39\u8fdb\u5ea6\uff0c\u6ce8\u610f\u5ef6\u65f6\u6d88\u606f\u7684\u6d88\u8d39\u8fdb\u5ea6\u662f\u5b58\u50a8\u5728"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-java",children:"    private final ConcurrentMap<Integer /* level */, Long/* offset */> offsetTable =\n        new ConcurrentHashMap<>(32);\n\n"})}),"\n",(0,r.jsxs)(s.p,{children:["\u5b9e\u9645\u7684\u914d\u7f6e\u6587\u4ef6\u662f",(0,r.jsx)(s.code,{children:"delayOffset.json"})]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{alt:"alt text",src:n(2494).A+"",width:"1442",height:"477"})}),"\n",(0,r.jsxs)(s.p,{children:["\u81ea\u6b64",(0,r.jsx)(s.code,{children:"RocketMQ"}),"\u7684\u5ef6\u65f6\u6d88\u606f\u6211\u4eec\u5c31\u5206\u6790\u5b8c\u4e86"]}),"\n",(0,r.jsx)(s.h2,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,r.jsx)(s.p,{children:"\u603b\u7684\u6765\u8bf4\u5ef6\u65f6\u6d88\u606f\u5c31\u662f\u9ed8\u8ba4\u5206\u4e3a18\u4e2a\u961f\u5217\uff0c\u7136\u540e\u542f\u52a818\u4e2a\u7ebf\u7a0b\u4e00\u76f4\u53bb\u626b\u63cf\u8fd918\u4e2a\u961f\u5217\u3002\u5982\u679c\u6ca1\u6709\u6d88\u606f\u5c31\u8fc7100\u6beb\u79d2\u7ee7\u7eed\u91cd\u590d\u626b\u63cf\uff0c\u5468\u800c\u590d\u59cb"}),"\n",(0,r.jsxs)(s.p,{children:["\u5982\u679c\u626b\u63cf\u5230\u6d88\u606f\u5219\u5c06\u5ef6\u65f6\u6d88\u606f",(0,r.jsx)(s.code,{children:"Topic"}),"\uff1a",(0,r.jsx)(s.code,{children:"SCHEDULE_TOPIC_XXXX"}),"\u4e2d\u7684\u6d88\u606f\u53d6\u51fa\u6765,\u7136\u540e\u91cd\u65b0\u8f6c\u6362\u4e3a\u539f\u59cb\u6d88\u606f\uff0c\u5305\u62ec\u539f\u59cb\u6d88\u606f\u7684",(0,r.jsx)(s.code,{children:"Topic"}),"\u548c",(0,r.jsx)(s.code,{children:"queueId"}),"\uff0c\u7136\u540e\u91cd\u65b0\u5199\u5165\u5230",(0,r.jsx)(s.code,{children:"commitLog"}),"\u4e2d"]})]})}function g(e={}){const{wrapper:s}={...(0,c.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},2494:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/storePathConfigHelper-getDelayOffsetStorePath-code-2d346d99d36c9c9bbb993a08e403bcdf.png"},4015:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/DefaultMessageStore-asyncPutMessage-adcc4aef79f9b0254a3a92b24b0b9959.png"},4383:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/delay-time-level-1cd317245a6f24948cc4ea0dcbccd75a.png"},5278:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/delay-msgInner-debug-3a7aa1ca53566150e439466da233db01.png"},5658:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/delayLevelTable-code-debug-1366cd2136c6ac19e0822bfbf75ebb4a.png"},5853:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/delay-message-transform-debug-1c0aba573e8c7910e850a12699f507c9.png"},6790:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/delay-message-debug-df1bce5b144070561a9e0cb71da753b4.png"},8255:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/MQClient-send-message-b1b672ad072df41dc597624b26dc06c1.png"},8453:(e,s,n)=>{n.d(s,{R:()=>l,x:()=>i});var t=n(6540);const r={},c=t.createContext(r);function l(e){const s=t.useContext(c);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function i(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),t.createElement(c.Provider,{value:s},e.children)}},8507:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/ScheduleMessageService-start-code-c4f0558700569aacb9c77f9705018a00.png"},9266:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/SendMessageProcessor-sendMessage-d97a3f27766024f20bdf132b3cebbf58.png"},9846:(e,s,n)=>{n.d(s,{A:()=>t});const t=n.p+"assets/images/DeliverDelayedMessageTimerTask-executeOnTimeup-code.png-e0371b2a149d4739ae1d77eab289471b.png"}}]);