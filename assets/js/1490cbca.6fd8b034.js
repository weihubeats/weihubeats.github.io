"use strict";(globalThis.webpackChunkweihubeats_website=globalThis.webpackChunkweihubeats_website||[]).push([[1972],{14901(e,n,r){r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>p,frontMatter:()=>a,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"java/RPC/Feign/Feign\u81ea\u5b9a\u4e49\u54cd\u5e94\u5e8f\u5217\u5316","title":"Feign\u81ea\u5b9a\u4e49\u54cd\u5e94\u5e8f\u5217\u5316","description":"\u81ea\u5b9a\u4e49\u54cd\u5e94\u89e3\u7801\u5668","source":"@site/docs/java/RPC/Feign/Feign\u81ea\u5b9a\u4e49\u54cd\u5e94\u5e8f\u5217\u5316.md","sourceDirName":"java/RPC/Feign","slug":"/java/RPC/Feign/Feign\u81ea\u5b9a\u4e49\u54cd\u5e94\u5e8f\u5217\u5316","permalink":"/docs/java/RPC/Feign/Feign\u81ea\u5b9a\u4e49\u54cd\u5e94\u5e8f\u5217\u5316","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/java/RPC/Feign/Feign\u81ea\u5b9a\u4e49\u54cd\u5e94\u5e8f\u5217\u5316.md","tags":[],"version":"current","lastUpdatedAt":1764742380000,"frontMatter":{},"sidebar":"RPC","previous":{"title":"Dubbo\u670d\u52a1\u8c03\u7528JDK\u7248\u672c\u4e0d\u517c\u5bb9\u5982\u4f55\u89e3\u51b3","permalink":"/docs/java/RPC/Dubbo/Dubbo\u670d\u52a1\u8c03\u7528JDK\u7248\u672c\u4e0d\u517c\u5bb9\u5982\u4f55\u89e3\u51b3"}}');var o=r(74848),s=r(28453);const a={},i=void 0,c={},l=[{value:"\u81ea\u5b9a\u4e49\u54cd\u5e94\u89e3\u7801\u5668",id:"\u81ea\u5b9a\u4e49\u54cd\u5e94\u89e3\u7801\u5668",level:2},{value:"\u5f02\u5e38\u89e3\u7801\u5668",id:"\u5f02\u5e38\u89e3\u7801\u5668",level:2},{value:"\u4f7f\u7528",id:"\u4f7f\u7528",level:2}];function d(e){const n={code:"code",h2:"h2",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h2,{id:"\u81ea\u5b9a\u4e49\u54cd\u5e94\u89e3\u7801\u5668",children:"\u81ea\u5b9a\u4e49\u54cd\u5e94\u89e3\u7801\u5668"}),"\n",(0,o.jsxs)(n.p,{children:["\u5b9e\u73b0",(0,o.jsx)(n.code,{children:"Decoder"}),"\u63a5\u53e3\u5373\u53ef"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:'import feign.Request;\nimport feign.Response;\nimport feign.codec.ErrorDecoder;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\nimport org.springframework.stereotype.Component;\n\nimport java.nio.charset.StandardCharsets;\nimport java.util.Collection;\nimport java.util.Map;\n\n@Component\npublic class CustomFeignErrorDecoder implements ErrorDecoder {\n    \n    private static final Logger log = LoggerFactory.getLogger(CustomFeignErrorDecoder.class);\n    private final ErrorDecoder defaultDecoder = new Default();\n    \n    @Override\n    public Exception decode(String methodKey, Response response) {\n        // \u8bb0\u5f55\u8bf7\u6c42\u4fe1\u606f\n        Request request = response.request();\n        logErrorRequest(methodKey, request);\n        \n        // \u8bb0\u5f55\u54cd\u5e94\u4fe1\u606f\n        logErrorResponse(methodKey, response);\n\n                if (byte[].class.equals(type)) {\n            try {\n                return IoUtil.readBytes(body.asInputStream());\n            } catch (IOException e) {\n                log.error(ExceptionLogUtil.getMessage(e));\n                throw UserCenterException.wrap(e);\n            }\n        }\n\n                try {\n            final String str = IoUtil.read(body.asInputStream(), Charset.defaultCharset());\n            try {\n                final TypedResult<?> result = ObjectMapperHolder.getInstance().readValue(str, TypedResult.class);\n                                if (TypedResult.isSuccess(result.getCode())) {\n                    final Object data = result.getData();\n                    final JavaType javaType = TypeFactory.defaultInstance().constructType(type);\n                           return ObjectMapperHolder.getInstance().convertValue(data, javaType);\n                } else {\n                    throw new UserCenterException(result.getCode(), result.getMsg());\n                }\n                            } catch (MismatchedInputException e) {\n                log.error("MismatchedInputException: {} ", e.getMessage());\n                return ObjectMapperHolder.getInstance().readValue(str, TypeFactory.defaultInstance().constructType(type));\n            }\n                    } catch (Exception e) {\n            log.error(ExceptionLogUtil.getMessage(e), e);\n            throw UserCenterException.wrap(e);\n        }\n    }\n    \n    private void logErrorRequest(String methodKey, Request request) {\n        try {\n            log.error("Feign\u8c03\u7528\u5f02\u5e38 - \u65b9\u6cd5: {}", methodKey);\n            log.error("\u8bf7\u6c42URL: {} {}", request.httpMethod(), request.url());\n            log.error("\u8bf7\u6c42\u5934: {}", request.headers());\n            \n            if (request.body() != null && request.body().length > 0) {\n                String body = new String(request.body(), StandardCharsets.UTF_8);\n                log.error("\u8bf7\u6c42\u53c2\u6570: {}", body);\n            }\n        } catch (Exception e) {\n            log.warn("Failed to log request info", e);\n        }\n    }\n    \n    private void logErrorResponse(String methodKey, Response response) {\n        try {\n            log.error("\u54cd\u5e94\u72b6\u6001\u7801: {}", response.status());\n            log.error("\u54cd\u5e94\u5934: {}", response.headers());\n            \n            if (response.body() != null) {\n                byte[] bodyData = Util.toByteArray(response.body().asInputStream());\n                String body = new String(bodyData, StandardCharsets.UTF_8);\n                log.error("\u54cd\u5e94\u4f53: {}", body);\n            }\n        } catch (Exception e) {\n            log.warn("Failed to log response info", e);\n        }\n    }\n}\n\n'})}),"\n",(0,o.jsx)(n.h2,{id:"\u5f02\u5e38\u89e3\u7801\u5668",children:"\u5f02\u5e38\u89e3\u7801\u5668"}),"\n",(0,o.jsx)(n.p,{children:"\u5b9e\u73b0 ErrorDecoder\u7686\u53ef\u5373\u53ef"}),"\n",(0,o.jsx)(n.h2,{id:"\u4f7f\u7528",children:"\u4f7f\u7528"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:"@Configuration\npublic class UserFeignConfiguration {\n\n    @Bean\n    public ErrorDecoder feignErrorDecoder() {\n        return new FeignExceptionDecoder();\n    }\n\n    @Bean\n    Logger.Level feignLoggerLevel() {\n        return Logger.Level.NONE;\n    }\n}\n"})})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},28453(e,n,r){r.d(n,{R:()=>a,x:()=>i});var t=r(96540);const o={},s=t.createContext(o);function a(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:a(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);