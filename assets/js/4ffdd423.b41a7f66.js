"use strict";(globalThis.webpackChunkweihubeats_website=globalThis.webpackChunkweihubeats_website||[]).push([[1918],{98456(e,n,c){c.r(n),c.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"MQ/RocketMQ/\u6e90\u7801\u5206\u6790/\u804a\u804aHTTP2\u4e2d\u7684GOAWAY\u5e27\u4ee5\u53caRocketMQ\u5bf9GOAWAY\u7684\u5b9e\u73b0","title":"\u804a\u804aHTTP2\u4e2d\u7684GOAWAY\u5e27\u4ee5\u53caRocketMQ\u5bf9GOAWAY\u7684\u5b9e\u73b0","description":"\u80cc\u666f","source":"@site/docs/MQ/RocketMQ/\u6e90\u7801\u5206\u6790/\u804a\u804aHTTP2\u4e2d\u7684GOAWAY\u5e27\u4ee5\u53caRocketMQ\u5bf9GOAWAY\u7684\u5b9e\u73b0.md","sourceDirName":"MQ/RocketMQ/\u6e90\u7801\u5206\u6790","slug":"/MQ/RocketMQ/\u6e90\u7801\u5206\u6790/\u804a\u804aHTTP2\u4e2d\u7684GOAWAY\u5e27\u4ee5\u53caRocketMQ\u5bf9GOAWAY\u7684\u5b9e\u73b0","permalink":"/docs/MQ/RocketMQ/\u6e90\u7801\u5206\u6790/\u804a\u804aHTTP2\u4e2d\u7684GOAWAY\u5e27\u4ee5\u53caRocketMQ\u5bf9GOAWAY\u7684\u5b9e\u73b0","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/MQ/RocketMQ/\u6e90\u7801\u5206\u6790/\u804a\u804aHTTP2\u4e2d\u7684GOAWAY\u5e27\u4ee5\u53caRocketMQ\u5bf9GOAWAY\u7684\u5b9e\u73b0.md","tags":[],"version":"current","lastUpdatedAt":1744633467000,"frontMatter":{},"sidebar":"RocketMQ","previous":{"title":"\u4ece\u9762\u5230\u70b9\u4fef\u77b0RocketMQ\u5b58\u50a8\u6a21\u578b","permalink":"/docs/MQ/RocketMQ/\u6e90\u7801\u5206\u6790/\u4ece\u9762\u5230\u70b9\u4fef\u77b0RocketMQ\u5b58\u50a8\u6a21\u578b"},"next":{"title":"RocketMQ\u5982\u4f55\u6dfb\u52a0JVM\u76d1\u63a7","permalink":"/docs/MQ/RocketMQ/\u76d1\u63a7/RocketMQ\u5982\u4f55\u6dfb\u52a0JVM\u76d1\u63a7"}}');var r=c(74848),s=c(28453);const i={},l=void 0,d={},o=[{value:"\u80cc\u666f",id:"\u80cc\u666f",level:2},{value:"\u5927\u90e8\u5206\u7684\u7f51\u7edc\u901a\u4fe1\u5c01\u88c5",id:"\u5927\u90e8\u5206\u7684\u7f51\u7edc\u901a\u4fe1\u5c01\u88c5",level:2},{value:"RocketMQ\u4e2d\u7684GOAWAY\u5e27\u5e94\u7528",id:"rocketmq\u4e2d\u7684goaway\u5e27\u5e94\u7528",level:2},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2}];function a(e){const n={code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"\u80cc\u666f",children:"\u80cc\u666f"}),"\n",(0,r.jsxs)(n.p,{children:["\u6211\u4eec\u5148\u770b\u770b\u6211\u4eec\u7684",(0,r.jsx)(n.code,{children:"client"}),"\u548c",(0,r.jsx)(n.code,{children:"server"}),"\u901a\u4fe1\u7684\u8fd9\u4e48\u4e00\u79cd\u573a\u666f"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"client"}),"\u548c",(0,r.jsx)(n.code,{children:"server"}),"\u9700\u8981\u4fdd\u6301\u957f\u8fde\u63a5\u3002\u7136\u540e\u65e0\u8bba\u5ba2\u6237\u7aef\u8fd8\u662f\u670d\u52a1\u7aef\u51fa\u73b0\u5f02\u5e38\u91cd\u542f\u3002\u6211\u4eec\u90fd\u5e0c\u671b\u957f\u8fde\u63a5\u90fd\u5e94\u8be5\u5177\u5907",(0,r.jsx)(n.strong,{children:"\u91cd\u8bd5\u4fdd\u6d3b"}),"\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"HTTP2"}),"\u4e2d\u662f\u5982\u4f55\u5b9e\u73b0\u8fd9\u79cd\u91cd\u8fde\u673a\u5236\u5462\uff1f"]}),"\n",(0,r.jsxs)(n.p,{children:["\u7b54\u6848\u5c31\u662f",(0,r.jsx)(n.code,{children:"GOAWAY"}),"\u5e27\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"HTTP2"})," \u4f7f\u7528 GOAWAY \u5e27\u4fe1\u53f7\u6765\u63a7\u5236\u8fde\u63a5\u5173\u95ed\u3002\u5f53\u670d\u52a1\u7aef\u9700\u8981\u91cd\u542f\u7684\u65f6\u5019\uff0c\u5c31\u4f1a\u7ed9",(0,r.jsx)(n.code,{children:"client"}),"\u53d1\u9001\u4e00\u4e2a GOAWAY \u5e27\uff0c\u544a\u8bc9\u4e1a\u52a1\u65b9\uff0c\u6211\u8981\u91cd\u542f\u4e86\uff0c\u4f60\u4eec\u9700\u8981\u91cd\u8fde\u4e86\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"client"}),"\u6536\u5230",(0,r.jsx)(n.code,{children:"GOAWAY"}),"\u5e27\u540e\uff0c\u4f1a\u5173\u95ed\u5f53\u524d\u8fde\u63a5\uff0c\u7136\u540e\u91cd\u65b0\u53d1\u8d77\u8fde\u63a5\u3002"]}),"\n",(0,r.jsx)(n.p,{children:"\u5927\u81f4\u6d41\u7a0b\u5982\u4e0b"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"client-server-goaway.png",src:c(12875).A+"",width:"759",height:"299"})}),"\n",(0,r.jsx)(n.h2,{id:"\u5927\u90e8\u5206\u7684\u7f51\u7edc\u901a\u4fe1\u5c01\u88c5",children:"\u5927\u90e8\u5206\u7684\u7f51\u7edc\u901a\u4fe1\u5c01\u88c5"}),"\n",(0,r.jsxs)(n.p,{children:["\u5b9e\u9645\u6211\u4eec\u5982\u679c\u53bb\u770b\u5f00\u6e90\u9879\u76ee\u3002\u5f88\u591a\u5f00\u6e90\u9879\u76ee",(0,r.jsx)(n.code,{children:"client"}),"\u548c",(0,r.jsx)(n.code,{children:"server"}),"\u65e0\u8bba\u662f\u79c1\u6709\u534f\u8bae\u8fd8\u662f",(0,r.jsx)(n.code,{children:"GRPC"}),"\u534f\u8bae\u5bf9",(0,r.jsx)(n.code,{children:"GOAWAY"}),"\u5e27\u7684\u5b9e\u73b0\u90fd\u4e0d\u662f\u5f88\u597d\uff0c\u6216\u8005\u6ca1\u6709\u8fd9\u79cd\u5904\u7406"]}),"\n",(0,r.jsx)(n.h2,{id:"rocketmq\u4e2d\u7684goaway\u5e27\u5e94\u7528",children:"RocketMQ\u4e2d\u7684GOAWAY\u5e27\u5e94\u7528"}),"\n",(0,r.jsxs)(n.p,{children:["\u5728\u65e9\u671f\u76844.0\u6216\u8005\u65e9\u4e00\u70b9\u76845.x\u7248\u672c\u90fd\u6ca1\u6709\u5b9e\u73b0\u7c7b\u4f3c",(0,r.jsx)(n.code,{children:"GOAWAY"}),"\u5e27"]}),"\n",(0,r.jsxs)(n.p,{children:["\u6211\u4eec\u6765\u770b\u770b\u6700\u65b0\u7684",(0,r.jsx)(n.code,{children:"RocketMQ"}),"\u73b0\u5728\u662f\u5982\u4f55\u5b9e\u73b0",(0,r.jsx)(n.code,{children:"GOAWAY"}),"\u4f18\u96c5\u505c\u673a\u7684"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u9996\u5148\u5728",(0,r.jsx)(n.code,{children:"ResponseCode"}),"\u65b0\u589e\u4e86\u4e00\u4e2a\u72b6\u6001\u7801"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"public static final int GO_AWAY = 1500;\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsxs)(n.li,{children:["\u5982\u679c\u670d\u52a1\u7aef\u8981\u8fdb\u884c\u505c\u673a\uff0c\u4f1a\u7ed9",(0,r.jsx)(n.code,{children:"client"}),"\u53d1\u9001\u4e00\u4e2a",(0,r.jsx)(n.code,{children:"GOAWAY"}),"\u5e27"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'protected AtomicBoolean isShuttingDown = new AtomicBoolean(false);\n\npublic void processRequestCommand(final ChannelHandlerContext ctx, final RemotingCommand cmd) {\n    // \u7701\u7565\u90e8\u5206\u4ee3\u7801\n    if (isShuttingDown.get()) {\n        if (cmd.getVersion() > MQVersion.Version.V5_3_1.ordinal()) {\n            final RemotingCommand response = RemotingCommand.createResponseCommand(ResponseCode.GO_AWAY,\n                "please go away");\n            response.setOpaque(opaque);\n            writeResponse(ctx.channel(), cmd, response);\n            log.info("proxy is shutting down, write response GO_AWAY. channel={}, requestCode={}, opaque={}", ctx.channel(), cmd.getCode(), opaque);\n            return;\n        }\n    }\n    \n}\n'})}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsxs)(n.li,{children:["\u5ba2\u6237\u7aef\u5982\u679c\u63a5\u6536\u5230",(0,r.jsx)(n.code,{children:"GOAWAY"}),"\u5e27\uff0c\u4f1a\u5173\u95ed\u5f53\u524d\u8fde\u63a5\uff0c\u7136\u540e\u91cd\u65b0\u53d1\u8d77\u8fde\u63a5"]}),"\n"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"NettyRemotingClient"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'    public CompletableFuture<ResponseFuture> invokeImpl(final Channel channel, final RemotingCommand request,\n        final long timeoutMillis) {\n    if (response.getCode() == ResponseCode.GO_AWAY) {\n        ChannelWrapper channelWrapper = channelWrapperTables.computeIfPresent(channel, (channel0, channelWrapper0) -> {\n            try {\n                // \u91cd\u65b0\u5efa\u7acb\u8fde\u63a5\n                if (channelWrapper0.reconnect(channel0)) {\n                    LOGGER.info("Receive go away from channelId={}, channel={}, recreate the channelId={}", channel0.id(), channel0, channelWrapper0.getChannel().id());\n                    channelWrapperTables.put(channelWrapper0.getChannel(), channelWrapper0);\n                }\n            } catch (Throwable t) {\n                LOGGER.error("Channel {} reconnect error", channelWrapper0, t);\n            }\n            return channelWrapper0;\n        });\n        \n        \n    }\n    \n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["\u91cd\u65b0\u5efa\u7acb\u8fde\u63a5\u7684\u65f6\u5019\u4e5f\u4f1a\u5bf9\u91cd\u65b0\u5efa\u7acb\u8fde\u63a5\u7684",(0,r.jsx)(n.code,{children:"broker"}),"\u8fdb\u884c\u5fc3\u8df3\u53d1\u9001\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u8fd9\u91cc\u4e3b\u8981\u662f\u5bf9\u6240\u6709\u7684",(0,r.jsx)(n.code,{children:"channal"}),"\u8fdb\u884c\u4e86\u5c01\u88c5"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"NettyConnectManageHandler"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"netty-connect-manage-handler.png",src:c(94991).A+"",width:"1209",height:"1270"})}),"\n",(0,r.jsxs)(n.p,{children:["\u6bcf\u6b21\u51fa\u53d1",(0,r.jsx)(n.code,{children:"netty"}),"\u76f8\u5173\u7684\u6bd4\u5982",(0,r.jsx)(n.code,{children:"channal"})," ",(0,r.jsx)(n.code,{children:"CLOSE"}),"\u6216\u8005",(0,r.jsx)(n.code,{children:"ACTIVE"}),"\u7b49\u4e8b\u4ef6"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"public enum NettyEventType {\n    CONNECT,\n    CLOSE,\n    IDLE,\n    EXCEPTION,\n    ACTIVE\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5c31\u4f1a\u89e6\u53d1\u5bf9\u5e94\u7684",(0,r.jsx)(n.code,{children:"NettyEvent"}),"\u4e8b\u4ef6\u7ed9\u5ba2\u6237\u7aef\u5904\u7406"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'    protected final NettyEventExecutor nettyEventExecutor = new NettyEventExecutor();\n\n    public void putNettyEvent(final NettyEvent event) {\n    this.nettyEventExecutor.putNettyEvent(event);\n    }\n\n    public void putNettyEvent(final NettyEvent event) {\n        int currentSize = this.eventQueue.size();\n        int maxSize = 10000;\n        if (currentSize <= maxSize) {\n            this.eventQueue.add(event);\n        } else {\n            log.warn("event queue size [{}] over the limit [{}], so drop this event {}", currentSize, maxSize, event.toString());\n    }\n}\n\n'})}),"\n",(0,r.jsxs)(n.p,{children:["\u5176\u4e2d",(0,r.jsx)(n.code,{children:"client"}),"\u5c31\u53ef\u4ee5\u76d1\u542c\u5404\u79cd",(0,r.jsx)(n.code,{children:"Netty"}),"\u7684\u4e8b\u4ef6\u8fdb\u884c\u5bf9\u5e94\u7684\u4e1a\u52a1\u903b\u8f91\u5904\u7406,\u6bd4\u5982\u76d1\u542c",(0,r.jsx)(n.code,{children:"ACTIVE"}),"\u4e8b\u4ef6\u91cd\u65b0\u53d1\u9001\u5fc3\u8df3\u7ed9",(0,r.jsx)(n.code,{children:"broker"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"                @Override\n                public void onChannelActive(String remoteAddr, Channel channel) {\n\n                    for (Map.Entry<String, HashMap<Long, String>> addressEntry : brokerAddrTable.entrySet()) {\n                        for (Map.Entry<Long, String> entry : addressEntry.getValue().entrySet()) {\n                            String addr = entry.getValue();\n                            if (addr.equals(remoteAddr)) {\n                                long id = entry.getKey();\n                                String brokerName = addressEntry.getKey();\n                                if (sendHeartbeatToBroker(id, brokerName, addr)) {\n                                    rebalanceImmediately();\n                                }\n                                break;\n                            }\n                        }\n                    }\n\n                }\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"GOAWAY"}),"\u5e27\u662f",(0,r.jsx)(n.code,{children:"HTTP2"}),"\u4e2d\u7684\u4e00\u4e2a\u91cd\u8981\u7684\u5e27\uff0c\u7528\u6765\u544a\u77e5",(0,r.jsx)(n.code,{children:"client"}),"\u670d\u52a1\u7aef\u8981\u91cd\u542f\u4e86\uff0c",(0,r.jsx)(n.code,{children:"client"}),"\u9700\u8981\u91cd\u65b0\u8fde\u63a5\u3002\u4ee5\u6b64\u4fdd\u8bc1\u670d\u52a1\u7684\u53ef\u7528\u6027"]}),"\n",(0,r.jsxs)(n.p,{children:["\u5927\u591a\u6570\u5f00\u6e90\u9879\u76ee\u4e2d\u7684\u79c1\u6709\u534f\u8bae\u6216\u8005\u4f7f\u7528",(0,r.jsx)(n.code,{children:"GRPC"}),"\u901a\u4fe1\u7684\u5f00\u6e90\u4e2d\u95f4\u4ef6\u90fd\u6ca1\u6709\u5f88\u597d\u7684\u53bb\u5904\u7406",(0,r.jsx)(n.code,{children:"GOAWAY"}),"\u5e27"]}),"\n",(0,r.jsxs)(n.p,{children:["\u5982\u679c\u60f3\u8981",(0,r.jsx)(n.code,{children:"client"}),"\u548c",(0,r.jsx)(n.code,{children:"server"}),"\u8fde\u63a5\u7684\u53ef\u7528\u6027\u66f4\u9ad8\uff0c\u6211\u4eec\u53ef\u4ee5\u53c2\u8003",(0,r.jsx)(n.code,{children:"RocketMQ"}),"\u7684\u5b9e\u73b0\uff0c\u5bf9",(0,r.jsx)(n.code,{children:"GOAWAY"}),"\u5e27\u8fdb\u884c\u5904\u7406\uff0c\u4fdd\u8bc1\u670d\u52a1\u7684\u53ef\u7528\u6027"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},12875(e,n,c){c.d(n,{A:()=>t});const t=c.p+"assets/images/client-server-goaway-6764c21d2b39ec809d2f520950aaeebb.png"},94991(e,n,c){c.d(n,{A:()=>t});const t=c.p+"assets/images/netty-connect-manage-handler-44d145e9ea33359f9ccf63f2d13472d9.png"},28453(e,n,c){c.d(n,{R:()=>i,x:()=>l});var t=c(96540);const r={},s=t.createContext(r);function i(e){const n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);