"use strict";(globalThis.webpackChunkweihubeats_website=globalThis.webpackChunkweihubeats_website||[]).push([[2128],{91141(e,n,t){t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>o,default:()=>d,frontMatter:()=>c,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"\u5b89\u5168/\u7528\u6237\u6743\u9650/\u4f7f\u7528Sa-Token\u5b9e\u73b0\u4e09\u65b9\u767b\u5165-OAuth 2.0","title":"\u4f7f\u7528Sa-Token\u5b9e\u73b0\u4e09\u65b9\u767b\u5165-OAuth 2.0","description":"\u6dfb\u52a0\u4f9d\u8d56","source":"@site/docs/\u5b89\u5168/\u7528\u6237\u6743\u9650/\u4f7f\u7528Sa-Token\u5b9e\u73b0\u4e09\u65b9\u767b\u5165-OAuth 2.0.md","sourceDirName":"\u5b89\u5168/\u7528\u6237\u6743\u9650","slug":"/\u5b89\u5168/\u7528\u6237\u6743\u9650/\u4f7f\u7528Sa-Token\u5b9e\u73b0\u4e09\u65b9\u767b\u5165-OAuth 2.0","permalink":"/docs/\u5b89\u5168/\u7528\u6237\u6743\u9650/\u4f7f\u7528Sa-Token\u5b9e\u73b0\u4e09\u65b9\u767b\u5165-OAuth 2.0","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/\u5b89\u5168/\u7528\u6237\u6743\u9650/\u4f7f\u7528Sa-Token\u5b9e\u73b0\u4e09\u65b9\u767b\u5165-OAuth 2.0.md","tags":[],"version":"current","frontMatter":{},"sidebar":"\u7528\u6237\u6743\u9650","previous":{"title":"\u4ece\u96f6\u5230\u4e00\u8bbe\u8ba1\u4e00\u5957\u591a\u79df\u6237\u6743\u9650\u63a7\u5236","permalink":"/docs/\u5b89\u5168/\u7528\u6237\u6743\u9650/\u4ece\u96f6\u5230\u4e00\u8bbe\u8ba1\u4e00\u5957\u591a\u79df\u6237\u6743\u9650\u63a7\u5236"},"next":{"title":"\u57fa\u4e8eSa token\u5b9e\u73b0\u6743\u9650\u8ba4\u8bc1","permalink":"/docs/\u5b89\u5168/\u7528\u6237\u6743\u9650/\u57fa\u4e8eSa token\u5b9e\u73b0\u6743\u9650\u8ba4\u8bc1"}}');var r=t(74848),s=t(28453);const c={},o=void 0,i={},l=[{value:"\u6dfb\u52a0\u4f9d\u8d56",id:"\u6dfb\u52a0\u4f9d\u8d56",level:2},{value:"\u914d\u7f6e OAuth2.0 \u5ba2\u6237\u7aef\u4fe1\u606f",id:"\u914d\u7f6e-oauth20-\u5ba2\u6237\u7aef\u4fe1\u606f",level:2},{value:"\u7f16\u5199\u63a5\u53e3",id:"\u7f16\u5199\u63a5\u53e3",level:2}];function u(e){const n={code:"code",h2:"h2",pre:"pre",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"\u6dfb\u52a0\u4f9d\u8d56",children:"\u6dfb\u52a0\u4f9d\u8d56"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-xml",children:"\x3c!-- Sa-Token \u6743\u9650\u8ba4\u8bc1 --\x3e\n<dependency>\n    <groupId>cn.dev33</groupId>\n    <artifactId>sa-token-spring-boot-starter</artifactId>\n    <version>1.37.0</version>\n</dependency>\n\n\x3c!-- Sa-Token \u6574\u5408 OAuth2.0 --\x3e\n<dependency>\n    <groupId>cn.dev33</groupId>\n    <artifactId>sa-token-oauth2</artifactId>\n    <version>1.37.0</version>\n</dependency>\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u914d\u7f6e-oauth20-\u5ba2\u6237\u7aef\u4fe1\u606f",children:"\u914d\u7f6e OAuth2.0 \u5ba2\u6237\u7aef\u4fe1\u606f"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"sa-token:\n  # OAuth2.0 \u914d\u7f6e\n  oauth2: \n    is-http: false    # \u662f\u5426\u5f00\u542f http \u6821\u9a8c\uff08\u672c\u5730\u73af\u5883\u53ef\u5f00\u542ftrue\uff0c\u751f\u4ea7\u73af\u5883\u5fc5\u987bfalse\uff09\n    client:\n      wechat:  # \u5fae\u4fe1\u767b\u5f55\u914d\u7f6e\n        client-id: ${wechat.client-id}       # \u5e94\u7528ID\n        client-secret: ${wechat.client-secret} # \u5e94\u7528\u5bc6\u94a5\n        authorization-url: https://open.weixin.qq.com/connect/oauth2/authorize  # \u6388\u6743\u5730\u5740\n        access-token-url: https://api.weixin.qq.com/sns/oauth2/access_token     # \u53d6\u4ee4\u724c\u5730\u5740\n        user-info-url: https://api.weixin.qq.com/sns/userinfo                   # \u53d6\u7528\u6237\u4fe1\u606f\u5730\u5740\n        redirect-uri: http://\u4f60\u7684\u57df\u540d/oauth/wechat/callback  # \u56de\u8c03\u5730\u5740\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u7f16\u5199\u63a5\u53e3",children:"\u7f16\u5199\u63a5\u53e3"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'@RestController\npublic class OAuth2Controller {\n\n    // \u7b2c\u4e00\u6b65\uff1a\u751f\u6210\u5fae\u4fe1\u767b\u5f55\u6388\u6743\u5730\u5740\uff0c\u5e76\u8df3\u8f6c\n    @RequestMapping("/oauth/wechat/login")\n    public SaResult wechatLogin() {\n        // \u76f4\u63a5\u4f7f\u7528 SaOAuth2Handle \u6765\u7b80\u5316\u6d41\u7a0b\n        return SaOAuth2Handle.provider("wechat").doLogin();\n        \n        // \u6216\u8005\u624b\u52a8\u6784\u5efa\u6388\u6743URL\uff08\u66f4\u7075\u6d3b\uff09\n        // String authUrl = SaOAuth2Handle.provider("wechat").getAuthorizeUrl();\n        // return SaResult.data(authUrl);\n    }\n\n    // \u7b2c\u4e8c\u6b65\uff1a\u5904\u7406\u5fae\u4fe1\u56de\u8c03\n    @RequestMapping("/oauth/wechat/callback")\n    public SaResult wechatCallback(String code, String state) {\n        try {\n            // 1. \u901a\u8fc7 code \u83b7\u53d6 access_token\n            String accessToken = SaOAuth2Handle.provider("wechat").getAccessToken(code);\n            \n            // 2. \u4f7f\u7528 access_token \u83b7\u53d6\u7528\u6237\u4fe1\u606f\n            SaOAuth2User user = SaOAuth2Handle.provider("wechat").getUserInfo(accessToken);\n            \n            // 3. \u5904\u7406\u7528\u6237\u4fe1\u606f\uff08\u6838\u5fc3\u4e1a\u52a1\u903b\u8f91\uff09\n            return handleOAuth2User(user);\n            \n        } catch (SaOAuth2Exception e) {\n            return SaResult.error("\u7b2c\u4e09\u65b9\u767b\u5f55\u5931\u8d25: " + e.getMessage());\n        }\n    }\n\n    /**\n     * \u5904\u7406\u7b2c\u4e09\u65b9\u767b\u5f55\u6210\u529f\u7684\u7528\u6237\u4fe1\u606f\n     */\n    private SaResult handleOAuth2User(SaOAuth2User user) {\n        // \u7528\u6237\u7684\u552f\u4e00\u6807\u8bc6\uff08\u5fae\u4fe1\u662fopenid\uff09\n        String openId = user.getUserId();\n        String nickname = user.getNickname();\n        String avatar = user.getAvatar();\n        \n        // ========== \u6838\u5fc3\u4e1a\u52a1\u903b\u8f91\u5f00\u59cb ==========\n        // 1. \u67e5\u8be2\u672c\u5730\u6570\u636e\u5e93\u4e2d\u662f\u5426\u5df2\u5b58\u5728\u8be5\u5fae\u4fe1\u7528\u6237\n        User localUser = userService.findByWechatOpenId(openId);\n        \n        if (localUser == null) {\n            // 2. \u5982\u679c\u4e0d\u5b58\u5728\uff0c\u81ea\u52a8\u6ce8\u518c\u65b0\u7528\u6237\n            localUser = new User();\n            localUser.setWechatOpenId(openId);\n            localUser.setNickname(nickname);\n            localUser.setAvatar(avatar);\n            localUser.setCreateTime(new Date());\n            userService.save(localUser);\n        } else {\n            // 3. \u5982\u679c\u5df2\u5b58\u5728\uff0c\u66f4\u65b0\u7528\u6237\u4fe1\u606f\uff08\u53ef\u9009\uff09\n            localUser.setNickname(nickname);\n            localUser.setAvatar(avatar);\n            localUser.setLastLoginTime(new Date());\n            userService.updateById(localUser);\n        }\n        \n        // 4. \u5728 Sa-Token \u4e2d\u767b\u5f55\u8fd9\u4e2a\u7528\u6237\n        StpUtil.login(localUser.getId());\n        \n        // 5. \u8fd4\u56de\u767b\u5f55\u6210\u529f\u4fe1\u606f\u548c token\n        return SaResult.data(StpUtil.getTokenInfo());\n        // ========== \u6838\u5fc3\u4e1a\u52a1\u903b\u8f91\u7ed3\u675f ==========\n    }\n}\n'})})]})}function d(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(u,{...e})}):u(e)}},28453(e,n,t){t.d(n,{R:()=>c,x:()=>o});var a=t(96540);const r={},s=a.createContext(r);function c(e){const n=a.useContext(s);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),a.createElement(s.Provider,{value:n},e.children)}}}]);