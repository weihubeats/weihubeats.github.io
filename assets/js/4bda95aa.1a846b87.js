"use strict";(globalThis.webpackChunkweihubeats_website=globalThis.webpackChunkweihubeats_website||[]).push([[5612],{26374(e,n,t){t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>s,default:()=>u,frontMatter:()=>a,metadata:()=>c,toc:()=>d});const c=JSON.parse('{"id":"java/netty/\u6df1\u5165\u5256\u6790Netty\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u673a\u5236\u4e0e\u5b9e\u6218","title":"\u6df1\u5165\u5256\u6790Netty\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u673a\u5236\u4e0e\u5b9e\u6218","description":"\u4e3a\u4ec0\u4e48Netty\u4f1a\u5b58\u5728\u5185\u5b58\u6cc4\u6f0f","source":"@site/docs/java/netty/\u6df1\u5165\u5256\u6790Netty\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u673a\u5236\u4e0e\u5b9e\u6218.md","sourceDirName":"java/netty","slug":"/java/netty/\u6df1\u5165\u5256\u6790Netty\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u673a\u5236\u4e0e\u5b9e\u6218","permalink":"/docs/java/netty/\u6df1\u5165\u5256\u6790Netty\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u673a\u5236\u4e0e\u5b9e\u6218","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/java/netty/\u6df1\u5165\u5256\u6790Netty\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u673a\u5236\u4e0e\u5b9e\u6218.md","tags":[],"version":"current","lastUpdatedAt":1757919049000,"frontMatter":{},"sidebar":"java_netty","previous":{"title":"\u4eceNetty\u53d1\u9001\u6d88\u606f\u6d41\u7a0b\u5206\u6790\u804a\u804a\u9ad8\u6c34\u4f4d\u548c\u4f4e\u6c34\u4f4d","permalink":"/docs/java/netty/\u4eceNetty\u53d1\u9001\u6d88\u606f\u6d41\u7a0b\u5206\u6790\u804a\u804a\u9ad8\u6c34\u4f4d\u548c\u4f4e\u6c34\u4f4d"}}');var r=t(74848),l=t(28453);const a={},s=void 0,i={},d=[{value:"\u4e3a\u4ec0\u4e48Netty\u4f1a\u5b58\u5728\u5185\u5b58\u6cc4\u6f0f",id:"\u4e3a\u4ec0\u4e48netty\u4f1a\u5b58\u5728\u5185\u5b58\u6cc4\u6f0f",level:2},{value:"\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u6838\u5fc3\u5b9e\u73b0",id:"\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u6838\u5fc3\u5b9e\u73b0",level:2},{value:"\u521b\u5efaByteBuf\u5e76\u8fdb\u884c\u5305\u88c5\u8ddf\u8e2a",id:"\u521b\u5efabytebuf\u5e76\u8fdb\u884c\u5305\u88c5\u8ddf\u8e2a",level:3},{value:"ByteBuf\u6b63\u5e38\u91ca\u653e",id:"bytebuf\u6b63\u5e38\u91ca\u653e",level:3},{value:"ByteBuf\u975e\u6b63\u5e38\u91ca\u653e(\u5185\u5b58\u6cc4\u6f0f)",id:"bytebuf\u975e\u6b63\u5e38\u91ca\u653e\u5185\u5b58\u6cc4\u6f0f",level:3},{value:"\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u4f7f\u7528",id:"\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u4f7f\u7528",level:2},{value:"\u9891\u7387",id:"\u9891\u7387",level:2},{value:"\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u7b49\u7ea7",id:"\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u7b49\u7ea7",level:2},{value:"\u6d4b\u8bd5\u9a8c\u8bc1",id:"\u6d4b\u8bd5\u9a8c\u8bc1",level:2},{value:"\u6cc4\u6f0f\u9a8c\u8bc1",id:"\u6cc4\u6f0f\u9a8c\u8bc1",level:3},{value:"\u6b63\u5e38\u9a8c\u8bc1",id:"\u6b63\u5e38\u9a8c\u8bc1",level:3},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2},{value:"\u53c2\u8003",id:"\u53c2\u8003",level:2}];function o(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"\u4e3a\u4ec0\u4e48netty\u4f1a\u5b58\u5728\u5185\u5b58\u6cc4\u6f0f",children:"\u4e3a\u4ec0\u4e48Netty\u4f1a\u5b58\u5728\u5185\u5b58\u6cc4\u6f0f"}),"\n",(0,r.jsxs)(n.p,{children:["\u5728Java\u91cc\u9762\u666e\u901a\u53d8\u6210\u6211\u4eec\u90fd\u662f\u8ba9JVM\u81ea\u52a8\u53d6\u5783\u573e\u56de\u6536(GC)\uff0c\u4f46\u662f\u4e00\u65e6\u7528\u4e86",(0,r.jsx)(n.code,{children:"Netty"})]}),"\n",(0,r.jsx)(n.p,{children:"\u4e3a\u4ec0\u4e48\u5185\u5b58\u6cc4\u6f0f\u5c31\u6210\u4e86\u6211\u4eec\u9700\u8981\u91cd\u70b9\u5173\u6ce8\u7684\u95ee\u9898\uff1f"}),"\n",(0,r.jsx)(n.p,{children:"Netty \u4e3a\u4e86\u8ffd\u6c42\u6781\u81f4\u6027\u80fd\u800c\u91c7\u7528\u7684**\u5806\u5916\u5185\u5b58\uff08Direct Memory\uff09\u548c\u5185\u5b58\u6c60\uff08Memory Pool\uff09**\u6280\u672f"}),"\n",(0,r.jsx)(n.p,{children:"JVM \u7684\u5806\u5185\u5b58\u662f\u4e00\u4e2a\u81ea\u52a8\u5316\u7ba1\u7406\u7684\u4ed3\u5e93\uff0c\u6709\u5783\u573e\u56de\u6536\u5458\uff08GC\uff09\u5b9a\u671f\u6e05\u7406\u3002"}),"\n",(0,r.jsxs)(n.p,{children:["\u800c Netty \u7684\u5185\u5b58\u6c60\u5219\u50cf\u4e00\u4e2a\u9ad8\u6027\u80fd\u7684\u81ea\u52a9\u5f0f\u4ed3\u5e93\uff0c\u4f60\u9700\u8981\u81ea\u5df1\u53bb\u524d\u53f0\uff08Allocator\uff09\u501f\u7528\u4e00\u4e2a\u50a8\u7269\u67dc\uff08ByteBuf\uff09\uff0c\u7528\u5b8c\u540e\u5fc5\u987b\u4eb2\u81ea\u5f52\u8fd8\u94a5\u5319\uff08\u8c03\u7528 ",(0,r.jsx)(n.code,{children:"release()"})," \u65b9\u6cd5\uff09\u3002"]}),"\n",(0,r.jsx)(n.p,{children:"\u5982\u679c\u4f60\u53ea\u501f\u4e0d\u8fd8\uff0c\u50a8\u7269\u67dc\u5c31\u4f1a\u88ab\u4e00\u76f4\u5360\u7528\uff0c\u6700\u7ec8\u5bfc\u81f4\u6574\u4e2a\u4ed3\u5e93\u6ca1\u6709\u53ef\u7528\u7684\u50a8\u7269\u67dc\u3002"}),"\n",(0,r.jsxs)(n.p,{children:["\u8fd9\u5c31\u662f ",(0,r.jsx)(n.code,{children:"Netty"})," \u4e2d\u7684\u5185\u5b58\u6cc4\u6f0f\u2014\u2014\u5fd8\u8bb0\u91ca\u653e\u901a\u8fc7\u5185\u5b58\u6c60\u7533\u8bf7\u7684",(0,r.jsx)(n.code,{children:"ByteBuf"}),"\u3002"]}),"\n",(0,r.jsx)(n.h2,{id:"\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u6838\u5fc3\u5b9e\u73b0",children:"\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u6838\u5fc3\u5b9e\u73b0"}),"\n",(0,r.jsxs)(n.p,{children:["\u4e3a\u4e86\u5e2e\u52a9\u5f00\u53d1\u8005\u5feb\u901f\u5b9a\u4f4d\u8fd9\u4e9b\u201c\u6709\u501f\u65e0\u8fd8\u201d\u7684",(0,r.jsx)(n.code,{children:"ByteBuf"}),"\uff0cNetty \u63d0\u4f9b\u4e86\u4e00\u4e2a\u5f3a\u5927\u7684\u5185\u7f6e\u5de5\u5177\u2014\u2014",(0,r.jsx)(n.code,{children:"ResourceLeakDetector"}),"\uff08\u8d44\u6e90\u6cc4\u6f0f\u68c0\u6d4b\u5668\uff09"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"ResourceLeakDetector"}),"\u7684\u6838\u5fc3\u539f\u7406\u5c31\u662f\u901a\u8fc7",(0,r.jsx)(n.code,{children:"DefaultResourceLeak"})," (\u5f31\u5f15\u7528)\u5b9e\u73b0\u7684"]}),"\n",(0,r.jsx)(n.h3,{id:"\u521b\u5efabytebuf\u5e76\u8fdb\u884c\u5305\u88c5\u8ddf\u8e2a",children:"\u521b\u5efaByteBuf\u5e76\u8fdb\u884c\u5305\u88c5\u8ddf\u8e2a"}),"\n",(0,r.jsxs)(n.p,{children:["\u5f53\u4e00\u4e2a\u88ab\u6c60\u5316\u7684",(0,r.jsx)(n.code,{children:"ByteBuf"})," \u88ab\u521b\u5efa\u65f6\uff0c",(0,r.jsx)(n.code,{children:"ResourceLeakDetector"})," \u4f1a\u4e3a\u5b83\u521b\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7684\u201c\u54e8\u5175\u201d\u2014\u2014",(0,r.jsx)(n.code,{children:"DefaultResourceLeak"}),"\uff08\u5f31\u5f15\u7528\uff09\uff0c\u5e76\u5c06\u8fd9\u4e2a\u201c\u54e8\u5175\u201d\u6ce8\u518c\u5230\u4e00\u4e2a\u76d1\u63a7\u961f\u5217\uff08ReferenceQueue\uff09\u4e2d"]}),"\n",(0,r.jsxs)(n.p,{children:["\u6bd4\u5982\u6211\u4eec\u901a\u8fc7",(0,r.jsx)(n.code,{children:"PooledByteBufAllocator"}),"\u521b\u5efa",(0,r.jsx)(n.code,{children:"ByteBuf"}),"\u5bf9\u8c61\u7684\u65f6\u5019\u90fd\u4f1a\u8c03\u7528",(0,r.jsx)(n.code,{children:"toLeakAwareBuffer"}),"\u65b9\u6cd5\uff0c\u5c06",(0,r.jsx)(n.code,{children:"AbstractByteBuf"}),"\u8fdb\u884c\u5305\u88c5",(0,r.jsx)(n.code,{children:"XXLeakAwareByteBuf"}),"(",(0,r.jsx)(n.code,{children:"SimpleLeakAwareByteBuf"}),"\u6216",(0,r.jsx)(n.code,{children:"AdvancedLeakAwareByteBuf"}),")"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"    @Override\n    protected ByteBuf newHeapBuffer(int initialCapacity, int maxCapacity) {\n        PoolThreadCache cache = threadCache.get();\n        PoolArena<byte[]> heapArena = cache.heapArena;\n\n        final AbstractByteBuf buf;\n        if (heapArena != null) {\n            buf = heapArena.allocate(cache, initialCapacity, maxCapacity);\n        } else {\n            buf = PlatformDependent.hasUnsafe() ?\n                    new UnpooledUnsafeHeapByteBuf(this, initialCapacity, maxCapacity) :\n                    new UnpooledHeapByteBuf(this, initialCapacity, maxCapacity);\n            onAllocateBuffer(buf, false, false);\n        }\n        return toLeakAwareBuffer(buf);\n    }\n\n    @Override\n    protected ByteBuf newDirectBuffer(int initialCapacity, int maxCapacity) {\n        PoolThreadCache cache = threadCache.get();\n        PoolArena<ByteBuffer> directArena = cache.directArena;\n\n        final AbstractByteBuf buf;\n        if (directArena != null) {\n            buf = directArena.allocate(cache, initialCapacity, maxCapacity);\n        } else {\n            buf = PlatformDependent.hasUnsafe() ?\n                    UnsafeByteBufUtil.newUnsafeDirectByteBuf(this, initialCapacity, maxCapacity) :\n                    new UnpooledDirectByteBuf(this, initialCapacity, maxCapacity);\n            onAllocateBuffer(buf, false, false);\n        }\n        return toLeakAwareBuffer(buf);\n    }\n\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u800c",(0,r.jsx)(n.code,{children:"toLeakAwareBuffer(buf)"}),"\u65b9\u6cd5\u5b9e\u9645\u8c03\u7528\u7684\u5c31\u662f",(0,r.jsx)(n.code,{children:"ResourceLeakDetector.track(T obj)"}),"\u65b9\u6cd5\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u5bf9",(0,r.jsx)(n.code,{children:"buf"}),"\u8fdb\u884c\u5305\u88c5\u7684\u903b\u8f91\u5b9e\u9645\u5728",(0,r.jsx)(n.code,{children:"track(T obj)"}),"\u65b9\u6cd5"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"    protected static ByteBuf toLeakAwareBuffer(ByteBuf buf) {\n        ResourceLeakTracker<ByteBuf> leak;\n        switch (ResourceLeakDetector.getLevel()) {\n            case SIMPLE:\n                leak = AbstractByteBuf.leakDetector.track(buf);\n                if (leak != null) {\n                    buf = new SimpleLeakAwareByteBuf(buf, leak);\n                }\n                break;\n            case ADVANCED:\n            case PARANOID:\n                leak = AbstractByteBuf.leakDetector.track(buf);\n                if (leak != null) {\n                    buf = new AdvancedLeakAwareByteBuf(buf, leak);\n                }\n                break;\n            default:\n                break;\n        }\n        return buf;\n    }\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u8fd9\u91cc\u6839\u636e\u4e0d\u540c\u7684\u91c7\u6837\u7387\u8fd4\u56de\u7684\u53ef\u80fd\u662f",(0,r.jsx)(n.code,{children:"SimpleLeakAwareByteBuf"}),"\u6216\u8005",(0,r.jsx)(n.code,{children:"AdvancedLeakAwareByteBuf"})]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"AdvancedLeakAwareByteBuf"}),"\u5bf9\u8c61\u662f\u7ee7\u627f",(0,r.jsx)(n.code,{children:"SimpleLeakAwareByteBuf"}),"\u7684"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"SimpleLeakAwareByteBuf"}),"\u4e2d\u6709\u6709\u4e00\u4e2a\u5c5e\u6027",(0,r.jsx)(n.code,{children:"ResourceLeakTracker<ByteBuf> leak"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'class SimpleLeakAwareByteBuf extends WrappedByteBuf {\n   // \u9700\u8981\u88ab\u63a2\u6d4b\u7684\u666e\u901a  ByteBuf\n   private final ByteBuf trackedByteBuf;\n   // ByteBuf \u7684\u5f31\u5f15\u7528 DefaultResourceLeak\n   final ResourceLeakTracker<ByteBuf> leak;\n\n   SimpleLeakAwareByteBuf(ByteBuf wrapped, ResourceLeakTracker<ByteBuf> leak) {\n        this(wrapped, wrapped, leak);\n    }\n\n   SimpleLeakAwareByteBuf(ByteBuf wrapped, ByteBuf trackedByteBuf, ResourceLeakTracker<ByteBuf> leak) {\n        super(wrapped);\n        this.trackedByteBuf = ObjectUtil.checkNotNull(trackedByteBuf, "trackedByteBuf");\n        this.leak = ObjectUtil.checkNotNull(leak, "leak");\n    }\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"leak"}),"\u662f",(0,r.jsx)(n.code,{children:"ByteBuf"})," \u7684\u5f31\u5f15\u7528,\u56e0\u4e3a",(0,r.jsx)(n.code,{children:"ResourceLeakTracker"}),"\u63a5\u53e3\u7684\u9ed8\u8ba4\u5b9e\u73b0\u662f",(0,r.jsx)(n.code,{children:"DefaultResourceLeak"}),"\uff0c\u7ee7\u627f\u4e86",(0,r.jsx)(n.code,{children:"WeakReference"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"    private static final class DefaultResourceLeak<T>\n            extends WeakReference<Object> implements ResourceLeakTracker<T>, ResourceLeak \n"})}),"\n",(0,r.jsx)(n.h3,{id:"bytebuf\u6b63\u5e38\u91ca\u653e",children:"ByteBuf\u6b63\u5e38\u91ca\u653e"}),"\n",(0,r.jsxs)(n.p,{children:["\u5f53\u8fd9\u4e2a",(0,r.jsx)(n.code,{children:"ByteBuf"}),"\u4f7f\u7528\u5b8c\u6210\u540e\u4f1a\u8c03\u7528",(0,r.jsx)(n.code,{children:"release"}),"\u8fdb\u884c\u91ca\u653e,",(0,r.jsx)(n.code,{children:"release"}),"\u65b9\u6cd5\u4f1a\u8c03\u7528",(0,r.jsx)(n.code,{children:"closeLeak"}),"\u65b9\u6cd5\u5173\u95ed\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"    @Override\n    public boolean release(int decrement) {\n        // // \u5f15\u7528\u8ba1\u6570\u4e3a 0 \n        if (super.release(decrement)) {\n            // \u5173\u95ed\u5185\u5b58\u6cc4\u9732\u7684\u63a2\u6d4b\n            closeLeak();\n            return true;\n        }\n        return false;\n    }\n\n    private void closeLeak() {\n        // Close the ResourceLeakTracker with the tracked ByteBuf as argument. This must be the same that was used when\n        // calling DefaultResourceLeak.track(...).\n        boolean closed = leak.close(trackedByteBuf);\n        assert closed;\n    }\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u6211\u4eec\u6765\u770b\u770b",(0,r.jsx)(n.code,{children:"close"}),"\u65b9\u6cd5\u5177\u4f53\u505a\u4e86\u4ec0\u4e48"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"io.netty.util.ResourceLeakDetector.DefaultResourceLeak#close()"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"        @Override\n        public boolean close() {\n            if (allLeaks.remove(this)) {\n                // Call clear so the reference is not even enqueued.\n                clear();\n                headUpdater.set(this, null);\n                return true;\n            }\n            return false;\n        }\n"})}),"\n",(0,r.jsxs)(n.p,{children:["close\u5c31\u662f\u5c06",(0,r.jsx)(n.code,{children:"DefaultResourceLeak"})," \u4ece",(0,r.jsx)(n.code,{children:"allLeaks"})," \u96c6\u5408\u4e2d\u5220\u9664\uff0c\u56e0\u4e3a",(0,r.jsx)(n.code,{children:"allLeaks"})," \u4e2d\u4fdd\u5b58\u7684\u5168\u90e8\u90fd\u662f\u672a\u88ab\u91ca\u653e\u7684",(0,r.jsx)(n.code,{children:"trackedByteBuf"})," \u5bf9\u5e94\u7684 ",(0,r.jsx)(n.code,{children:"DefaultResourceLeak "})]}),"\n",(0,r.jsxs)(n.p,{children:["\u7136\u540e\u8c03\u7528",(0,r.jsx)(n.code,{children:"io.netty.util.ResourceLeakDetector.DefaultResourceLeak#close()"}),"\u65ad\u5f00 ",(0,r.jsx)(n.code,{children:"DefaultResourceLeak"})," \u4e0e ",(0,r.jsx)(n.code,{children:"trackedByteBuf"})," \u7684\u5f31\u5f15\u7528\u5173\u8054"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"clone"}),"\u65b9\u6cd5\u4e2d\u7684",(0,r.jsx)(n.code,{children:"clear"}),"\u5b9e\u9645\u8fd8\u662f\u8c03\u7528\u7684",(0,r.jsx)(n.code,{children:"java.lang.ref.Reference#clear"}),"\u65b9\u6cd5"]}),"\n",(0,r.jsxs)(n.p,{children:["\u65ad\u5f00\u5f31\u5f15\u7528\u5173\u8054\u540e\uff0c\u5f53  ",(0,r.jsx)(n.code,{children:"trackedByteBuf"})," \u88ab GC \u4e4b\u540e\uff0cJVM \u5c06\u4e0d\u4f1a\u628a ",(0,r.jsx)(n.code,{children:"DefaultResourceLeak"})," \u653e\u5165\u5230  ",(0,r.jsx)(n.code,{children:"_reference_pending_list"})," \u4e2d"]}),"\n",(0,r.jsxs)(n.p,{children:["\u4f1a\u5c06 ",(0,r.jsx)(n.code,{children:"DefaultResourceLeak"})," \u4e0e ",(0,r.jsx)(n.code,{children:"trackedByteBuf"})," \u4e00\u8d77\u56de\u6536\u3002\u8fd9\u6837\u4e00\u6765\uff0c",(0,r.jsx)(n.code,{children:"refQueue"})," \u4e2d\u4e0d\u4f1a\u51fa\u73b0\u8fd9\u4e2a ",(0,r.jsx)(n.code,{children:"DefaultResourceLeak"})," \uff0c",(0,r.jsx)(n.code,{children:"ResourceLeakDetector"})," \u4e5f\u5c31\u4e0d\u4f1a\u9519\u8bef\u5730\u63a2\u6d4b\u5230\u5b83\u4e86"]}),"\n",(0,r.jsx)(n.h3,{id:"bytebuf\u975e\u6b63\u5e38\u91ca\u653e\u5185\u5b58\u6cc4\u6f0f",children:"ByteBuf\u975e\u6b63\u5e38\u91ca\u653e(\u5185\u5b58\u6cc4\u6f0f)"}),"\n",(0,r.jsxs)(n.p,{children:["\u5982\u679c",(0,r.jsx)(n.code,{children:"SimpleLeakAwareByteBuf"}),"\u5fd8\u8bb0\u91ca\u653e\uff0c\u90a3\u4e48\u5b83\u5bf9\u5e94\u7684",(0,r.jsx)(n.code,{children:"DefaultResourceLeak"})," \u5c31\u4f1a\u4e00\u76f4\u505c\u7559\u5728",(0,r.jsx)(n.code,{children:"allLeaks"})," \u96c6\u5408\u4e2d"]}),"\n",(0,r.jsxs)(n.p,{children:["\u5f53 ",(0,r.jsx)(n.code,{children:"SimpleLeakAwareByteBuf"})," \u88ab GC \u4e4b\u540e\uff0cJVM \u5c31\u4f1a\u5c06 ",(0,r.jsx)(n.code,{children:"DefaultResourceLeak"})," \u653e\u5165\u5230 ",(0,r.jsx)(n.code,{children:"_reference_pending_list"})," \u4e2d"]}),"\n",(0,r.jsxs)(n.p,{children:["\u968f\u540e\u5524\u9192",(0,r.jsx)(n.code,{children:"ReferenceHandler"})," \u7ebf\u7a0b\u5c06 ",(0,r.jsx)(n.code,{children:"DefaultResourceLeak"})," \u4ece ",(0,r.jsx)(n.code,{children:"_reference_pending_list"})," \u4e2d\u8f6c\u79fb\u5230 ",(0,r.jsx)(n.code,{children:"refQueue"})]}),"\n",(0,r.jsxs)(n.p,{children:["\u5f53\u4e0b\u4e00\u6b21\u5185\u5b58\u5206\u914d\u7684\u65f6\u5019\uff0c\u5982\u679c\u547d\u4e2d\u5185\u5b58\u6cc4\u9732\u91c7\u6837\u68c0\u6d4b\u7684\u6982\u7387\uff0c\u90a3\u4e48 ",(0,r.jsx)(n.code,{children:"ResourceLeakDetector"})," \u5c31\u4f1a\u4ece ",(0,r.jsx)(n.code,{children:"refQueue"})," \u4e2d\u5c06\u6536\u96c6\u5230\u7684\u6240\u6709 ",(0,r.jsx)(n.code,{children:"DefaultResourceLeak"})," \u6328\u4e2a\u6458\u4e0b\uff0c\u5e76\u5224\u65ad\u5b83\u4eec\u662f\u5426\u4ecd\u7136\u505c\u7559\u5728 ",(0,r.jsx)(n.code,{children:"allLeaks"})," \u4e2d\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u5982\u679c\u4ecd\u7136\u5728 ",(0,r.jsx)(n.code,{children:"allLeaks"})," \u4e2d\uff0c\u5c31\u8bf4\u660e\u8be5  ",(0,r.jsx)(n.code,{children:"DefaultResourceLeak"})," \u5bf9\u5e94\u7684 ",(0,r.jsx)(n.code,{children:"ByteBuf"})," \u53d1\u751f\u4e86\u5185\u5b58\u6cc4\u9732\uff0c\u800c\u5177\u4f53\u7684\u6cc4\u9732\u8def\u5f84\u5c31\u4fdd\u5b58\u5728 ",(0,r.jsx)(n.code,{children:"DefaultResourceLeak"})," \u6808\u4e2d\uff0c\u6700\u540e\u5c06\u6cc4\u9732\u8def\u5f84\u4ee5 ",(0,r.jsx)(n.code,{children:"ERROR"})," \u7684\u65e5\u5fd7\u7ea7\u522b\u6253\u5370\u51fa\u6765\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"    private void reportLeak() {\n        if (!needReport()) {\n            clearRefQueue();\n            return;\n        }\n\n        // Detect and report previous leaks.\n        for (;;) {\n            DefaultResourceLeak ref = (DefaultResourceLeak) refQueue.poll();\n            if (ref == null) {\n                break;\n            }\n\n            if (!ref.dispose()) {\n                continue;\n            }\n\n            // \u5f53\u63a2\u6d4b\u5230 ByteBuf \u53d1\u751f\u5185\u5b58\u6cc4\u9732\u4e4b\u540e\uff0c\u8fd9\u91cc\u4f1a\u83b7\u53d6 ByteBuf \u76f8\u5173\u7684\u8bbf\u95ee\u5806\u6808 \n            String records = ref.getReportAndClearRecords();\n            if (reportedLeaks.add(records)) {\n                if (records.isEmpty()) {\n                    reportUntracedLeak(resourceType);\n                } else {\n                    reportTracedLeak(resourceType, records);\n                }\n\n                LeakListener listener = leakListener;\n                if (listener != null) {\n                    listener.onLeak(resourceType, records);\n                }\n            }\n        }\n    }\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"WeakReference"}),"(\u5f31\u5f15\u7528)+ ",(0,r.jsx)(n.code,{children:"ReferenceQueue"}),"(\u5f15\u7528\u961f\u5217)\u662f\u5f88\u5e38\u89c1\u7684\u8d44\u6e90\u56de\u6536\u4f7f\u7528\u65b9\u5f0f"]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"WeakReference"}),"(\u5f31\u5f15\u7528)+ \u6216\u8005 ",(0,r.jsx)(n.code,{children:"PhantomReference"}),"(\u865a\u5f15\u7528)\u90fd\u53ef\u4ee5\u5b9e\u73b0\u8d44\u6e90\u56de\u6536\uff0c\u4e24\u8005\u6709\u4ec0\u4e48\u533a\u522b\u5462\uff1f\n\u611f\u5174\u8da3\u53ef\u4ee5\u81ea\u5df1\u767e\u5ea6\u641c\u7d22"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u4f7f\u7528",children:"\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u4f7f\u7528"}),"\n",(0,r.jsx)(n.p,{children:"Netty\u5982\u679c\u60f3\u8981\u5f00\u542f\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u53ea\u9700\u8981\u4f7f\u7528\u5982\u4e0b\u4ee3\u7801"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u4ee3\u7801\u4e2d\u8bbe\u7f6e"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"        ResourceLeakDetector.setLevel(ResourceLeakDetector.Level.PARANOID);\n\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"\u7cfb\u7edf\u5c5e\u6027\u8bbe\u7f6e"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'        System.setProperty("io.netty.leakDetection.level", "PARANOID");\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"JVM\u542f\u52a8\u53c2\u6570"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"-Dio.netty.leakDetection.level=paranoid\n"})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"\u8fd9\u662f\u6700\u63a8\u8350\u7684\u65b9\u5f0f\uff0c\u56e0\u4e3a\u5b83\u65e0\u9700\u4fee\u6539\u4ee3\u7801\uff0c\u53ef\u4ee5\u7075\u6d3b\u5730\u5728\u4e0d\u540c\u73af\u5883\u4e2d\u5f00\u542f\u6216\u5173\u95ed"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u9891\u7387",children:"\u9891\u7387"}),"\n",(0,r.jsx)(n.p,{children:"\u5185\u5b58\u6cc4\u6f0f\u7684\u91c7\u6837\u95f4\u9694\u662f128.\u610f\u5473\u7740\u5927\u7ea6\u6bcf 128 \u4e2a\u5bf9\u8c61\u4e2d\u4f1a\u6311\u9009 1 \u4e2a\u8fdb\u884c\u76d1\u63a7\u3002"}),"\n",(0,r.jsxs)(n.p,{children:["\u53ef\u4ee5\u901a\u8fc7 JVM \u53c2\u6570 ",(0,r.jsx)(n.code,{children:"-Dio.netty.leakDetection.samplingInterval"})," \u6765\u8bbe\u7f6e\u5185\u5b58\u6cc4\u9732\u63a2\u6d4b\u7684\u91c7\u6837\u95f4\u9694"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'public class ResourceLeakDetector<T> {\n\n  static final int SAMPLING_INTERVAL;\n\n  private static final String PROP_SAMPLING_INTERVAL = "io.netty.leakDetection.samplingInterval";\n\n  private static final int DEFAULT_SAMPLING_INTERVAL = 128;\n\n  SAMPLING_INTERVAL = SystemPropertyUtil.getInt(PROP_SAMPLING_INTERVAL, DEFAULT_SAMPLING_INTERVAL);\n}\n\n'})}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:"PARANOID \u7ea7\u522b\u5219\u4f1a\u65e0\u89c6\u8fd9\u4e2a\u95f4\u9694\uff0c\u5bf9\u6bcf\u4e00\u4e2a\u5bf9\u8c61\u90fd\u8fdb\u884c\u76d1\u63a7"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u7b49\u7ea7",children:"\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u7b49\u7ea7"}),"\n",(0,r.jsxs)(n.p,{children:["\u4e3b\u8981\u662f\u901a\u8fc7",(0,r.jsx)(n.code,{children:"ResourceLeakDetector.Level"}),"\u8fd9\u4e2a\u679a\u4e3e\u63a7\u5236\u7684"]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{style:{textAlign:"center"},children:"\u7b49\u7ea7"}),(0,r.jsx)(n.th,{style:{textAlign:"center"},children:"\u8bf4\u660e"}),(0,r.jsx)(n.th,{style:{textAlign:"center"},children:"\u91c7\u6837\u7387"}),(0,r.jsx)(n.th,{style:{textAlign:"center"},children:"\u6027\u80fd\u5f71\u54cd"}),(0,r.jsx)(n.th,{style:{textAlign:"center"},children:"\u9002\u7528\u573a\u666f"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"DISABLED"}),(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"\u5b8c\u5168\u5173\u95ed\u6cc4\u6f0f\u68c0\u6d4b\u529f\u80fd"}),(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"0%"}),(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"\u65e0"}),(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"\u751f\u4ea7\u73af\u5883\u4e2d\u5bf9\u6027\u80fd\u6709\u6781\u9ad8\u8981\u6c42\uff0c\u4e14\u786e\u4fe1\u6ca1\u6709\u5185\u5b58\u6cc4\u6f0f\u95ee\u9898"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"SIMPLE"}),(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"\u4ec5\u62a5\u544a\u662f\u5426\u53d1\u751f\u4e86\u6cc4\u6f0f\uff0c\u4e0d\u63d0\u4f9b\u8be6\u7ec6\u7684\u521b\u5efa\u548c\u6cc4\u6f0f\u4f4d\u7f6e"}),(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"1%"}),(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"\u6781\u5c0f"}),(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"\u751f\u4ea7\u73af\u5883\u4e2d\u9700\u8981\u57fa\u672c\u6cc4\u6f0f\u68c0\u6d4b\u4f46\u53c8\u4e0d\u5e0c\u671b\u5f71\u54cd\u6027\u80fd"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"ADVANCED"}),(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"\u62a5\u544a\u6cc4\u6f0f\u5e76\u63d0\u4f9b\u8d44\u6e90\u521b\u5efa\u65f6\u7684\u5806\u6808\u8ddf\u8e2a\u4fe1\u606f"}),(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"1%"}),(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"\u5c0f"}),(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"\u9ed8\u8ba4\u8bbe\u7f6e\uff0c\u9002\u5408\u5927\u591a\u6570\u751f\u4ea7\u73af\u5883"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"PARANOID"}),(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"\u62a5\u544a\u6cc4\u6f0f\u5e76\u63d0\u4f9b\u5b8c\u6574\u7684\u5806\u6808\u8ddf\u8e2a\u4fe1\u606f"}),(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"100%"}),(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"\u663e\u8457"}),(0,r.jsx)(n.td,{style:{textAlign:"center"},children:"\u5f00\u53d1\u548c\u6d4b\u8bd5\u73af\u5883\uff0c\u7279\u522b\u662f\u5728\u8c03\u8bd5\u5185\u5b58\u6cc4\u6f0f\u95ee\u9898\u65f6"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"\u6d4b\u8bd5\u9a8c\u8bc1",children:"\u6d4b\u8bd5\u9a8c\u8bc1"}),"\n",(0,r.jsx)(n.h3,{id:"\u6cc4\u6f0f\u9a8c\u8bc1",children:"\u6cc4\u6f0f\u9a8c\u8bc1"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'    public static final int _1MB = 1024 * 1024;\n    public static final int _17MB = 17 * _1MB;\n\n    private ScheduledExecutorService scheduledExecutorService;\n\n    @BeforeEach\n    public void init() {\n        ResourceLeakDetector.setLevel(ResourceLeakDetector.Level.PARANOID);\n\n        // \u521b\u5efa\u5b9a\u65f6\u4efb\u52a1\u76d1\u63a7\u76f4\u63a5\u5185\u5b58\u4f7f\u7528\u60c5\u51b5\n        scheduledExecutorService = Executors.newSingleThreadScheduledExecutor();\n        scheduledExecutorService.scheduleAtFixedRate(() -> {\n            // \u6ce8\u610f: \u5bf9\u4e8e\u6c60\u5316\u5206\u914d\u5668\uff0crelease()\u53ea\u662f\u5c06\u5185\u5b58\u5f52\u8fd8\u5230\u6c60\u4e2d\uff0c\u4e0d\u4ee3\u8868\u603b\u5185\u5b58\u4f1a\u7acb\u5373\u4e0b\u964d\n            String s = PooledByteBufAllocator.DEFAULT.metric().toString();\n            System.out.println("---[\u76d1\u63a7] Netty \u5185\u5b58\u6c60\u72b6\u6001: " + s + " ---");\n        }, 0, 1, TimeUnit.SECONDS);\n    }\n\n    @AfterEach\n    public void cleanup() {\n        // \u6d4b\u8bd5\u7ed3\u675f\u540e\u5173\u95ed\u8c03\u5ea6\u5668\n        if (scheduledExecutorService != null && !scheduledExecutorService.isShutdown()) {\n            scheduledExecutorService.shutdown();\n            try {\n                if (!scheduledExecutorService.awaitTermination(2, TimeUnit.SECONDS)) {\n                    scheduledExecutorService.shutdownNow();\n                }\n            } catch (InterruptedException e) {\n                scheduledExecutorService.shutdownNow();\n                Thread.currentThread().interrupt();\n            }\n        }\n    }\n\n    /**\n     * \u7edf\u4e00\u7684ByteBuf\u5206\u914d\u65b9\u6cd5\n     */\n    private ByteBuf allocate(int capacity) {\n        System.out.println("--\x3e \u5f00\u59cb\u5206\u914dByteBuf (" + capacity / _1MB + "MB)");\n        ByteBuf buffer = PooledByteBufAllocator.DEFAULT.directBuffer(capacity, Integer.MAX_VALUE);\n        System.out.println("--\x3e \u6210\u529f\u5206\u914dByteBuf: " + buffer);\n        return buffer;\n    }\n\n\n    @Test\n    public void testLeak_ShouldReportLeak() throws InterruptedException {\n        for (int i = 0; i < 5; i++) {\n            System.out.println("\\n--- \u7b2c" + (i + 1) + "\u6b21\u5206\u914d ---");\n            // \u5206\u914d\u540e\uff0cbuf\u53d8\u91cf\u5728\u5faa\u73af\u7ed3\u675f\u540e\u5c31\u5931\u53bb\u5f15\u7528\uff0cGC\u4f1a\u56de\u6536\u5b83\n            // \u7531\u4e8e\u6ca1\u6709release\uff0cResourceLeakDetector\u4f1a\u62a5\u544a\u6cc4\u6f0f\n            ByteBuf buf = allocate(_17MB);\n            System.gc();\n            TimeUnit.SECONDS.sleep(1);\n        }\n    }\n\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u8fd0\u884c\u6d4b\u8bd5\u7528\u4f8b\u4f1a\u6253\u5370\u5982\u4e0b\u4fe1\u606f"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:"22:12:06.055 [main] ERROR io.netty.util.ResourceLeakDetector - LEAK: ByteBuf.release() was not called before it's garbage-collected. See https://netty.io/wiki/reference-counted-objects.html for more information.\nRecent access records: \nCreated at:\n\tio.netty.buffer.PooledByteBufAllocator.newDirectBuffer(PooledByteBufAllocator.java:402)\n\tio.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:187)\n\tcom.xiaozou.MyLeakTest.allocate(MyLeakTest.java:59)\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u53ef\u4ee5\u770b\u5230\u51fa\u73b0\u5185\u5b58\u6cc4\u6f0f\u540e\u6253\u5370\u4e86\u5b8c\u6574\u7684\u5806\u6808\u4fe1\u606f"}),"\n",(0,r.jsx)(n.h3,{id:"\u6b63\u5e38\u9a8c\u8bc1",children:"\u6b63\u5e38\u9a8c\u8bc1"}),"\n",(0,r.jsxs)(n.p,{children:["\u5982\u679c\u6211\u4eec\u6b63\u5e38\u91ca\u653e",(0,r.jsx)(n.code,{children:"ByteBuf"}),"\uff0c\u5219\u4e0d\u4f1a\u6253\u5370\u5185\u5b58\u6cc4\u6f0flog"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-java",children:'    @Test\n    public void testLeak_ShouldReleaseCorrectly() throws InterruptedException {\n        System.out.println("=== \u6d4b\u8bd5\u573a\u666f2: \u6b63\u786e\u91ca\u653eByteBuf (\u4e0d\u671f\u671b\u770b\u5230LEAK\u65e5\u5fd7) ===");\n        for (int i = 0; i < 5; i++) {\n            System.out.println("\\n--- \u7b2c" + (i + 1) + "\u6b21\u5206\u914d\u5e76\u91ca\u653e ---");\n            ByteBuf buf = allocate(_17MB);\n            System.out.println("\u91ca\u653eByteBuf: " + buf);\n            buf.release(); // \u6b63\u786e\u91ca\u653e\u8d44\u6e90\n        }\n\n        System.out.println("\\n\u5206\u914d\u548c\u91ca\u653e\u5b8c\u6210\uff0c\u7b49\u5f85\u89c2\u5bdf\u5185\u5b58\u60c5\u51b5...");\n        System.gc();\n        TimeUnit.SECONDS.sleep(3);\n    }\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"Netty"}),"\u7684\u5185\u5b58\u68c0\u6d4b\u673a\u5236\u9700\u8981\u624b\u52a8\u901a\u8fc7\u53c2\u6570",(0,r.jsx)(n.code,{children:"-Dio.netty.leakDetection.level=paranoid"}),"\u5f00\u542f\u8bbe\u7f6e\u68c0\u6d4b\u7b49\u7ea7"]}),"\n",(0,r.jsxs)(n.p,{children:["\u5185\u5b58\u6cc4\u6f0f\u68c0\u6d4b\u5fc5\u987b\u7b49\u5230",(0,r.jsx)(n.code,{children:"ByteBuf"})," \u88ab GC \u4e4b\u540e\uff0c\u5185\u5b58\u6cc4\u9732\u624d\u80fd\u63a2\u6d4b\u7684\u5230"]}),"\n",(0,r.jsx)(n.h2,{id:"\u53c2\u8003",children:"\u53c2\u8003"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://www.cnblogs.com/binlovetech/p/18531611",children:"https://www.cnblogs.com/binlovetech/p/18531611"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}},28453(e,n,t){t.d(n,{R:()=>a,x:()=>s});var c=t(96540);const r={},l=c.createContext(r);function a(e){const n=c.useContext(l);return c.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),c.createElement(l.Provider,{value:n},e.children)}}}]);