"use strict";(self.webpackChunkweihubeats_website=self.webpackChunkweihubeats_website||[]).push([[1945],{1487:(e,n,i)=>{i.d(n,{A:()=>r});const r=i.p+"assets/images/TimeWheel-pipeline-0f20ee2d53c4bebe874d06c92bcb0a95.png"},4994:(e,n,i)=>{i.d(n,{A:()=>r});const r=i.p+"assets/images/TimerLog-TimeWheel-de-23b0e61323fefc25534af8cc3c21f2f8.png"},6599:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>u});const r=JSON.parse('{"id":"MQ/RocketMQ/\u6e90\u7801\u5206\u6790/RocketMQ 5.x\u4efb\u610f\u5ef6\u65f6\u6d88\u606f\u6e90\u7801\u5206\u6790","title":"RocketMQ 5.x\u4efb\u610f\u5ef6\u65f6\u6d88\u606f\u6e90\u7801\u5206\u6790","description":"\u8fd9\u91cc\u662f\u5c0f\u594f,\u89c9\u5f97\u6587\u7ae0\u4e0d\u9519\u53ef\u4ee5\u5173\u6ce8\u516c\u4f17\u53f7\u5c0f\u594f\u6280\u672f\uff0c\u6587\u7ae0\u9996\u53d1\u3002\u62d2\u7edd\u8425\u9500\u53f7\uff0c\u62d2\u7edd\u6807\u9898\u515a","source":"@site/docs/MQ/RocketMQ/\u6e90\u7801\u5206\u6790/RocketMQ 5.x\u4efb\u610f\u5ef6\u65f6\u6d88\u606f\u6e90\u7801\u5206\u6790.md","sourceDirName":"MQ/RocketMQ/\u6e90\u7801\u5206\u6790","slug":"/MQ/RocketMQ/\u6e90\u7801\u5206\u6790/RocketMQ 5.x\u4efb\u610f\u5ef6\u65f6\u6d88\u606f\u6e90\u7801\u5206\u6790","permalink":"/docs/MQ/RocketMQ/\u6e90\u7801\u5206\u6790/RocketMQ 5.x\u4efb\u610f\u5ef6\u65f6\u6d88\u606f\u6e90\u7801\u5206\u6790","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/MQ/RocketMQ/\u6e90\u7801\u5206\u6790/RocketMQ 5.x\u4efb\u610f\u5ef6\u65f6\u6d88\u606f\u6e90\u7801\u5206\u6790.md","tags":[],"version":"current","frontMatter":{},"sidebar":"RocketMQ","previous":{"title":"RocketMQ\u7a33\u5b9a\u6027\u4fdd\u969c","permalink":"/docs/MQ/RocketMQ/\u6700\u4f73\u5b9e\u8df5/RocketMQ\u7a33\u5b9a\u6027\u4fdd\u969c"},"next":{"title":"RocketMQ 5.x\u56fa\u5b9a\u7b49\u7ea7\u5ef6\u65f6\u6d88\u606f\u6e90\u7801\u5206\u6790","permalink":"/docs/MQ/RocketMQ/\u6e90\u7801\u5206\u6790/RocketMQ 5.x\u56fa\u5b9a\u7b49\u7ea7\u5ef6\u65f6\u6d88\u606f\u6e90\u7801\u5206\u6790"}}');var t=i(4848),s=i(8453);const l={},c=void 0,d={},u=[{value:"RocketMQ\u7248\u672c",id:"rocketmq\u7248\u672c",level:2},{value:"\u80cc\u666f",id:"\u80cc\u666f",level:2},{value:"\u4f7f\u7528",id:"\u4f7f\u7528",level:2},{value:"\u56fa\u5b9a\u5ef6\u65f6\u6d88\u606f",id:"\u56fa\u5b9a\u5ef6\u65f6\u6d88\u606f",level:3},{value:"\u4efb\u610f\u65f6\u95f4\u5ef6\u65f6\u6d88\u606f",id:"\u4efb\u610f\u65f6\u95f4\u5ef6\u65f6\u6d88\u606f",level:3},{value:"\u652f\u6301\u5ef6\u65f6\u6d88\u606f\u65f6\u95f4\u9650\u5236",id:"\u652f\u6301\u5ef6\u65f6\u6d88\u606f\u65f6\u95f4\u9650\u5236",level:4},{value:"\u4f7f\u7528\u65b9\u5f0f",id:"\u4f7f\u7528\u65b9\u5f0f",level:4},{value:"\u4e3a\u4ec0\u4e484.x\u4e00\u76f4\u4e0d\u652f\u6301\u4efb\u610f\u65f6\u95f4\u7684\u5ef6\u65f6\u6d88\u606f",id:"\u4e3a\u4ec0\u4e484x\u4e00\u76f4\u4e0d\u652f\u6301\u4efb\u610f\u65f6\u95f4\u7684\u5ef6\u65f6\u6d88\u606f",level:2},{value:"\u8bbe\u8ba1\u76ee\u6807",id:"\u8bbe\u8ba1\u76ee\u6807",level:2},{value:"\u8bbe\u8ba1\u601d\u8def",id:"\u8bbe\u8ba1\u601d\u8def",level:2},{value:"\u8be6\u7ec6\u5b9e\u73b0",id:"\u8be6\u7ec6\u5b9e\u73b0",level:2},{value:"\u5b58\u50a8",id:"\u5b58\u50a8",level:3},{value:"TimerWheel",id:"timerwheel",level:4},{value:"TimerLog",id:"timerlog",level:4},{value:"\u65b0\u7684pipeline\u5b9e\u73b0",id:"\u65b0\u7684pipeline\u5b9e\u73b0",level:2},{value:"TimerEnqueueGetService \u626b\u63cf\u5b9a\u65f6\u6d88\u606f",id:"timerenqueuegetservice-\u626b\u63cf\u5b9a\u65f6\u6d88\u606f",level:3},{value:"TimerEnqueuePutService \u5c06\u5b9a\u65f6\u6d88\u606f\u653e\u5165\u65f6\u95f4\u8f6e\u548c TimerLog",id:"timerenqueueputservice-\u5c06\u5b9a\u65f6\u6d88\u606f\u653e\u5165\u65f6\u95f4\u8f6e\u548c-timerlog",level:3},{value:"TimerDequeueWarmService",id:"timerdequeuewarmservice",level:3},{value:"TimerDequeueGetService \u626b\u63cf\u65f6\u95f4\u8f6e\u4e2d\u5230\u671f\u7684\u6d88\u606f",id:"timerdequeuegetservice-\u626b\u63cf\u65f6\u95f4\u8f6e\u4e2d\u5230\u671f\u7684\u6d88\u606f",level:3},{value:"TimerFlushService",id:"timerflushservice",level:3},{value:"TimerDequeueGetMessageService \u67e5\u8be2\u539f\u59cb\u6d88\u606f",id:"timerdequeuegetmessageservice-\u67e5\u8be2\u539f\u59cb\u6d88\u606f",level:3},{value:"\u53c2\u8003",id:"\u53c2\u8003",level:2}];function o(e){const n={a:"a",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsxs)(n.p,{children:["\u8fd9\u91cc\u662f",(0,t.jsx)(n.strong,{children:"\u5c0f\u594f"}),",\u89c9\u5f97\u6587\u7ae0\u4e0d\u9519\u53ef\u4ee5\u5173\u6ce8\u516c\u4f17\u53f7",(0,t.jsx)(n.strong,{children:"\u5c0f\u594f\u6280\u672f"}),"\uff0c\u6587\u7ae0\u9996\u53d1\u3002\u62d2\u7edd\u8425\u9500\u53f7\uff0c\u62d2\u7edd\u6807\u9898\u515a"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"rocketmq\u7248\u672c",children:"RocketMQ\u7248\u672c"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"5.1.0"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"\u80cc\u666f",children:"\u80cc\u666f"}),"\n",(0,t.jsxs)(n.p,{children:["\u4e4b\u524d\u6211\u4eec\u5206\u6790\u4e86",(0,t.jsx)(n.code,{children:"RocketMQ"})," ",(0,t.jsx)(n.code,{children:"5.x"}),"\u56fa\u5b9a\u7b49\u7ea7\u5ef6\u65f6\u6d88\u606f\u6e90\u7801\u5206\u6790"]}),"\n",(0,t.jsxs)(n.p,{children:["\u4eca\u5929\u6765\u5206\u6790",(0,t.jsx)(n.code,{children:"RocketMQ"})," ",(0,t.jsx)(n.code,{children:"5.x"}),"\u65b0\u589e\u7684\u4efb\u610f\u65f6\u95f4\u7684\u5ef6\u65f6\u6d88\u606f"]}),"\n",(0,t.jsx)(n.h2,{id:"\u4f7f\u7528",children:"\u4f7f\u7528"}),"\n",(0,t.jsx)(n.h3,{id:"\u56fa\u5b9a\u5ef6\u65f6\u6d88\u606f",children:"\u56fa\u5b9a\u5ef6\u65f6\u6d88\u606f"}),"\n",(0,t.jsxs)(n.p,{children:["\u65e9\u671f\u57284.x\u7684\u65f6\u5019",(0,t.jsx)(n.code,{children:"RocketMQ"}),"\u53ea\u652f\u630118\u4e2a\u56fa\u5b9a\u5ef6\u8fdf\u65f6\u95f4\u7684\u5ef6\u65f6\u6d88\u606f"]}),"\n",(0,t.jsx)(n.p,{children:"\u4f7f\u7528\u65b9\u5f0f\u5982\u4e0b"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'        DefaultMQProducer producer = new DefaultMQProducer(producerGroup);\n        producer.setNamesrvAddr(namesrvAddr);\n        try {\n            producer.start();\n        } catch (MQClientException e) {\n            throw new RuntimeException(e);\n        }\n\n        Message msg = new Message(TOPIC /* Topic */,\n                TAG /* Tag */,\n                ("Hello RocketMQ " + i).getBytes(RemotingHelper.DEFAULT_CHARSET) /* Message body */\n        );\n        // \u8bbe\u7f6e\u5ef6\u8fdflevel\u4e3a5\uff0c\u5bf9\u5e94\u5ef6\u8fdf1\u5206\u949f\n        msg.setDelayTimeLevel(5);\n        producer.send(msg);\n'})}),"\n",(0,t.jsx)(n.h3,{id:"\u4efb\u610f\u65f6\u95f4\u5ef6\u65f6\u6d88\u606f",children:"\u4efb\u610f\u65f6\u95f4\u5ef6\u65f6\u6d88\u606f"}),"\n",(0,t.jsx)(n.h4,{id:"\u652f\u6301\u5ef6\u65f6\u6d88\u606f\u65f6\u95f4\u9650\u5236",children:"\u652f\u6301\u5ef6\u65f6\u6d88\u606f\u65f6\u95f4\u9650\u5236"}),"\n",(0,t.jsx)(n.p,{children:"\u57285.x\u540e\u652f\u6301\u4e86\u4efb\u610f\u65f6\u95f4\u7684\u5ef6\u65f6\u6d88\u606f\uff0c\u4f46\u662f\u9ed8\u8ba4\u53ea\u652f\u63013\u5929"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"private int timerMaxDelaySec = 3600 * 24 * 3;\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u5982\u679c\u9700\u8981\u652f\u6301\u66f4\u957f\u65f6\u95f4\u7684\u5ef6\u65f6\u6d88\u606f\uff0c\u6211\u4eec\u9700\u8981\u5728",(0,t.jsx)(n.code,{children:"broker"}),"\u7684",(0,t.jsx)(n.code,{children:"config"}),"\u4e2d\u8fdb\u884c\u914d\u7f6e"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-properties",children:"timerMaxDelaySec = 3600 * 24 * 7\n"})}),"\n",(0,t.jsx)(n.h4,{id:"\u4f7f\u7528\u65b9\u5f0f",children:"\u4f7f\u7528\u65b9\u5f0f"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'        DefaultMQProducer producer = new DefaultMQProducer(producerGroup);\n        producer.setNamesrvAddr(namesrvAddr);\n        try {\n            producer.start();\n        } catch (MQClientException e) {\n            throw new RuntimeException(e);\n        }\n\n        Message msg = new Message(TOPIC /* Topic */,\n                TAG /* Tag */,\n                ("Hello RocketMQ " + i).getBytes(RemotingHelper.DEFAULT_CHARSET) /* Message body */\n        );\n        // \u8bbe\u7f6e\u6d88\u606f\u5ef6\u8fdf\u6295\u9012\u65f6\u95f4\u4e3a 10 \u79d2\u540e\n        msg.setDelayTimeMs(10000);\n        producer.send(msg);\n'})}),"\n",(0,t.jsxs)(n.p,{children:["\u5f53\u7136\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7",(0,t.jsx)(n.code,{children:"setDeliverTimeMs"}),"\u8bbe\u7f6e\u7edd\u5bf9\u65f6\u95f4\u8fdb\u884c\u6295\u9012\uff0c\u6bd4\u5982"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'        DefaultMQProducer producer = new DefaultMQProducer(producerGroup);\n        producer.setNamesrvAddr(namesrvAddr);\n        try {\n            producer.start();\n        } catch (MQClientException e) {\n            throw new RuntimeException(e);\n        }\n\n        Message msg = new Message(TOPIC /* Topic */,\n                TAG /* Tag */,\n                ("Hello RocketMQ " + i).getBytes(RemotingHelper.DEFAULT_CHARSET) /* Message body */\n        );\n        // \u8bbe\u7f6e\u6d88\u606f\u5728\u6307\u5b9a\u7684\u65f6\u95f4\u6233\u6295\u9012\uff0c\u4f8b\u5982 10 \u5206\u949f\u540e\u7684\u67d0\u4e2a\u65f6\u95f4\u70b9\n        long deliverTime = System.currentTimeMillis() + 10 * 60 * 1000; \n        message.setDeliverTimeMs(deliverTime);\n        producer.send(msg);\n\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u4e3a\u4ec0\u4e484x\u4e00\u76f4\u4e0d\u652f\u6301\u4efb\u610f\u65f6\u95f4\u7684\u5ef6\u65f6\u6d88\u606f",children:"\u4e3a\u4ec0\u4e484.x\u4e00\u76f4\u4e0d\u652f\u6301\u4efb\u610f\u65f6\u95f4\u7684\u5ef6\u65f6\u6d88\u606f"}),"\n",(0,t.jsx)(n.p,{children:"\u4e3b\u8981\u662f\u5b9e\u73b0\u4e0a\u6709\u4e00\u5b9a\u96be\u5ea6"}),"\n",(0,t.jsxs)(n.p,{children:["\u76ee\u524d",(0,t.jsx)(n.code,{children:"RocketMQ"}),"\u7684\u6d88\u606f\u7edf\u4e00\u5b58\u50a8\u5728",(0,t.jsx)(n.code,{children:"commitLog"}),"\uff0c\u9ed8\u8ba4\u8d85\u8fc73\u5929\u5c31\u4f1a\u8fc7\u671f\u6e05\u7406"]}),"\n",(0,t.jsxs)(n.p,{children:["\u5982\u679c\u662f\u4efb\u610f\u5ef6\u65f6\u6d88\u606f\u5b58\u50a8\u5728",(0,t.jsx)(n.code,{children:"commitLog"}),"\u5982\u4f55\u4fdd\u8bc1\u6d88\u606f\u4e0d\u88ab\u6e05\u7406\uff0c\u5982\u679c\u4e0d\u5b58\u50a8\u5728",(0,t.jsx)(n.code,{children:"commitLog"}),"\u4e2d\u5982\u4f55\u5b58\u50a8"]}),"\n",(0,t.jsx)(n.h2,{id:"\u8bbe\u8ba1\u76ee\u6807",children:"\u8bbe\u8ba1\u76ee\u6807"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"\u652f\u6301\u4efb\u610f\u65f6\u5ef6\u7684\u5ef6\u8fdf\u6d88\u606f"}),"\n",(0,t.jsx)(n.li,{children:"\u63d0\u4f9b\u5ef6\u8fdf\u6d88\u606f\u53ef\u9760\u7684\u5b58\u50a8\u65b9\u5f0f"}),"\n",(0,t.jsx)(n.li,{children:"\u4fdd\u8bc1\u5ef6\u8fdf\u6d88\u606f\u5177\u6709\u53ef\u9760\u7684\u6536\u53d1\u6027\u80fd"}),"\n",(0,t.jsx)(n.li,{children:"\u63d0\u4f9b\u5ef6\u8fdf\u6d88\u606f\u7684\u53ef\u89c2\u6d4b\u6027\u6392\u67e5\u80fd\u529b"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"\u8bbe\u8ba1\u601d\u8def",children:"\u8bbe\u8ba1\u601d\u8def"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"\u91c7\u7528\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u4f5c\u4e3a\u53ef\u9760\u7684\u5ef6\u65f6\u6d88\u606f\u5b58\u50a8\u4ecb\u8d28\u3002\u5ef6\u65f6\u6d88\u606f\u53e6\u5b58TimerLog\u6587\u4ef6\u4e2d\u3002\u901a\u8fc7\u65f6\u95f4\u8f6e\u5bf9\u5b9a\u65f6\u6d88\u606f\u8fdb\u884c\u5b9a\u4f4d\u4ee5\u53ca\u5b58\u53d6"}),"\n",(0,t.jsx)(n.li,{children:"\u4e3a\u5ef6\u65f6\u6d88\u606f\u8bbe\u8ba1\u65b0pipeline\uff0c\u5b9a\u65f6\u626b\u63cf\u65f6\u95f4\u8f6e\u4e2d\u7684\u5230\u65f6\u6d88\u606f\uff0c\u8f6c\u53d1\u81f3commitLog\u4e2d"}),"\n",(0,t.jsx)(n.li,{children:"\u9488\u5bf9\u957f\u65f6\u95f4\u5b9a\u65f6\u6d88\u606f\uff0c\u901a\u8fc7\u6d88\u606f\u6eda\u52a8\u7684\u65b9\u5f0f\u907f\u514d\u8fc7\u5927\u7684\u6d88\u606f\u5b58\u50a8\u91cf"}),"\n",(0,t.jsx)(n.li,{children:"\u5b9a\u65f6\u6d88\u606f\u67e5\u8be2\uff0c\u76f4\u63a5\u5b9a\u4f4d\u65f6\u95f4\u8f6e\u7684slot\u8fdb\u884c\u67e5\u8be2\uff1b\u8f6c\u4e3a\u666e\u901a\u6d88\u606f\u65f6\uff0c\u548c\u5f53\u524d\u7684\u67e5\u8be2\u903b\u8f91\u4e00\u81f4\uff1b"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"\u8be6\u7ec6\u5b9e\u73b0",children:"\u8be6\u7ec6\u5b9e\u73b0"}),"\n",(0,t.jsx)(n.h3,{id:"\u5b58\u50a8",children:"\u5b58\u50a8"}),"\n",(0,t.jsx)(n.p,{children:"\u5f15\u5165\u4e24\u4e2a\u65b0\u7684\u5b58\u50a8\u6587\u4ef6"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"TimerLog\uff1a \u4e3b\u8981\u7528\u6765\u5b58\u50a8\u6f14\u793a\u6d88\u606f\u7684\u7d22\u5f15"}),"\n",(0,t.jsx)(n.li,{children:"TimerWheel\uff1a \u65f6\u95f4\u8f6e\u7684\u4e3b\u8981\u5b9e\u73b0"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"alt text",src:i(4994).A+"",width:"594",height:"347"})}),"\n",(0,t.jsx)(n.h4,{id:"timerwheel",children:"TimerWheel"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"TimerWheel"}),"\u662f\u65f6\u95f4\u8f6e\u7684\u5b9e\u73b0\u3002\u4e00\u4e9b\u6838\u5fc3\u5c5e\u6027\u6211\u4eec\u6765\u770b\u770b"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"    // \u5b9a\u4e49\u7279\u6b8a\u6807\u8bb0\uff1aBLANK\u4ee3\u8868\u7a7a\uff0cIGNORE\u4ee3\u8868\u5728\u4fee\u6539\u65f6\u5ffd\u7565\u8be5\u5b57\u6bb5\n    public static final int BLANK = -1, IGNORE = -2;\n    // \u65f6\u95f4\u8f6e\u4e2d\u7684\u57fa\u7840\u69fd\u4f4d\u6570\u91cf \u9ed8\u8ba4\u662f 7 * 24 * 3600\n    public final int slotsTotal;\n    // \u6bcf\u4e2a\u69fd\u4f4d\u4ee3\u8868\u7684\u65f6\u95f4\u7cbe\u5ea6\uff0c\u5355\u4f4d\u4e3a\u6beb\u79d2\n    public final int precisionMs;\n\n    // \u6574\u4e2a\u65f6\u95f4\u8f6e\u6587\u4ef6\u5728\u78c1\u76d8\u4e0a\u7684\u603b\u957f\u5ea6\uff08\u5b57\u8282\uff09\n    private final int wheelLength;\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u8fd9\u4e2a\u662f\u6574\u4e2a\u65f6\u95f4\u8f6e\u7684\u7ed3\u6784\uff0c\u7136\u540e\u65f6\u95f4\u8f6e\u4e2d\u7684\u57fa\u672c\u5b58\u50a8\u5355\u4f4d\u4e3a",(0,t.jsx)(n.code,{children:"Slot"}),"\uff0c",(0,t.jsx)(n.code,{children:"Slot"}),"\u7684\u6570\u636e\u7ed3\u6784\u5982\u4e0b"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"/**\n * Represents a slot of timing wheel. Format:\n * \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n * \u2502delayed time\u2502 first pos \u2502 last pos  \u2502    num    \u2502   magic   \u2502\n * \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n * \u2502   8bytes   \u2502   8bytes  \u2502  8bytes   \u2502   4bytes  \u2502   4bytes  \u2502\n * \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n */\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"delayed_time\uff1a\u5ef6\u8fdf\u65f6\u95f4"}),"\n",(0,t.jsx)(n.li,{children:"first_pos\uff1aTimerLog \u4e2d\u8be5\u65f6\u523b\u5b9a\u65f6\u6d88\u606f\u94fe\u8868\u7684\u7b2c\u4e00\u4e2a\u6d88\u606f\u7684\u7269\u7406\u504f\u79fb\u91cf"}),"\n",(0,t.jsx)(n.li,{children:"last_pos\uff1aTimerLog \u4e2d\u8be5\u65f6\u523b\u5b9a\u65f6\u6d88\u606f\u94fe\u8868\u7684\u6700\u540e\uff08\u6700\u65b0\uff09\u4e00\u4e2a\u6d88\u606f\u7684\u7269\u7406\u504f\u79fb\u91cf\uff08\u94fe\u8868\u5934\uff09"}),"\n",(0,t.jsx)(n.li,{children:"num \u6d88\u606f\u6761\u6570"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\u7ec6\u8282"}),"\n",(0,t.jsx)(n.p,{children:"\u867d\u7136\u65f6\u95f4\u8f6e\u7684\u57fa\u7840\u69fd\u4f4d\u662f7\u5929"}),"\n",(0,t.jsx)(n.p,{children:"\u4f46\u662f\u65f6\u95f4\u8f6e\u8f6e\u8f6c\u7684\u662f2\u5929\u7684"}),"\n",(0,t.jsx)(n.h4,{id:"timerlog",children:"TimerLog"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"TimerLog"}),"\u7684\u5b58\u50a8\u65b9\u5f0f\u4e5f\u987a\u5e8f\u5199\u5165",(0,t.jsx)(n.code,{children:"Append-only Log"})]}),"\n",(0,t.jsxs)(n.p,{children:["\u4fdd\u7559\u7684\u4e0d\u662f\u771f\u5b9e\u7684\u6d88\u606f\uff0c\u53ea\u4fdd\u7559",(0,t.jsx)(n.code,{children:"CommitLog"}),"\u7684\u57fa\u672c\u7d22\u5f15\u4fe1\u606f"]}),"\n",(0,t.jsx)(n.p,{children:"\u8be6\u7ec6\u7684\u7ed3\u6784\u5982\u4e0b"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{style:{textAlign:"center"},children:"\u540d\u79f0"}),(0,t.jsx)(n.th,{style:{textAlign:"center"},children:"\u5927\u5c0f"}),(0,t.jsx)(n.th,{style:{textAlign:"center"},children:"\u5907\u6ce8"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"size"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"4B"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"\u4fdd\u5b58\u8bb0\u5f55\u7684\u5927\u5c0f"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"prev_pos"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"8B"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"\u524d\u4e00\u6761\u8bb0\u5f55\u7684\u4f4d\u7f6e"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"next_Pos"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"8B"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"\u540e\u4e00\u6761\u8bb0\u5f55\u7684\u4f4d\u7f6e\uff0c\u6682\u65f6\u4e3a-1\uff0c\u4f5c\u4e3a\u4fdd\u7559\u5b57\u6bb5"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"magic"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"4B"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"\u9b54\u6570"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"delayed_time"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"4B"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"\u8be5\u6761\u8bb0\u5f55\u7684\u5b9a\u65f6\u65f6\u95f4"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"offset_real"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"8B"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"\u8be5\u6761\u6d88\u606f\u5728commitLog\u4e2d\u7684\u4f4d\u7f6e"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"size_real"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"4B"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"\u8be5\u6761\u6d88\u606f\u5728commitLog\u4e2d\u7684\u5927\u5c0f"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"hash_topic"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"4B"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"\u8be5\u6761\u6d88\u606ftopic\u7684hash code"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"varbody"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"4B"}),(0,t.jsx)(n.td,{style:{textAlign:"center"},children:"\u5b58\u50a8\u53ef\u53d8\u7684body\uff0c\u6682\u65f6\u6ca1\u6709\u4e3a\u7a7a"})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"\u65b0\u7684pipeline\u5b9e\u73b0",children:"\u65b0\u7684pipeline\u5b9e\u73b0"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"alt text",src:i(1487).A+"",width:"1500",height:"918"})}),"\n",(0,t.jsx)(n.p,{children:"\u65f6\u95f4\u8f6e\u7684\u5904\u7406\u4e3b\u8981\u5206\u51e0\u4e2aservice"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"    public void initService() {\n        enqueueGetService = new TimerEnqueueGetService();\n        enqueuePutService = new TimerEnqueuePutService();\n        dequeueWarmService = new TimerDequeueWarmService();\n        dequeueGetService = new TimerDequeueGetService();\n        timerFlushService = new TimerFlushService();\n\n        int getThreadNum = Math.max(storeConfig.getTimerGetMessageThreadNum(), 1);\n        dequeueGetMessageServices = new TimerDequeueGetMessageService[getThreadNum];\n        for (int i = 0; i < dequeueGetMessageServices.length; i++) {\n            dequeueGetMessageServices[i] = new TimerDequeueGetMessageService();\n        }\n\n        int putThreadNum = Math.max(storeConfig.getTimerPutMessageThreadNum(), 1);\n        dequeuePutMessageServices = new TimerDequeuePutMessageService[putThreadNum];\n        for (int i = 0; i < dequeuePutMessageServices.length; i++) {\n            dequeuePutMessageServices[i] = new TimerDequeuePutMessageService();\n        }\n    }\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u4e0b\u9762\u6211\u4eec\u6765\u8be6\u7ec6\u4ecb\u7ecd\u8fd9\u4e9b",(0,t.jsx)(n.code,{children:"service"}),"\u662f\u5e72\u561b\u7528\u7684"]}),"\n",(0,t.jsx)(n.h3,{id:"timerenqueuegetservice-\u626b\u63cf\u5b9a\u65f6\u6d88\u606f",children:"TimerEnqueueGetService \u626b\u63cf\u5b9a\u65f6\u6d88\u606f"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"TimerEnqueueGetService"}),"\u901a\u8fc7\u904d\u5386\u6d88\u8d39\u961f\u5217\u7d22\u5f15\u7684\u65b9\u5f0f\u4e0d\u65ad\u626b\u63cf\u5b9a\u65f6\u6d88\u606f Topic(",(0,t.jsx)(n.code,{children:"rmq_sys_wheel_timer"}),") \u4e2d\u65b0\u7684\u5b9a\u65f6\u6d88\u606f\u3002"]}),"\n",(0,t.jsxs)(n.p,{children:["\u626b\u63cf\u5230\u4e86\u4e4b\u540e\u5c06\u6d88\u606f\u4ece",(0,t.jsx)(n.code,{children:"CommitLog"})," \u4e2d\u67e5\u51fa\u6765\uff0c\u5c01\u88c5\u6210",(0,t.jsx)(n.code,{children:"TimerRequest"}),"\uff0c\u653e\u5165\u6709\u754c\u963b\u585e\u961f\u5217",(0,t.jsx)(n.code,{children:"enqueuePutQueue"}),"(",(0,t.jsx)(n.code,{children:"DisruptorBlockingQueue"}),")\u3002\u5982\u679c\u961f\u5217\u6ee1\uff0c\u5219\u4f1a\u65e0\u9650\u6b21\u91cd\u8bd5\u7b49\u5f85\uff0c\u8fbe\u5230\u6d41\u63a7\u6548\u679c"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'public static final String TIMER_TOPIC = TopicValidator.SYSTEM_TOPIC_PREFIX + "wheel_timer";\n\nenqueuePutQueue = new DisruptorBlockingQueue<>(DEFAULT_CAPACITY);\n\n    // \u7701\u7565\u90e8\u5206\u4ee3\u7801\n    public boolean enqueue(int queueId) {\n\n        ConsumeQueueInterface cq = this.messageStore.getConsumeQueue(TIMER_TOPIC, queueId);\n        long offset = currQueueOffset;\n        ReferredIterator<CqUnit> iterator = null;\n        iterator = cq.iterateFrom(offset);\n        if (null == iterator) {\n            return false;\n        }\n        int i = 0;\n        while (iterator.hasNext()) {\n            i++;\n\n            CqUnit cqUnit = iterator.next();\n            long offsetPy = cqUnit.getPos();\n            int sizePy = cqUnit.getSize();\n            cqUnit.getTagsCode(); //tags code\n            MessageExt msgExt = getMessageByCommitOffset(offsetPy, sizePy);\n            lastEnqueueButExpiredTime = System.currentTimeMillis();\n            lastEnqueueButExpiredStoreTime = msgExt.getStoreTimestamp();\n            long delayedTime = Long.parseLong(msgExt.getProperty(TIMER_OUT_MS));\n            // use CQ offset, not offset in Message\n            msgExt.setQueueOffset(offset + i);\n            TimerRequest timerRequest = new TimerRequest(offsetPy, sizePy, delayedTime, System.currentTimeMillis(), MAGIC_DEFAULT, msgExt);\n            // System.out.printf("build enqueue request, %s%n", timerRequest);\n            while (!enqueuePutQueue.offer(timerRequest, 3, TimeUnit.SECONDS)) {\n                if (!isRunningEnqueue()) {\n                    return false;\n                }\n            }\n            currQueueOffset = offset + i;\n        }\n        currQueueOffset = offset + i;\n        return i > 0;\n    }\n\n'})}),"\n",(0,t.jsx)(n.h3,{id:"timerenqueueputservice-\u5c06\u5b9a\u65f6\u6d88\u606f\u653e\u5165\u65f6\u95f4\u8f6e\u548c-timerlog",children:"TimerEnqueuePutService \u5c06\u5b9a\u65f6\u6d88\u606f\u653e\u5165\u65f6\u95f4\u8f6e\u548c TimerLog"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"TimerEnqueuePutService"}),"\u4e0d\u65ad\u626b\u63cf\u961f\u5217",(0,t.jsx)(n.code,{children:"enqueuePutQueue"}),"\uff0c\u7136\u540e\u53d6\u51fa",(0,t.jsx)(n.code,{children:"TimerEnqueueGetService"}),"\u653e\u5165\u7684",(0,t.jsx)(n.code,{children:"TimerRequest"})]}),"\n",(0,t.jsxs)(n.li,{children:["\u53d6\u51fa\u7684",(0,t.jsx)(n.code,{children:"TimerRequest"}),"\u8bf7\u6c42\u4e2d\u5982\u679c\u5ef6\u65f6\u6d88\u606f\u5230\u671f\u5230\u671f\u4e86\u5219\u76f4\u63a5\u653e\u5165",(0,t.jsx)(n.code,{children:"dequeuePutQueue"}),"\u51c6\u5907\u6295\u9012\u5230 ",(0,t.jsx)(n.code,{children:"CommitLog"})]}),"\n",(0,t.jsxs)(n.li,{children:["\u5982\u679c\u5ef6\u65f6\u6d88\u606f\u6ca1\u5230\u671f\u5219\u5b58\u50a8\u5230\u5230",(0,t.jsx)(n.code,{children:"TimerLog"}),"\u548c",(0,t.jsx)(n.code,{children:"TimerWheel"})]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"\u6267\u884c\u903b\u8f91\u6838\u5fc3\u4ee3\u7801"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'        protected void fetchAndPutTimerRequest() throws Exception {\n            long tmpCommitQueueOffset = currQueueOffset;\n            // \u6d88\u8d39enqueuePutQueue\u83b7\u53d6TimerRequest\n            List<TimerRequest> trs = this.fetchTimerRequests();\n            if (CollectionUtils.isEmpty(trs)) {\n                commitQueueOffset = tmpCommitQueueOffset;\n                //\u5c1d\u8bd5\u63a8\u8fdb\u5199\u5165\u65f6\u95f4\uff08currWriteTimeMs\uff09\uff0c\u7528\u4e8e\u6e05\u7406\u8fc7\u671f\u69fd\u4f4d\u6216\u89e6\u53d1\u540e\u7eed\u4efb\u52a1\n                maybeMoveWriteTime();\n                return;\n            }\n            // \u5faa\u73af\u5c1d\u8bd5\u5c06\u8fd9\u6279\u6d88\u606f\u653e\u5165\u65f6\u95f4\u8f6e\uff0c\u76f4\u5230\u5168\u90e8\u6210\u529f\n            while (!isStopped()) {\n                CountDownLatch latch = new CountDownLatch(trs.size());\n                for (TimerRequest req : trs) {\n                    req.setLatch(latch);\n                    // \u5c06\u5355\u4e2a\u5b9a\u65f6\u6d88\u606f\u8bf7\u6c42\u653e\u5165\u65f6\u95f4\u8f6e\uff08Timer Wheel\uff09\n                    // \u5982\u679c\u5ef6\u65f6\u6d88\u606f\u5c0f\u4e8e\u5f53\u524d\u5199\u5165\u65f6\u95f4\uff0c\u5219\u76f4\u63a5\u653e\u5165dequeuePutQueue\u961f\u5217\n                    this.putMessageToTimerWheel(req);\n                }\n                //\u7b49\u5f85\u6240\u6709\u6d88\u606f\u5b8c\u6210\u5165\u8f6e\uff08\u6700\u591a\u7b49\u5f85\u4e00\u6bb5\u65f6\u95f4\uff0c\u5185\u90e8\u6709\u91cd\u8bd5\u673a\u5236\uff09\n                checkDequeueLatch(latch, -1);\n                boolean allSuccess = trs.stream().allMatch(TimerRequest::isSucc);\n                if (allSuccess) {\n                    break;\n                } else {\n                    holdMomentForUnknownError();\n                }\n            }\n            // \u6240\u6709\u6d88\u606f\u6210\u529f\u5165\u8f6e\u540e\uff0c\u66f4\u65b0\u5df2\u63d0\u4ea4\u7684\u961f\u5217\u4f4d\u70b9\uff08\u6301\u4e45\u5316\u6d88\u8d39\u8fdb\u5ea6\uff09\n            // \u66f4\u65b0\u4e3a\u6700\u540e\u4e00\u6761\u6d88\u606f\u7684 offset\uff0c\u8868\u793a\u8fd9\u6279\u6d88\u606f\u5df2\u6210\u529f\u5904\u7406\n            commitQueueOffset = trs.get(trs.size() - 1).getMsg().getQueueOffset();\n            // \u5c1d\u8bd5\u63a8\u8fdb\u5199\u5165\u65f6\u95f4\uff08currWriteTimeMs\uff09\n            maybeMoveWriteTime();\n        }\n\n        // \u7701\u7565\u76d1\u63a7\u4ee3\u7801\n        protected void putMessageToTimerWheel(TimerRequest req) {\n            try {\n                // \u5f53\u524d\u6d88\u606f\u7684\u5ef6\u8fdf\u65f6\u95f4\u5df2\u8fc7\u671f\uff08\u5c0f\u4e8e\u5f53\u524d\u5199\u5165\u65f6\u95f4\uff09\n                if (shouldRunningDequeue && req.getDelayTime() < currWriteTimeMs) {\n                    // \u6d88\u606f\u5df2\u8fc7\u671f\uff0c\u4e0d\u5e94\u518d\u5165\u65f6\u95f4\u8f6e\uff0c\u800c\u662f\u76f4\u63a5\u8f6c\u5165\u51fa\u961f\u961f\u5217\uff08dequeuePutQueue\uff09\n                    req.setEnqueueTime(Long.MAX_VALUE);\n                    dequeuePutQueue.put(req);\n                } else {\n                    // \u6b63\u5e38\u5165\u8f6e\uff1a\u5c06\u6d88\u606f\u5b58\u50a8\u5230TimerLog\u548cTimerWheel\u4e2d\n                    boolean doEnqueueRes = doEnqueue(\n                        req.getOffsetPy(), req.getSizePy(), req.getDelayTime(), req.getMsg());\n                    req.idempotentRelease(doEnqueueRes || storeConfig.isTimerSkipUnknownError());\n                }\n                perfCounterTicks.endTick(ENQUEUE_PUT);\n            } catch (Throwable t) {\n                LOGGER.error("Unknown error", t);\n                if (storeConfig.isTimerSkipUnknownError()) {\n                    req.idempotentRelease(true);\n                } else {\n                    holdMomentForUnknownError();\n                }\n            }\n        }\n'})}),"\n",(0,t.jsx)(n.h3,{id:"timerdequeuewarmservice",children:"TimerDequeueWarmService"}),"\n",(0,t.jsx)(n.p,{children:"\u76ee\u524d\u770b\u4ee3\u7801\u8fd9\u4e2a\u7ebf\u7a0b\u597d\u50cf\u6ca1\u5565\u7528"}),"\n",(0,t.jsx)(n.h3,{id:"timerdequeuegetservice-\u626b\u63cf\u65f6\u95f4\u8f6e\u4e2d\u5230\u671f\u7684\u6d88\u606f",children:"TimerDequeueGetService \u626b\u63cf\u65f6\u95f4\u8f6e\u4e2d\u5230\u671f\u7684\u6d88\u606f"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"TimerDequeueGetService"}),"\u4e3b\u8981\u662f\u5b9a\u65f6\u626b\u63cf",(0,t.jsx)(n.code,{children:"TimerLog"}),"\u548c",(0,t.jsx)(n.code,{children:"TimerWheel"}),",\u7136\u540e\u5c06\u4efb\u52a1\u653e\u5165",(0,t.jsx)(n.code,{children:"dequeueGetQueue"}),",\u63a8\u8fdb\u65f6\u95f4\u8f6e"]}),"\n",(0,t.jsx)(n.p,{children:"\u8fd9\u4e2a\u7ebf\u7a0b\u7684\u4f5c\u7528\u662f\uff1a\u63a8\u8fdb\u65f6\u95f4\u8f6e\uff0c\u5c06\u65f6\u95f4\u8f6e\u69fd\u4f4d\u5bf9\u5e94\u7684\u5b9a\u65f6\u6d88\u606f\u8bf7\u6c42\u4ece\u65f6\u95f4\u8f6e\u548c TimerLog \u4e2d\u53d6\u51fa\uff0c\u52a0\u5165\u5230 dequeueGetQueue \u4e2d\u3002"}),"\n",(0,t.jsx)(n.p,{children:"\u6bcf 0.1s \u6267\u884c\u4e00\u6b21\uff0c\u6839\u636e\u5f53\u524d\u626b\u63cf\u65f6\u95f4\u8f6e\u7684\u65f6\u95f4\u6233\uff0c\u4ece\u65f6\u95f4\u8f6e\u548c TimerLog \u4e2d\u67e5\u8be2\u51fa TimerRequest\uff0c\u5e76\u5206\u6210\u5b9a\u65f6\u8bf7\u6c42\u548c\u5b9a\u65f6\u6d88\u606f\u53d6\u6d88\u8bf7\u6c42\u4e24\u7c7b\u3002"}),"\n",(0,t.jsx)(n.p,{children:"\u5148\u6279\u91cf\u5c06\u53d6\u6d88\u8bf7\u6c42\u5165\u961f\uff0c\u7b49\u5f85\u5904\u7406\u5b8c\u6bd5\uff0c\u518d\u5c06\u5b9a\u65f6\u6d88\u606f\u8bf7\u6c42\u5165\u961f\uff0c\u7b49\u5f85\u5904\u7406\u5b8c\u6bd5\u3002"}),"\n",(0,t.jsx)(n.p,{children:"\u8be5\u69fd\u4f4d\u7684\u5b9a\u65f6\u6d88\u606f\u90fd\u5904\u7406\u5b8c\u6210\u540e\uff0c\u63a8\u8fdb\u65f6\u95f4\u8f6e\u626b\u63cf\u65f6\u95f4\u5230\u4e0b\u4e00\u69fd\u4f4d"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"\n\n"})}),"\n",(0,t.jsx)(n.h3,{id:"timerflushservice",children:"TimerFlushService"}),"\n",(0,t.jsxs)(n.p,{children:["\u8fd9\u4e2a\u7ebf\u7a0b\u4e3b\u8981\u662f\u5c06\u65f6\u95f4\u8f6e\u4e2d\u7684\u6570\u636e\u5b9a\u65f6\u4ece",(0,t.jsx)(n.code,{children:"pageCache"}),"\u4e2d\u5237\u65b0\u5230\u78c1\u76d8\u4e2d"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'        @Override\n        public void run() {\n            while (!this.isStopped()) {\n                try {\n                    prepareTimerCheckPoint();\n                    timerLog.getMappedFileQueue().flush(0);\n                    timerWheel.flush();\n                    timerCheckpoint.flush();\n                    waitForRunning(storeConfig.getTimerFlushIntervalMs());\n                } catch (Throwable e) {\n                    TimerMessageStore.LOGGER.error("Error occurred in " + getServiceName(), e);\n                }\n            }\n            TimerMessageStore.LOGGER.info(this.getServiceName() + " service end");\n        }\n    }\n'})}),"\n",(0,t.jsx)(n.h3,{id:"timerdequeuegetmessageservice-\u67e5\u8be2\u539f\u59cb\u6d88\u606f",children:"TimerDequeueGetMessageService \u67e5\u8be2\u539f\u59cb\u6d88\u606f"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"TimerDequeueGetMessageService"}),"\u4e3b\u8981\u662f\u6d88\u8d39",(0,t.jsx)(n.code,{children:"dequeueGetQueue"}),"\u4e2d\u7684",(0,t.jsx)(n.code,{children:"TimerRequest"})]}),"\n",(0,t.jsxs)(n.p,{children:["\u83b7\u53d6\u5230",(0,t.jsx)(n.code,{children:"TimerRequest"}),"\u6839\u636e\u7d22\u5f15\u53bb",(0,t.jsx)(n.code,{children:"CommitLog"}),"\u67e5\u8be2\u51fa\u539f\u59cb\u6d88\u606f\uff0c\u653e\u5165",(0,t.jsx)(n.code,{children:"dequeuePutQueue"}),"\u4e2d"]}),"\n",(0,t.jsx)(n.p,{children:"\u4ece dequeueGetQueue \u4e2d\u53d6\u51fa TimerRequest"}),"\n",(0,t.jsx)(n.p,{children:"\u5bf9\u53d6\u51fa\u7684 TimerRequst\uff0c\u4ece CommitLog \u4e2d\u67e5\u8be2\u539f\u59cb\u6d88\u606f"}),"\n",(0,t.jsx)(n.p,{children:"\u5904\u7406\u5b9a\u65f6\u6d88\u606f\u53d6\u6d88\u8bf7\u6c42\uff0c\u67e5\u8be2\u51fa\u539f\u59cb\u6d88\u606f\u4e2d\u8981\u53d6\u6d88\u6d88\u606f\u7684 UNIQ_KEY\uff0c\u653e\u5165 deleteUniqKeys Set"}),"\n",(0,t.jsx)(n.p,{children:"\u5904\u7406\u666e\u901a\u5b9a\u65f6\u6d88\u606f\u8bf7\u6c42"}),"\n",(0,t.jsx)(n.p,{children:"\u5982\u679c DeleteUniqKeys \u4e2d\u5305\u542b\u8fd9\u4e2a\u6d88\u606f\uff0c\u5219\u4ec0\u4e48\u90fd\u4e0d\u505a\uff08\u53d6\u6d88\u6295\u9012\uff09"}),"\n",(0,t.jsx)(n.p,{children:"\u5426\u5219\u5c06\u67e5\u51fa\u7684\u539f\u59cb\u6d88\u606f\u653e\u5165 TimerRequest\uff0c\u7136\u540e\u5c06 TimerRequest \u653e\u5165 dequeuePutQueue\uff0c\u51c6\u5907\u6295\u9012\u5230 CommitLog"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"TimerDequeuePutMessageService \u6295\u9012\u5b9a\u65f6\u6d88\u606f"}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["\u8fd9\u4e2a\u7ebf\u7a0b\u7684\u4f5c\u7528\u662f\uff1a\u5c06\u6d88\u606f\u4ece",(0,t.jsx)(n.code,{children:"dequeuePutQueue"})," \u4e2d\u53d6\u51fa\uff0c\u82e5\u5df2\u7ecf\u5230\u671f\uff0c\u6295\u9012\u5230 CommitLog \u4e2d"]}),"\n",(0,t.jsx)(n.p,{children:"\u65e0\u9650\u5faa\u73af\u4ece dequeuePutQueue \u4e2d\u53d6\u51fa TimerRequest"}),"\n",(0,t.jsx)(n.p,{children:"\u5c06\u539f\u59cb\u6d88\u606f\u7684 Topic \u548c queueId \u4ece\u6d88\u606f\u5c5e\u6027\u4e2d\u53d6\u51fa\uff0c\u7528\u5b83\u4eec\u6784\u9020\u6210\u4e00\u4e2a\u65b0\u7684\u6d88\u606f"}),"\n",(0,t.jsx)(n.p,{children:"\u5c06\u6d88\u606f\u6295\u9012\u5230 CommitLog"}),"\n",(0,t.jsxs)(n.p,{children:["\u5982\u679c\u6295\u9012\u5931\u8d25\uff0c\u5219\u9700\u8981\u7b49\u5f85",(0,t.jsx)(n.code,{children:"{\u7cbe\u786e\u5ea6 / 2}"}),"\u65f6\u95f4\u7136\u540e\u91cd\u65b0\u6295\u9012\uff0c\u5fc5\u987b\u4fdd\u8bc1\u6d88\u606f\u6295\u9012\u6210\u529f"]}),"\n",(0,t.jsx)(n.h2,{id:"\u53c2\u8003",children:"\u53c2\u8003"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/apache/rocketmq/issues/4557",children:"https://github.com/apache/rocketmq/issues/4557"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.google.com/document/d/1D6XWwY39p531c2aVi5HQll9iwzTUNT1haUFHqMoRkT0/edit?tab=t.0#heading=h.d7x9otgla1zw",children:"https://docs.google.com/document/d/1D6XWwY39p531c2aVi5HQll9iwzTUNT1haUFHqMoRkT0/edit?tab=t.0#heading=h.d7x9otgla1zw"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},8453:(e,n,i)=>{i.d(n,{R:()=>l,x:()=>c});var r=i(6540);const t={},s=r.createContext(t);function l(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);