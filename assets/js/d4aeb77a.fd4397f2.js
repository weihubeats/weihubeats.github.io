"use strict";(self.webpackChunkweihubeats_website=self.webpackChunkweihubeats_website||[]).push([[9160],{2720:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>d,contentTitle:()=>o,default:()=>u,frontMatter:()=>s,metadata:()=>l,toc:()=>a});const l=JSON.parse('{"id":"\u6570\u636e\u7ed3\u6784\u4e0e\u7b97\u6cd5/\u9650\u6d41\u7b97\u6cd5","title":"\u9650\u6d41\u7b97\u6cd5","description":"\u672c\u6587\u5c06\u5206\u6790\u5e38\u89c1\u7684\u9650\u6d41\u7b97\u6cd5\u4ee5\u53ca\u4f18\u7f3a\u70b9","source":"@site/docs/\u6570\u636e\u7ed3\u6784\u4e0e\u7b97\u6cd5/\u9650\u6d41\u7b97\u6cd5.md","sourceDirName":"\u6570\u636e\u7ed3\u6784\u4e0e\u7b97\u6cd5","slug":"/\u6570\u636e\u7ed3\u6784\u4e0e\u7b97\u6cd5/\u9650\u6d41\u7b97\u6cd5","permalink":"/docs/\u6570\u636e\u7ed3\u6784\u4e0e\u7b97\u6cd5/\u9650\u6d41\u7b97\u6cd5","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/\u6570\u636e\u7ed3\u6784\u4e0e\u7b97\u6cd5/\u9650\u6d41\u7b97\u6cd5.md","tags":[],"version":"current","frontMatter":{},"sidebar":"\u6570\u636e\u7ed3\u6784\u4e0e\u7b97\u6cd5","previous":{"title":"\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5","permalink":"/docs/\u6570\u636e\u7ed3\u6784\u4e0e\u7b97\u6cd5/\u8d1f\u8f7d\u5747\u8861\u7b97\u6cd5"}}');var t=i(4848),r=i(8453);const s={},o=void 0,d={},a=[{value:"\u56fa\u5b9a\u7a97\u53e3",id:"\u56fa\u5b9a\u7a97\u53e3",level:2},{value:"\u539f\u7406",id:"\u539f\u7406",level:3},{value:"\u4f18\u70b9",id:"\u4f18\u70b9",level:3},{value:"\u7f3a\u70b9",id:"\u7f3a\u70b9",level:3},{value:"\u9002\u7528\u573a\u666f",id:"\u9002\u7528\u573a\u666f",level:3},{value:"\u4ee3\u7801\u5b9e\u73b0",id:"\u4ee3\u7801\u5b9e\u73b0",level:3},{value:"\u9650\u6d41\u6d4b\u8bd5",id:"\u9650\u6d41\u6d4b\u8bd5",level:3},{value:"\u6ed1\u52a8\u7a97\u53e3",id:"\u6ed1\u52a8\u7a97\u53e3",level:2},{value:"\u539f\u7406",id:"\u539f\u7406-1",level:3},{value:"\u4f18\u70b9",id:"\u4f18\u70b9-1",level:3},{value:"\u7f3a\u70b9",id:"\u7f3a\u70b9-1",level:3},{value:"\u9002\u7528\u573a\u666f",id:"\u9002\u7528\u573a\u666f-1",level:3},{value:"\u4ee3\u7801\u5b9e\u73b0",id:"\u4ee3\u7801\u5b9e\u73b0-1",level:3},{value:"\u9650\u6d41\u6d4b\u8bd5",id:"\u9650\u6d41\u6d4b\u8bd5-1",level:3},{value:"\u6f0f\u6876\u7b97\u6cd5",id:"\u6f0f\u6876\u7b97\u6cd5",level:2},{value:"\u539f\u7406",id:"\u539f\u7406-2",level:3},{value:"\u4f18\u70b9",id:"\u4f18\u70b9-2",level:3},{value:"\u7f3a\u70b9",id:"\u7f3a\u70b9-2",level:3},{value:"\u9002\u7528\u573a\u666f",id:"\u9002\u7528\u573a\u666f-2",level:3},{value:"\u4ee3\u7801\u5b9e\u73b0",id:"\u4ee3\u7801\u5b9e\u73b0-2",level:3},{value:"\u9650\u6d41\u6d4b\u8bd5",id:"\u9650\u6d41\u6d4b\u8bd5-2",level:3},{value:"\u4ee4\u724c\u7b97\u6cd5",id:"\u4ee4\u724c\u7b97\u6cd5",level:2},{value:"\u539f\u7406",id:"\u539f\u7406-3",level:3},{value:"\u4f18\u70b9",id:"\u4f18\u70b9-3",level:3},{value:"\u7f3a\u70b9",id:"\u7f3a\u70b9-3",level:3},{value:"\u4f7f\u7528\u573a\u666f",id:"\u4f7f\u7528\u573a\u666f",level:3},{value:"\u4ee3\u7801\u5b9e\u73b0",id:"\u4ee3\u7801\u5b9e\u73b0-3",level:3},{value:"\u9650\u6d41\u6d4b\u8bd5",id:"\u9650\u6d41\u6d4b\u8bd5-3",level:3}];function c(n){const e={blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.p,{children:"\u672c\u6587\u5c06\u5206\u6790\u5e38\u89c1\u7684\u9650\u6d41\u7b97\u6cd5\u4ee5\u53ca\u4f18\u7f3a\u70b9"}),"\n",(0,t.jsx)(e.h2,{id:"\u56fa\u5b9a\u7a97\u53e3",children:"\u56fa\u5b9a\u7a97\u53e3"}),"\n",(0,t.jsx)(e.h3,{id:"\u539f\u7406",children:"\u539f\u7406"}),"\n",(0,t.jsx)(e.p,{children:"\u5c06\u65f6\u95f4\u5212\u5206\u4e3a\u56fa\u5b9a\u957f\u5ea6\u7684\u7a97\u53e3\uff08\u59821\u79d2\uff09\uff0c\u7edf\u8ba1\u6bcf\u4e2a\u7a97\u53e3\u5185\u7684\u8bf7\u6c42\u6570"}),"\n",(0,t.jsx)(e.p,{children:"\u82e5\u7a97\u53e3\u5185\u8bf7\u6c42\u6570\u8d85\u8fc7\u9608\u503c\uff0c\u5219\u62d2\u7edd\u540e\u7eed\u8bf7\u6c42\uff1b\u7a97\u53e3\u7ed3\u675f\u65f6\u91cd\u7f6e\u8ba1\u6570\u5668"}),"\n",(0,t.jsx)(e.h3,{id:"\u4f18\u70b9",children:"\u4f18\u70b9"}),"\n",(0,t.jsx)(e.p,{children:"\u5b9e\u73b0\u7b80\u5355\uff0c\u5185\u5b58\u5360\u7528\u5c11"}),"\n",(0,t.jsx)(e.h3,{id:"\u7f3a\u70b9",children:"\u7f3a\u70b9"}),"\n",(0,t.jsxs)(e.p,{children:["\u4e34\u754c\u95ee\u9898\uff1a\u7a97\u53e3\u5207\u6362\u65f6\u53ef\u80fd\u51fa\u73b0\u7a81\u53d1\u6d41\u91cf\uff0c\u4f8b\u5982\u65f6\u95f4\u7a97\u53e3\u4e3a1\u79d2\uff0c\u524d1\u79d2\u7684\u540e500ms\u548c\u540e1\u79d2\u7684\u524d500ms\u53ef\u80fd\u5171\u540c\u901a\u8fc72 * ",(0,t.jsx)(e.code,{children:"threshold"}),"\u7684\u8bf7\u6c42."]}),"\n",(0,t.jsxs)(e.p,{children:["\u8fd9\u6837\u5b9e\u9645\u57281s\u901a\u8fc7\u4e862 * ",(0,t.jsx)(e.code,{children:"threshold"}),"\u7684\u8bf7\u6c42\u6570\u91cf\uff0c\u6ca1\u6709\u9650\u6d41\u4f4f"]}),"\n",(0,t.jsx)(e.h3,{id:"\u9002\u7528\u573a\u666f",children:"\u9002\u7528\u573a\u666f"}),"\n",(0,t.jsxs)(e.ol,{children:["\n",(0,t.jsx)(e.li,{children:"\u4f4e\u9891\u63a5\u53e3\uff08\u5982\u540e\u53f0\u7ba1\u7406\u7cfb\u7edf\uff09"}),"\n",(0,t.jsx)(e.li,{children:"\u5bf9\u9650\u6d41\u7cbe\u5ea6\u8981\u6c42\u4e0d\u9ad8\u7684\u573a\u666f"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"\u4ee3\u7801\u5b9e\u73b0",children:"\u4ee3\u7801\u5b9e\u73b0"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:"public class FixedWindowCounter {\n\n    /**\n     * \u9650\u6d41\u9608\u503c\n     */\n    private final int threshold;\n\n    /**\n     * \u7a97\u53e3\u65f6\u95f4(\u6beb\u79d2)\n     */\n    private final long windowMs;\n\n    /**\n     * \u4e0a\u6b21\u91cd\u7f6e\u65f6\u95f4\n     */\n    private long lastResetTime;\n\n    /**\n     * \u8ba1\u6570\u5668\n     */\n    private AtomicLong counter;\n\n    public FixedWindowCounter(int threshold, long windowMs) {\n        this.windowMs = windowMs;\n        this.threshold = threshold;\n        this.lastResetTime = System.currentTimeMillis();\n        this.counter = new AtomicLong(0);\n    }\n\n    public boolean allowRequest() {\n        long now = System.currentTimeMillis();\n        if (now > lastResetTime + windowMs) {\n            lastResetTime = now;\n            counter.set(0);\n        }\n        return counter.incrementAndGet() <= threshold;\n    }\n\n}\n"})}),"\n",(0,t.jsx)(e.h3,{id:"\u9650\u6d41\u6d4b\u8bd5",children:"\u9650\u6d41\u6d4b\u8bd5"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:'    public static void main(String[] args) throws Exception {\n\n        FixedWindowCounter counter = new FixedWindowCounter(3, 1000);\n\n        // \u6a21\u62df\u7b2c1\u79d2\u5185\u7684\u8bf7\u6c42\n        System.out.println("===== \u7b2c1\u79d2\u53d1\u90015\u6b21\u8bf7\u6c42 =====");\n        for (int i = 1; i <= 5; i++) {\n            System.out.printf("\u8bf7\u6c42 %d: %s\\n", i, counter.allowRequest() ? "\u901a\u8fc7" : "\u88ab\u9650\u6d41");\n        }\n\n        // \u7b49\u5f851\u79d2\uff0c\u8fdb\u5165\u4e0b\u4e00\u4e2a\u7a97\u53e3\n        TimeUnit.SECONDS.sleep(1);\n\n        // \u6a21\u62df\u7b2c2\u79d2\u5185\u7684\u8bf7\u6c42\n        System.out.println("===== \u7b2c2\u79d2\u53d1\u90015\u6b21\u8bf7\u6c42 =====");\n        for (int i = 6; i <= 10; i++) {\n            System.out.printf("\u8bf7\u6c42 %d: %s\\n", i, counter.allowRequest() ? "\u901a\u8fc7" : "\u88ab\u9650\u6d41");\n        }\n\n    }\n'})}),"\n",(0,t.jsx)(e.h2,{id:"\u6ed1\u52a8\u7a97\u53e3",children:"\u6ed1\u52a8\u7a97\u53e3"}),"\n",(0,t.jsx)(e.h3,{id:"\u539f\u7406-1",children:"\u539f\u7406"}),"\n",(0,t.jsx)(e.p,{children:"\u5c06\u65f6\u95f4\u7a97\u53e3\u5212\u5206\u4e3a\u66f4\u7ec6\u7c92\u5ea6\u7684\u5b50\u7a97\u53e3\uff08\u5982\u5c061\u79d2\u5206\u4e3a10\u4e2a100ms\u7684\u5b50\u7a97\u53e3\uff09"}),"\n",(0,t.jsx)(e.p,{children:"\u7edf\u8ba1\u6ed1\u52a8\u7a97\u53e3\u5185\u6240\u6709\u5b50\u7a97\u53e3\u7684\u8bf7\u6c42\u603b\u6570\uff0c\u52a8\u6001\u6e05\u7406\u8fc7\u671f\u7684\u5b50\u7a97\u53e3"}),"\n",(0,t.jsxs)(e.blockquote,{children:["\n",(0,t.jsx)(e.p,{children:"\u6ed1\u52a8\u7a97\u53e3\u662f\u4e3a\u4e86\u89e3\u51b3\u56fa\u5b9a\u7a97\u53e3\u4e34\u754c\u7a97\u53e3\u5207\u6362\u7684\u95ee\u9898"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"\u4f18\u70b9-1",children:"\u4f18\u70b9"}),"\n",(0,t.jsx)(e.p,{children:"\u6bd4\u56fa\u5b9a\u7a97\u53e3\u66f4\u7cbe\u51c6\uff0c\u53ef\u4ee5\u7f13\u89e3\u4e34\u754c\u95ee\u9898"}),"\n",(0,t.jsx)(e.h3,{id:"\u7f3a\u70b9-1",children:"\u7f3a\u70b9"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u5185\u5b58\u5360\u7528\u8fc7\u9ad8:\u6bcf\u4e2a\u8bf7\u6c42\u7684\u65f6\u95f4\u6233\u90fd\u9700\u8981\u8bb0\u5f55\uff0c\u9ad8QPS\u573a\u666f\u4e0b\u5185\u5b58\u538b\u529b\u5927"}),"\n",(0,t.jsx)(e.li,{children:"\u7ec6\u7c92\u5ea6\u6ed1\u52a8\u7a97\u53e3\u5b9e\u73b0\u590d\u6742"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"\u9002\u7528\u573a\u666f-1",children:"\u9002\u7528\u573a\u666f"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"\u9700\u8981\u8f83\u9ad8\u9650\u6d41\u7cbe\u5ea6\u7684\u573a\u666f\uff08\u5982API\u7f51\u5173\uff09\u3002"}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"\u6d41\u91cf\u6ce2\u52a8\u8f83\u5927\u4f46QPS\u9002\u4e2d\u7684\u573a\u666f\uff08\u5982\u6bcf\u79d2\u6570\u5343\u6b21\u8bf7\u6c42\uff09\u3002"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"\u4ee3\u7801\u5b9e\u73b0-1",children:"\u4ee3\u7801\u5b9e\u73b0"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:"public class SlidingWindow {\n\n    /**\n     * \u9650\u6d41\u9608\u503c\uff08\u7a97\u53e3\u5185\u6700\u5927\u8bf7\u6c42\u6570\uff09\n     */\n    private final int threshold;\n\n    /**\n     * \u7a97\u53e3\u65f6\u95f4(\u6beb\u79d2)\n     */\n    private final long windowMs;\n\n    /**\n     * \u8bf7\u6c42\u65f6\u95f4\u6233\u961f\u5217\n     */\n    private final ConcurrentLinkedDeque<Long> window;\n\n    /**\n     * \u5f53\u524d\u7a97\u53e3\u4e2d\u7684\u8bf7\u6c42\u8ba1\u6570\uff08\u907f\u514d\u9891\u7e41\u8ba1\u7b97size\uff09\n     */\n    private final AtomicInteger counter;\n\n    private final Lock lock;\n    \n    /**\n     * \u4e0a\u6b21\u6e05\u7406\u65f6\u95f4\n     */\n    private long lastCleanupTime;\n\n    /**\n     * @param threshold \u9650\u6d41\u9608\u503c\uff08\u7a97\u53e3\u5185\u6700\u5927\u8bf7\u6c42\u6570\uff09\n     * @param windowMs  \u7a97\u53e3\u65f6\u95f4(\u6beb\u79d2)\n     */\n    public SlidingWindow(int threshold, long windowMs) {\n        this.threshold = threshold;\n        this.windowMs = windowMs;\n        this.window = new ConcurrentLinkedDeque<>();\n        this.counter = new AtomicInteger(0);\n        this.lock = new ReentrantLock();\n        this.lastCleanupTime = System.currentTimeMillis();\n    }\n\n    public boolean allowRequest() {\n        long now = System.currentTimeMillis();\n\n        if (now - lastCleanupTime > windowMs / 10) {\n            cleanup(now);\n        }\n        if (counter.get() < threshold) {\n            lock.lock();\n            // \u53cc\u91cd\u68c0\u67e5\n            try {\n                if (counter.get() < threshold) {\n                    window.add(now);\n                    counter.incrementAndGet();\n                    return true;\n                }\n            } finally {\n                lock.unlock();\n            }\n\n        }\n        return false;\n    }\n\n    private void cleanup(long now) {\n        lock.lock();\n        try {\n            int removed = 0;\n            while (!window.isEmpty() && now - window.peek() > windowMs) {\n                window.poll();\n                removed++;\n            }\n            if (removed > 0) {\n                counter.addAndGet(-removed);\n\n            }\n            lastCleanupTime = now;\n        } finally {\n            lock.unlock();\n        }\n    }\n\n    /**\n     * \u83b7\u53d6\u5f53\u524d\u7a97\u53e3\u5185\u7684\u8bf7\u6c42\u6570\n     *\n     * @return \u7a97\u53e3\u5185\u8bf7\u6c42\u6570\n     */\n\n    public int getCurrentWindowCount() {\n        // \u6e05\u7406\u8fc7\u671f\u6570\u636e\u540e\u518d\u8fd4\u56de\u8ba1\u6570\n        cleanup(System.currentTimeMillis());\n        return counter.get();\n    }\n\n\n    /**\n     * \u83b7\u53d6\u7a97\u53e3\u5bb9\u91cf\n     *\n     * @return \u7a97\u53e3\u6700\u5927\u8bf7\u6c42\u6570\n     */\n\n    public int getThreshold() {\n        return threshold;\n    }\n\n\n    /**\n     * \u83b7\u53d6\u7a97\u53e3\u65f6\u95f4\n     *\n     * @return \u7a97\u53e3\u65f6\u95f4(\u6beb\u79d2)\n     */\n\n    public long getWindowMs() {\n        return windowMs;\n    }\n\n\n    /**\n     * \u91cd\u7f6e\u6ed1\u52a8\u7a97\u53e3\n     * <p>\n     * \u6e05\u7a7a\u6240\u6709\u8bf7\u6c42\u8bb0\u5f55\n     */\n\n    public void reset() {\n        lock.lock();\n        try {\n            window.clear();\n            counter.set(0);\n            lastCleanupTime = System.currentTimeMillis();\n        } finally {\n            lock.unlock();\n        }\n    }\n}\n"})}),"\n",(0,t.jsx)(e.h3,{id:"\u9650\u6d41\u6d4b\u8bd5-1",children:"\u9650\u6d41\u6d4b\u8bd5"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:'    private static void testBasicThrottling() {\n        System.out.println("\\n===== \u6d4b\u8bd51: \u57fa\u672c\u9650\u6d41\u529f\u80fd =====");\n        // \u521b\u5efa\u4e00\u4e2a\u6bcf\u79d2\u6700\u591a\u5141\u8bb85\u4e2a\u8bf7\u6c42\u7684\u6ed1\u52a8\u7a97\u53e3\u9650\u6d41\u5668\n        SlidingWindow limiter = new SlidingWindow(5, 1000);\n        System.out.println("\u7a97\u53e3\u5927\u5c0f: 1\u79d2, \u9608\u503c: 5\u4e2a\u8bf7\u6c42");\n        System.out.println("\\n\u53d1\u900110\u4e2a\u8fde\u7eed\u8bf7\u6c42...");\n        for (int i = 0; i < 10; i++) {\n            boolean allowed = limiter.allowRequest();\n            System.out.printf("\u8bf7\u6c42 %2d: %s (\u7a97\u53e3\u5185\u8bf7\u6c42\u6570: %d)%n", (i + 1), (allowed ? "\u901a\u8fc7" : "\u62d2\u7edd"), limiter.getCurrentWindowCount());\n        }\n        System.out.println("\\n\u7ed3\u679c\u9a8c\u8bc1: \u524d5\u4e2a\u8bf7\u6c42\u5e94\u8be5\u901a\u8fc7\uff0c\u540e5\u4e2a\u5e94\u8be5\u88ab\u62d2\u7edd");\n    }\n'})}),"\n",(0,t.jsx)(e.h2,{id:"\u6f0f\u6876\u7b97\u6cd5",children:"\u6f0f\u6876\u7b97\u6cd5"}),"\n",(0,t.jsx)(e.h3,{id:"\u539f\u7406-2",children:"\u539f\u7406"}),"\n",(0,t.jsx)(e.p,{children:"\u8bf7\u6c42\u50cf\u6c34\u4e00\u6837\u4ee5\u4efb\u610f\u901f\u7387\u6d41\u5165\u6f0f\u6876\uff0c\u6876\u4ee5\u56fa\u5b9a\u901f\u7387\uff08\u5982\u6bcf\u79d25000\u6b21\uff09\u6f0f\u6c34\uff08\u5904\u7406\u8bf7\u6c42\uff09"}),"\n",(0,t.jsx)(e.p,{children:"\u82e5\u6876\u6ee1\uff08\u6c34\u91cf\u8d85\u8fc7\u5bb9\u91cf\uff09\uff0c\u5219\u62d2\u7edd\u65b0\u8bf7\u6c42"}),"\n",(0,t.jsx)(e.h3,{id:"\u4f18\u70b9-2",children:"\u4f18\u70b9"}),"\n",(0,t.jsx)(e.p,{children:"\u6d41\u91cf\u6574\u5f62\uff1a\u5f3a\u5236\u6052\u5b9a\u901f\u7387"}),"\n",(0,t.jsx)(e.h3,{id:"\u7f3a\u70b9-2",children:"\u7f3a\u70b9"}),"\n",(0,t.jsx)(e.p,{children:"\u65e0\u6cd5\u5e94\u5bf9\u7a81\u53d1\u6d41\u91cf\uff1a\u6f0f\u51fa\u901f\u7387\u56fa\u5b9a\uff0c\u65e0\u6cd5\u5229\u7528\u7cfb\u7edf\u7a7a\u95f2\u65f6\u7684\u5904\u7406\u80fd\u529b"}),"\n",(0,t.jsx)(e.h3,{id:"\u9002\u7528\u573a\u666f-2",children:"\u9002\u7528\u573a\u666f"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u9700\u8981\u5e73\u6ed1\u6d41\u91cf\u7684\u573a\u666f\uff08\u5982\u6570\u636e\u5e93\u5199\u5165\u4fdd\u62a4\uff09"}),"\n",(0,t.jsx)(e.li,{children:"\u4e25\u683c\u9650\u5236\u5904\u7406\u901f\u7387\u7684\u573a\u666f\uff08\u5982\u652f\u4ed8\u7cfb\u7edf\uff09"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"\u4ee3\u7801\u5b9e\u73b0-2",children:"\u4ee3\u7801\u5b9e\u73b0"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:"public class LeakyBucket {\n\n    /**\n     * \u6876\u5bb9\u91cf\uff08\u6700\u5927\u8bf7\u6c42\u6570\uff09\n     */\n    private final long capacity;\n\n    /**\n     * \u6f0f\u6c34\u901f\u7387\uff08\u8bf7\u6c42/\u79d2\uff09\n     */\n    private final double leakRatePerSecond;\n\n    /**\n     * \u5f53\u524d\u6c34\u91cf\uff08\u5f53\u524d\u7d2f\u79ef\u7684\u8bf7\u6c42\u6570\uff09\n     */\n    private double waterLevel;\n\n    /**\n     * \u4e0a\u6b21\u6f0f\u6c34\u65f6\u95f4\uff08\u6beb\u79d2\uff09\n     */\n    private long lastLeakTimeMs;\n\n    /**\n     * \u6784\u9020\u6f0f\u6876\u9650\u6d41\u5668\n     *\n     * @param capacity          \u6876\u5bb9\u91cf\uff08\u6700\u5927\u8bf7\u6c42\u6570\uff09\n     * @param leakRatePerSecond \u6bcf\u79d2\u6f0f\u6c34\u901f\u7387\uff08\u8bf7\u6c42/\u79d2\uff09\n     */\n    public LeakyBucket(long capacity, double leakRatePerSecond) {\n        this.capacity = capacity;\n        this.leakRatePerSecond = leakRatePerSecond;\n        this.waterLevel = 0;\n        this.lastLeakTimeMs = System.currentTimeMillis();\n    }\n\n    /**\n     * \u5c1d\u8bd5\u83b7\u53d6\u8bf7\u6c42\u8bb8\u53ef\n     *\n     * @return true\u8868\u793a\u8bf7\u6c42\u88ab\u5141\u8bb8\uff0cfalse\u8868\u793a\u8bf7\u6c42\u88ab\u9650\u6d41\n     */\n    public synchronized boolean allowRequest() {\n        long currentTimeMs = System.currentTimeMillis();\n        // \u8ba1\u7b97\u8ddd\u79bb\u4e0a\u6b21\u6f0f\u6c34\u7684\u65f6\u95f4\uff08\u79d2\uff09\n        double timeElapsedSeconds = (currentTimeMs - lastLeakTimeMs) / 1000.0;\n\n        // \u8ba1\u7b97\u6f0f\u51fa\u7684\u6c34\u91cf: \u65f6\u95f4(\u79d2) * \u6f0f\u6c34\u901f\u7387(\u8bf7\u6c42/\u79d2)\n        double leakedWater = timeElapsedSeconds * leakRatePerSecond;\n\n        // \u66f4\u65b0\u6c34\u4f4d\uff0c\u4e0d\u80fd\u4f4e\u4e8e0\n        waterLevel = Math.max(0, waterLevel - leakedWater);\n\n        // \u66f4\u65b0\u4e0a\u6b21\u6f0f\u6c34\u65f6\u95f4\n        lastLeakTimeMs = currentTimeMs;\n\n        // \u5982\u679c\u65b0\u8bf7\u6c42\u52a0\u5165\u540e\u6c34\u4f4d\u4e0d\u8d85\u8fc7\u5bb9\u91cf\uff0c\u5219\u63a5\u53d7\u8bf7\u6c42\n        if (waterLevel + 1 <= capacity) {\n            waterLevel++;\n            return true;\n        }\n\n        return false;\n    }\n\n    /**\n     * \u83b7\u53d6\u5f53\u524d\u6c34\u4f4d\uff08\u7528\u4e8e\u6d4b\u8bd5\u548c\u76d1\u63a7\uff09\n     *\n     * @return \u5f53\u524d\u6c34\u4f4d\n     */\n    public double getCurrentWaterLevel() {\n        return waterLevel;\n    }\n\n    /**\n     * \u83b7\u53d6\u5269\u4f59\u5bb9\u91cf\n     *\n     * @return \u6876\u7684\u5269\u4f59\u5bb9\u91cf\n     */\n    public double getRemainingCapacity() {\n        return capacity - waterLevel;\n    }\n}\n"})}),"\n",(0,t.jsx)(e.h3,{id:"\u9650\u6d41\u6d4b\u8bd5-2",children:"\u9650\u6d41\u6d4b\u8bd5"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:'    public static void main(String[] args) throws InterruptedException {\n        System.out.println("\\n===== \u6d4b\u8bd51: \u57fa\u672c\u9650\u6d41\u529f\u80fd =====");\n        // \u521b\u5efa\u4e00\u4e2a\u5bb9\u91cf\u4e3a5\uff0c\u6bcf\u79d2\u6f0f2\u4e2a\u8bf7\u6c42\u7684\u6f0f\u6876\n        LeakyBucket bucket = new LeakyBucket(5, 2.0);\n        System.out.println("\u6876\u5bb9\u91cf: 5, \u6f0f\u6c34\u901f\u7387: 2\u8bf7\u6c42/\u79d2");\n\n        System.out.println("\\n\u53d1\u900110\u4e2a\u8fde\u7eed\u8bf7\u6c42...");\n        for (int i = 0; i < 10; i++) {\n            boolean allowed = bucket.allowRequest();\n            System.out.printf("\u8bf7\u6c42 %2d: %s (\u6c34\u4f4d: %.2f)%n",\n                    (i + 1),\n                    (allowed ? "\u901a\u8fc7" : "\u62d2\u7edd"),\n                    bucket.getCurrentWaterLevel());\n        }\n\n        System.out.println("\\n\u7b49\u5f852\u79d2\u540e\u518d\u5c1d\u8bd5...");\n        Thread.sleep(2000);\n\n        for (int i = 0; i < 3; i++) {\n            boolean allowed = bucket.allowRequest();\n            System.out.printf("\u8bf7\u6c42 %2d: %s (\u6c34\u4f4d: %.2f)%n",\n                    (i + 1),\n                    (allowed ? "\u901a\u8fc7" : "\u62d2\u7edd"),\n                    bucket.getCurrentWaterLevel());\n        }\n    }\n'})}),"\n",(0,t.jsx)(e.h2,{id:"\u4ee4\u724c\u7b97\u6cd5",children:"\u4ee4\u724c\u7b97\u6cd5"}),"\n",(0,t.jsx)(e.h3,{id:"\u539f\u7406-3",children:"\u539f\u7406"}),"\n",(0,t.jsx)(e.p,{children:"\u7cfb\u7edf\u4ee5\u56fa\u5b9a\u901f\u7387\u5411\u6876\u4e2d\u6dfb\u52a0\u4ee4\u724c\uff0c\u6bcf\u4e2a\u8bf7\u6c42\u9700\u6d88\u8017\u4e00\u4e2a\u4ee4\u724c"}),"\n",(0,t.jsx)(e.p,{children:"\u82e5\u6876\u4e2d\u6709\u4ee4\u724c\uff0c\u5219\u5141\u8bb8\u8bf7\u6c42\uff1b\u82e5\u6876\u7a7a\uff0c\u5219\u62d2\u7edd\u8bf7\u6c42"}),"\n",(0,t.jsx)(e.h3,{id:"\u4f18\u70b9-3",children:"\u4f18\u70b9"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u5141\u8bb8\u7a81\u53d1\u6d41\u91cf"}),"\n",(0,t.jsx)(e.li,{children:"\u957f\u671f\u5e73\u5747\u901f\u7387\u53ef\u63a7"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"\u7f3a\u70b9-3",children:"\u7f3a\u70b9"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u5b9e\u73b0\u590d\u6742\u5ea6\u8f83\u9ad8"}),"\n",(0,t.jsx)(e.li,{children:"\u7a81\u53d1\u53ef\u80fd\u5bf9\u4e0b\u6e38\u9020\u6210\u538b\u529b"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"\u4f7f\u7528\u573a\u666f",children:"\u4f7f\u7528\u573a\u666f"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u9700\u8981\u5e94\u5bf9\u7a81\u53d1\u6d41\u91cf\u7684\u573a\u666f\uff08\u5982\u6d88\u606f\u961f\u5217\u3001API\u7f51\u5173\uff09"}),"\n",(0,t.jsx)(e.li,{children:"\u957f\u671f\u5e73\u5747\u901f\u7387\u9700\u4e25\u683c\u63a7\u5236\u7684\u573a\u666f\uff08\u5982\u4e91\u670d\u52a1API\u9650\u6d41\uff09"}),"\n"]}),"\n",(0,t.jsx)(e.h3,{id:"\u4ee3\u7801\u5b9e\u73b0-3",children:"\u4ee3\u7801\u5b9e\u73b0"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:"public class TokenBucket {\n\n    /**\n     * \u4ee4\u724c\u6876\u7684\u5bb9\u91cf\n     */\n    private final long capacity;\n\n    /**\n     * \u4ee4\u724c\u6dfb\u52a0\u901f\u7387\uff08\u4ee4\u724c/\u79d2\uff09\n     */\n    private final double refillRatePerSecond;\n\n    /**\n     * \u5f53\u524d\u4ee4\u724c\u6570\n     */\n    private double tokens;\n\n    /**\n     * \u4e0a\u6b21\u6dfb\u52a0\u4ee4\u724c\u7684\u65f6\u95f4\uff08\u6beb\u79d2\uff09\n     */\n    private long lastRefillTimeMs;\n\n    /**\n     * @param capacity            \u4ee4\u724c\u6876\u5bb9\u91cf\uff08\u6700\u5927\u4ee4\u724c\u6570\uff09\n     * @param refillRatePerSecond \u4ee4\u724c\u6dfb\u52a0\u901f\u7387\uff08\u4ee4\u724c/\u79d2\uff09\n     */\n    public TokenBucket(long capacity, double refillRatePerSecond) {\n        this.capacity = capacity;\n        this.refillRatePerSecond = refillRatePerSecond;\n        this.tokens = capacity; // \u521d\u59cb\u65f6\u6876\u662f\u6ee1\u7684\n        this.lastRefillTimeMs = System.currentTimeMillis();\n    }\n\n    /**\n     * \u5c1d\u8bd5\u83b7\u53d6\u4e00\u4e2a\u4ee4\u724c\n     *\n     * @return true\u8868\u793a\u83b7\u53d6\u6210\u529f\uff0cfalse\u8868\u793a\u83b7\u53d6\u5931\u8d25\n     */\n    public synchronized boolean allowRequest() {\n        return tryAcquire(1);\n    }\n\n    /**\n     * \u5c1d\u8bd5\u83b7\u53d6\u6307\u5b9a\u6570\u91cf\u7684\u4ee4\u724c\n     *\n     * @param tokensRequired\n     * @return\n     */\n    public synchronized boolean tryAcquire(long tokensRequired) {\n        refillTokens();\n        if (tokens >= tokensRequired) {\n            tokens -= tokensRequired;\n            return true;\n        }\n        return false;\n\n    }\n\n    private void refillTokens() {\n        long currentTimeMs = System.currentTimeMillis();\n        double elapsedSeconds = (currentTimeMs - lastRefillTimeMs) / 1000.0;\n        double tokensToAdd = elapsedSeconds * refillRatePerSecond;\n        if (tokensToAdd > 0) {\n            tokens = Math.min(capacity, tokens + tokensToAdd);\n            lastRefillTimeMs = currentTimeMs;\n        }\n    }\n\n    public synchronized double getTokens() {\n        refillTokens();\n        return tokens;\n    }\n}\n\n"})}),"\n",(0,t.jsx)(e.h3,{id:"\u9650\u6d41\u6d4b\u8bd5-3",children:"\u9650\u6d41\u6d4b\u8bd5"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-java",children:'    public static void main(String[] args) throws Exception {\n        System.out.println("\\n===== \u6d4b\u8bd51: \u57fa\u672c\u9650\u6d41\u529f\u80fd =====");\n        // \u521b\u5efa\u5bb9\u91cf\u4e3a5\uff0c\u6bcf\u79d2\u751f\u62102\u4e2a\u4ee4\u724c\u7684\u9650\u6d41\u5668\n        TokenBucket limiter = new TokenBucket(5, 2);\n        System.out.println("\u4ee4\u724c\u6876\u5bb9\u91cf: 5, \u586b\u5145\u901f\u7387: 2\u4ee4\u724c/\u79d2");\n        System.out.println("\\n\u53d1\u900110\u4e2a\u8fde\u7eed\u8bf7\u6c42...");\n\n        for (int i = 0; i < 10; i++) {\n            boolean allowed = limiter.allowRequest();\n            System.out.printf("\u8bf7\u6c42 %2d: %s (\u5269\u4f59\u4ee4\u724c: %.2f)%n", (i + 1), (allowed ? "\u901a\u8fc7" : "\u62d2\u7edd"), limiter.getTokens());\n        }\n        System.out.println("\\n\u7ed3\u679c\u9a8c\u8bc1: \u7531\u4e8e\u521d\u59cb\u6876\u662f\u6ee1\u7684\uff0c\u524d5\u4e2a\u8bf7\u6c42\u5e94\u8be5\u901a\u8fc7\uff0c\u540e5\u4e2a\u5e94\u8be5\u88ab\u62d2\u7edd");\n    }\n\n'})})]})}function u(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(c,{...n})}):c(n)}},8453:(n,e,i)=>{i.d(e,{R:()=>s,x:()=>o});var l=i(6540);const t={},r=l.createContext(t);function s(n){const e=l.useContext(r);return l.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:s(n.components),l.createElement(r.Provider,{value:e},n.children)}}}]);