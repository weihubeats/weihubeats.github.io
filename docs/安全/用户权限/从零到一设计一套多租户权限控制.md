## 背景

设计一套运行多系统(租户)的权限系统


## 表结构设计


### 系统注册表

```sql
CREATE TABLE `sys_app` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `app_name` varchar(100) NOT NULL COMMENT '系统名称',
  `app_code` varchar(50) NOT NULL COMMENT '系统编码 (如: CRM, ERP)',
  `status` tinyint(4) DEFAULT '1' COMMENT '状态 1:正常 0:禁用',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_app_code` (`app_code`)
) ENGINE=InnoDB COMMENT='应用注册表';
```
### 菜单/按钮权限表 (定义逻辑权限，不包含具体URL)

```sql
CREATE TABLE `sys_menu` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `parent_id` bigint(20) DEFAULT '0',
  `app_code` varchar(50) NOT NULL,
  `name` varchar(50) NOT NULL COMMENT '菜单或按钮名称',
  `type` tinyint(4) NOT NULL COMMENT '1:菜单 2:按钮',
  `perm_code` varchar(100) NOT NULL COMMENT '权限标识 (如: user:add)',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_perm` (`perm_code`)
) COMMENT='前端资源(菜单/按钮)';
```

### API 接口表 (定义后端所有接口资源)

```sql
CREATE TABLE `sys_api` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `app_code` varchar(50) NOT NULL,
  `path` varchar(200) NOT NULL COMMENT '接口路径 (如: /api/user/**)',
  `method` varchar(10) DEFAULT 'ALL' COMMENT '请求方式: GET, POST, PUT, DELETE, ALL',
  `name` varchar(100) DEFAULT NULL COMMENT '接口描述',
  PRIMARY KEY (`id`)
) COMMENT='后端API接口';
```

### 菜单-API 绑定表 (一个按钮 -> 多个API)

```sql
CREATE TABLE `sys_menu_api` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `menu_id` bigint(20) NOT NULL COMMENT '关联sys_menu.id',
  `api_id` bigint(20) NOT NULL COMMENT '关联sys_api.id',
  PRIMARY KEY (`id`)
) COMMENT='权限与API的绑定关系';
```

### 角色-菜单绑定表

```sql
CREATE TABLE `sys_role_menu` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `role_id` bigint(20) NOT NULL,
  `menu_id` bigint(20) NOT NULL,
  PRIMARY KEY (`id`)
);
```

### 用户表

- sys_user

```sql
CREATE TABLE `sys_user` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `username` varchar(50) NOT NULL COMMENT '账号',
  `password` varchar(100) NOT NULL COMMENT '加密密码',
  `real_name` varchar(50) DEFAULT NULL COMMENT '真实姓名',
  `status` tinyint(4) DEFAULT '1' COMMENT '状态 1:正常 0:禁用',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`)
) ENGINE=InnoDB COMMENT='用户表';
```

### 角色表(归属于特定应用)

- sys_role

```sql
CREATE TABLE `sys_role` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `app_code` varchar(50) NOT NULL COMMENT '归属应用编码',
  `role_name` varchar(50) NOT NULL COMMENT '角色名称',
  `role_code` varchar(50) NOT NULL COMMENT '角色标识 (如: admin, user)',
  `status` tinyint(4) DEFAULT '1',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB COMMENT='角色表';
```

### 权限/菜单表 (菜单、按钮、API绑定)

```sql
CREATE TABLE `sys_permission` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `parent_id` bigint(20) DEFAULT '0' COMMENT '父ID',
  `app_code` varchar(50) NOT NULL COMMENT '归属应用编码',
  `name` varchar(50) NOT NULL COMMENT '名称 (如: 用户管理, 新增用户)',
  `type` tinyint(4) NOT NULL COMMENT '类型 1:目录 2:菜单 3:按钮/API',
  `perms` varchar(100) DEFAULT NULL COMMENT '权限标识 (如: sys:user:add)',
  `api_path` varchar(200) DEFAULT NULL COMMENT '后端接口路径 (可选，用于网关鉴权)',
  `route_path` varchar(200) DEFAULT NULL COMMENT '前端路由路径',
  `order_num` int(11) DEFAULT '0' COMMENT '排序',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB COMMENT='权限资源表';
```

### 用户-角色关联表

```sql
CREATE TABLE `sys_user_role` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `user_id` bigint(20) NOT NULL,
  `role_id` bigint(20) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_role` (`user_id`,`role_id`)
) ENGINE=InnoDB COMMENT='用户角色关联表';
```

### 角色-权限关联表

```sql
CREATE TABLE `sys_role_permission` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `role_id` bigint(20) NOT NULL,
  `permission_id` bigint(20) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_role_id` (`role_id`)
) ENGINE=InnoDB COMMENT='角色权限关联表';
```

## java代码实现

框架主要是`Spring Boot` + `Sa-Token` + `MyBatis Plus`

```xml
<dependency>
    <groupId>cn.dev33</groupId>
    <artifactId>sa-token-spring-boot3-starter</artifactId>
    <version>1.37.0</version>
</dependency>

<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-spring-boot3-starter</artifactId>
    <version>3.5.5</version>
</dependency>

```

自定义权限加载接口 (StpInterface)


```java
package com.example.auth.service;

import cn.dev33.satoken.stp.StpInterface;
import com.example.auth.mapper.SysUserMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.List;

/**
 * 自定义权限验证接口扩展
 */
@Component
public class StpInterfaceImpl implements StpInterface {

    @Autowired
    private SysUserMapper sysUserMapper;

    /**
     * 返回一个账号所拥有的权限码集合
     */
    @Override
    public List<String> getPermissionList(Object loginId, String loginType) {
        // loginId 即为 User ID
        Long userId = Long.valueOf(loginId.toString());
        
        // 编写 SQL: 
        // select distinct p.perms from sys_permission p
        // left join sys_role_permission rp on p.id = rp.permission_id
        // left join sys_user_role ur on rp.role_id = ur.role_id
        // where ur.user_id = ? and p.perms is not null
        return sysUserMapper.selectPermsByUserId(userId);
    }

    /**
     * 返回一个账号所拥有的角色标识集合 (权限与角色可分离)
     */
    @Override
    public List<String> getRoleList(Object loginId, String loginType) {
        Long userId = Long.valueOf(loginId.toString());
        // select distinct r.role_code from sys_role r ...
        return sysUserMapper.selectRoleCodesByUserId(userId);
    }
}
```

```xml
<select id="selectPermsByUserId" resultType="java.lang.String">
    SELECT DISTINCT p.perms
    FROM sys_permission p
    INNER JOIN sys_role_permission rp ON p.id = rp.permission_id
    INNER JOIN sys_user_role ur ON rp.role_id = ur.role_id
    WHERE ur.user_id = #{userId}
    AND p.status = 1
    AND p.perms IS NOT NULL
    AND p.perms != ''
</select>
```

### 登入登出接口实现

```java

@RestController
@RequestMapping("/auth")
public class AuthController {

    @Autowired
    private SysUserService userService;

    @PostMapping("/login")
    public SaResult login(@RequestBody LoginDto loginDto) {
        // 1. 校验账号密码 (伪代码)
        SysUser user = userService.getByUsername(loginDto.getUsername());
        if(user == null || !checkPwd(loginDto.getPassword(), user.getPassword())) {
            return SaResult.error("账号或密码错误");
        }

        // 2. 登录 (Sa-Token 会自动生成 Token 并注入 Cookie/Header)
        StpUtil.login(user.getId());
        
        // 3. 返回 Token 信息给前端
        SaTokenInfo tokenInfo = StpUtil.getTokenInfo();
        return SaResult.data(tokenInfo);
    }
    
    @RequestMapping("/logout")
    public SaResult logout() {
        StpUtil.logout();
        return SaResult.ok();
    }
}

```