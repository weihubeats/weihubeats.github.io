
```Mermaid
graph TB
    %% 定义样式
    classDef client fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef gateway fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;
    classDef stream fill:#e0f2f1,stroke:#00695c,stroke-width:2px;
    classDef storage fill:#f3e5f5,stroke:#8e24aa,stroke-width:2px;
    classDef app fill:#ffebee,stroke:#c62828,stroke-width:2px;
    classDef meta fill:#eeeeee,stroke:#616161,stroke-width:2px,stroke-dasharray: 5 5;

    %% 1. 采集层
    subgraph Collection_Layer [采集层: SDK & Probe]
        App[移动端/Web SDK]:::client
        Java[后端服务 Java/Spring Boot]:::client
        Agent[基础设施 Agent/Telegraf]:::client
    end

    %% 2. 接入层
    subgraph Ingestion_Layer [接入传输层: 高吞吐管道]
        Nginx[Nginx/OpenResty 网关]:::gateway
        Kafka[Apache Kafka 消息队列]:::gateway
    end

    %% 3. 计算层
    subgraph Processing_Layer [计算层: Flink 实时引擎]
        Flink_Clean[Flink清洗/校验]:::stream
        Flink_Split[Flink分流/聚合]:::stream
    end

    %% 4. 存储层
    subgraph Storage_Layer [存储层: 双模引擎]
        direction TB
        subgraph OLAP [埋点分析 （明细/宽表）]
            CK[(ClickHouse / StarRocks)]:::storage
        end
        subgraph TSDB [实时监控 （指标/时序）]
            VM[(VictoriaMetrics / Prometheus)]:::storage
        end
    end

    %% 5. 应用层
    subgraph Serving_Layer [应用展示层]
        Grafana[Grafana 运维大盘]:::app
        BI[自研 BI/产品分析平台]:::app
        Alert[AlertManager 告警中心]:::app
    end

    %% 6. 治理层
    subgraph Governance [元数据与治理]
        MySQL[(MySQL 元数据库)]:::meta
        DMP[DMP 埋点管理后台]:::meta
    end

    %% 连线关系
    App --> Nginx
    Java --> Nginx
    Agent --> Nginx
    Nginx --> |1. ProtoBuf/JSON| Kafka
    
    Kafka --> |2. 原始日志流| Flink_Clean
    
    %% 元数据关联
    DMP --> |录入埋点定义| MySQL
    MySQL -.-> |3. 广播校验规则/配置| Flink_Clean
    
    Flink_Clean --> |校验通过| Flink_Split
    Flink_Clean --> |校验失败| DeadLetter[死信队列]:::meta
    
    %% 分流逻辑
    Flink_Split --> |4.1 聚合 Metrics （QPS/Latency）| VM
    Flink_Split --> |4.2 清洗 Events （UserAction）| CK
    
    %% 展示与查询
    VM --> Grafana
    VM --> Alert
    CK --> BI
    CK --> |慢查询日志分析| Grafana
```