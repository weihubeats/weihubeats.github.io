<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-云原生/APISIX/APISIX实现http流量灰度方案的演进" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">APISIX实现http流量灰度方案的演进 | weihubeats</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://weihubeats.github.io/docs/云原生/APISIX/APISIX实现http流量灰度方案的演进"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="APISIX实现http流量灰度方案的演进 | weihubeats"><meta data-rh="true" name="description" content="这里是小奏,觉得文章不错可以关注公众号小奏技术"><meta data-rh="true" property="og:description" content="这里是小奏,觉得文章不错可以关注公众号小奏技术"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://weihubeats.github.io/docs/云原生/APISIX/APISIX实现http流量灰度方案的演进"><link data-rh="true" rel="alternate" href="https://weihubeats.github.io/docs/云原生/APISIX/APISIX实现http流量灰度方案的演进" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://weihubeats.github.io/docs/云原生/APISIX/APISIX实现http流量灰度方案的演进" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="weihubeats RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="weihubeats Atom Feed"><link rel="stylesheet" href="/assets/css/styles.ebd0f903.css">
<script src="/assets/js/runtime~main.8dd61067.js" defer="defer"></script>
<script src="/assets/js/main.fa9fc0e1.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><div class="announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">⭐️ If you like, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/weihubeats">GitHub</a> and follow me. This web site is updating!! </div><button type="button" aria-label="关闭" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/docs/intro">Tutorial</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">MQ</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/MQ/RocketMQ/最佳实践/RocketMQ创建Topic、GID创建规范">RocketMQ</a></li><li><a class="dropdown__link" href="/docs/MQ/Kafka/Apache Kafka 4.0新特性">Kafka</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Java</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/java/spring-boot/spring boot 2.7后不再推荐使用spring.factories自动装配">Spring Boot</a></li><li><a class="dropdown__link" href="/docs/java/spring-cloud/Spring Cloud Gateway/记一次Spring Cloud Gateway Netty线程性能优化">Spring Cloud</a></li><li><a class="dropdown__link" href="/docs/java/netty/@ChannelHandler.Sharable详解">Netty</a></li><li><a class="dropdown__link" href="/docs/java/idea/常用插件">idea</a></li><li><a class="dropdown__link" href="/docs/java/maven/Spotless maven统一代码格式">maven</a></li><li><a class="dropdown__link" href="/docs/java/性能优化/JMH使用">性能优化</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">APM</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/APM/skywalking/Skywalking出现TID:Ignored_Trace问题解决方案及源码定位">skywalking</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">云原生</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/云原生/Kubernetes/从0到1图文教你如何将spring boot项目部署到minikube中去">Kubernetes</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/云原生/APISIX/APISIX实现http流量灰度方案的演进">APISIX</a></li><li><a class="dropdown__link" href="/docs/云原生/Service-Mesh/Service Mesh的一些调研">Service Mesh</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/AI/MCP协议">AI</a><a class="navbar__item navbar__link" href="/docs/数据结构与算法/数据结构/链表/test">数据结构与算法</a><a class="navbar__item navbar__link" href="/docs/分布式系统/raft一致性算法论文">分布式系统</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">我的开源项目</a><ul class="dropdown__menu"><li><a href="https://github.com/weihubeats/event-bus-rocketmq-all" target="_blank" class="dropdown__link">event-bus-rocketmq-all<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/weihubeats/spring-boot-nebula" target="_blank" class="dropdown__link">spring-boot-nebula<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/weihubeats/fluxcache" target="_blank" class="dropdown__link">fluxcache<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/weihubeats/ddd-example" target="_blank" class="dropdown__link">ddd-example<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/weihubeats/Asuna" target="_blank" class="dropdown__link">Asuna<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/weihubeats/mq-idempotent" target="_blank" class="dropdown__link">mq-idempotent<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://github.com/weihubeats/mybatis-plus-generator" target="_blank" class="dropdown__link">mybatis-plus-generator<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/weihubeats" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/云原生/APISIX/APISIX实现http流量灰度方案的演进">APISIX实现http流量灰度方案的演进</a></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">APISIX实现http流量灰度方案的演进</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>APISIX实现http流量灰度方案的演进</h1></header><blockquote>
<p>这里是<strong>小奏</strong>,觉得文章不错可以关注公众号<strong>小奏技术</strong></p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="背景">背景<a href="#背景" class="hash-link" aria-label="背景的直接链接" title="背景的直接链接">​</a></h2>
<p>想要实现<code>http</code>流量灰度的核心还是看你用什么网关，才能决定你用什么技术方案。</p>
<p>如果我们想用<code>spring cloud gateway</code>那一套，那么我们就需要自己去开发一些路由规则。</p>
<p>本次我们讨论的是云原生网关<code>apisix</code>的一种灰度发布实现方式</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="基于k8s的单service-pod替换">基于k8s的单service pod替换<a href="#基于k8s的单service-pod替换" class="hash-link" aria-label="基于k8s的单service pod替换的直接链接" title="基于k8s的单service pod替换的直接链接">​</a></h2>
<p>实际最简单的方案就是我们可以基于<code>kubernetes</code>的服务发现来做
比如我们有一个<code>search</code>服务，有3个pod</p>
<p><img decoding="async" loading="lazy" alt="alt text" src="data:image/png;base64,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" width="372" height="278" class="img_ev3q"></p>
<p>我们可以发版只发布修改一个pod实现最简单的灰度</p>
<p><img decoding="async" loading="lazy" alt="alt text" src="data:image/png;base64,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" width="368" height="287" class="img_ev3q"></p>
<p>但是这样有一个最明显的弊端，我们无法精准控制灰度流量比例。在apisix那边对应只有一个<code>upstream</code>(上游服务)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="基于k8s的多serviceapisix-traffic-split插件">基于k8s的多service+apisix traffic-split插件<a href="#基于k8s的多serviceapisix-traffic-split插件" class="hash-link" aria-label="基于k8s的多service+apisix traffic-split插件的直接链接" title="基于k8s的多service+apisix traffic-split插件的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="traffic-split插件">traffic-split插件<a href="#traffic-split插件" class="hash-link" aria-label="traffic-split插件的直接链接" title="traffic-split插件的直接链接">​</a></h3>
<p><code>traffic-split</code> 插件可以通过配置<code>match</code> 和 <code>weighted_upstreams</code> 属性，从而动态地将部分流量引导至各种上游服务。该插件可应用于灰度发布和蓝绿发布的场景</p>
<ul>
<li><a href="https://apisix.apache.org/zh/docs/apisix/plugins/traffic-split/" target="_blank" rel="noopener noreferrer">官方文档</a>:<a href="https://apisix.apache.org/zh/docs/apisix/plugins/traffic-split/" target="_blank" rel="noopener noreferrer">https://apisix.apache.org/zh/docs/apisix/plugins/traffic-split/</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="举个">举个🌰<a href="#举个" class="hash-link" aria-label="举个🌰的直接链接" title="举个🌰的直接链接">​</a></h3>
<p>比如现在<code>search</code>需要进行蓝绿发布。那么我们需要首先创建两个上游服务</p>
<ul>
<li><code>search</code></li>
<li><code>search-gray</code></li>
</ul>
<p><img decoding="async" loading="lazy" alt="alt text" src="/assets/images/apisix-dashboard-upstream-e7ed8cc0b10a330f9a160ed42c1286c9.png" width="1404" height="621" class="img_ev3q"></p>
<p>对应的也是两个<code>kubernetes</code>的 <code>service</code></p>
<ul>
<li>
<p>search-service</p>
</li>
<li>
<p>search-service-gray</p>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="alt text" src="/assets/images/search-and-search-gray-1fb5ca5fa4b8d7441017afca8c31f30c.png" width="779" height="304" class="img_ev3q"></p>
<p>然后我们配置<code>traffic-split</code>插件</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;plugins&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;traffic-split&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;rules&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;match&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token property" style="color:#36acaa">&quot;vars&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;http_release_version&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;==&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;小奏技术&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;weighted_upstreams&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token property" style="color:#36acaa">&quot;upstream_id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;search_gray_upstream_id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token property" style="color:#36acaa">&quot;weight&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;match&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token property" style="color:#36acaa">&quot;vars&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token property" style="color:#36acaa">&quot;weighted_upstreams&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token property" style="color:#36acaa">&quot;upstream_id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;search_upstream_id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token property" style="color:#36acaa">&quot;weight&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">90</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token property" style="color:#36acaa">&quot;upstream_id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;search_gray_upstream_id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token property" style="color:#36acaa">&quot;weight&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>注意这里我们配置了两条规则</p>
<ol>
<li>第一条规则是针对带有特定 HTTP 头 <code>http_release_version</code> 等于 <code>小奏技术</code> 的请求。这些请求将被100%路由到新版本的 <code>search_gray</code> 服务。</li>
<li>第二条规则是默认规则，适用于所有其他请求。在这个例子中，我们将90%的流量路由到旧版本的 <code>search</code> 服务，将10%的流量路由到灰度的 <code>search</code> 服务</li>
</ol>
<blockquote>
<p>注意原生的<code>traffic-split</code>插件比较简陋，不支持<code>uid</code>这种自定义参数,需要自己开发,自定义请求头参数仅支持<code>http_</code>开头的，比如<code>http_x_user_id</code></p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="alt text" src="/assets/images/apisix-route-http-22939de6e8f0c32f0f4651ca0ce4e420.png" width="2066" height="1308" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接">​</a></h2>
<p>总的来说基于<code>apisix</code>实现灰度发布还是比较简单的，实现方式有多种，区别主要还是<code>kubernetes</code>中是多个<code>service</code>还是单个<code>service</code></p>
<p>相对来说多<code>service</code>是<code>apisix</code>更推荐的做法，也能更精准控制流量。</p>
<p>但是相对于java传统的比如<code>spring cloud</code>和<code>dubbo</code>这些服务发现框架来说都是单<code>service</code>的元数据管理不太一样</p>
<p>所以后续要实现全链路灰度可能会有比较大的不同</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/云原生/APISIX/APISIX实现http流量灰度方案的演进.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#背景" class="table-of-contents__link toc-highlight">背景</a></li><li><a href="#基于k8s的单service-pod替换" class="table-of-contents__link toc-highlight">基于k8s的单service pod替换</a></li><li><a href="#基于k8s的多serviceapisix-traffic-split插件" class="table-of-contents__link toc-highlight">基于k8s的多service+apisix traffic-split插件</a><ul><li><a href="#traffic-split插件" class="table-of-contents__link toc-highlight">traffic-split插件</a></li><li><a href="#举个" class="table-of-contents__link toc-highlight">举个🌰</a></li></ul></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/weihubeats" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>