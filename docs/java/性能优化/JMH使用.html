<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-java/性能优化/JMH使用" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">JMH使用 | weihubeats</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://weihubeats.github.io/docs/java/性能优化/JMH使用"><meta data-rh="true" property="og:locale" content="zh_Hans"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="JMH使用 | weihubeats"><meta data-rh="true" name="description" content="JMH简介"><meta data-rh="true" property="og:description" content="JMH简介"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://weihubeats.github.io/docs/java/性能优化/JMH使用"><link data-rh="true" rel="alternate" href="https://weihubeats.github.io/docs/java/性能优化/JMH使用" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://weihubeats.github.io/docs/java/性能优化/JMH使用" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://JBXS0UZTOD-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"JMH使用","item":"https://weihubeats.github.io/docs/java/性能优化/JMH使用"}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="weihubeats RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="weihubeats Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="weihubeats" href="/opensearch.xml">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.d2ea1ebd.css">
<script src="/assets/js/runtime~main.ad90be84.js" defer="defer"></script>
<script src="/assets/js/main.c708d928.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const a=new URLSearchParams(window.location.search).entries();for(var[t,e]of a)if(t.startsWith("docusaurus-data-")){var n=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(n,e)}}catch(t){}}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><div class="theme-announcement-bar announcementBar_mb4j" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">⭐️ If you like, give it a star on <a target="_blank" rel="noopener noreferrer" href="https://github.com/weihubeats">GitHub</a> and follow me. This web site is updating!! </div><button type="button" aria-label="关闭" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" href="/docs/intro">Tutorial</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">MQ</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/MQ/RocketMQ/最佳实践/RocketMQ pop消费详解">RocketMQ</a></li><li><a class="dropdown__link" href="/docs/MQ/Kafka/Apache Kafka 4.0新特性">Kafka</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Java</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/java/spring-boot/spring boot 2.7后不再推荐使用spring.factories自动装配">Spring Boot</a></li><li><a class="dropdown__link" href="/docs/java/spring-cloud/Spring Cloud Gateway/记一次Spring Cloud Gateway Netty线程性能优化">Spring Cloud</a></li><li><a class="dropdown__link" href="/docs/java/netty/@ChannelHandler.Sharable详解">Netty</a></li><li><a class="dropdown__link" href="/docs/java/RPC/Dubbo/Dubbo服务调用JDK版本不兼容如何解决">RPC</a></li><li><a class="dropdown__link" href="/docs/java/ORM/Mybatis/MyBatisy原生去XML化的骚操作代码">ORM</a></li><li><a class="dropdown__link" href="/docs/java/idea/从零开发一个Idea插件:根据java doc自动生成枚举代码">idea</a></li><li><a class="dropdown__link" href="/docs/java/maven/depclean-tutorial">maven</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/java/性能优化/JMH使用">性能优化</a></li><li><a class="dropdown__link" href="/docs/java/系统重构/旧系统多租户改造">系统重构</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">GO</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/GO/GO基础/GO中的指针">GO基础</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/Python/Python新增虚拟环境">Python</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">APM</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/APM/skywalking/Skywalking出现TID:Ignored_Trace问题解决方案及源码定位">skywalking</a></li><li><a class="dropdown__link" href="/docs/APM/OpenTelemetry/什么是OpenTelemetry">OpenTelemetry</a></li><li><a class="dropdown__link" href="/docs/APM/Prometheus/Prometheus指标类型说明以及命名规范">Prometheus</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">云原生</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/云原生/Kubernetes/Kubernetes中的Service Account是什么及实战">Kubernetes</a></li><li><a class="dropdown__link" href="/docs/云原生/APISIX/APISIX实现http流量灰度方案的演进">APISIX</a></li><li><a class="dropdown__link" href="/docs/云原生/Service-Mesh/Service Mesh的一些调研">Service Mesh</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">DevOps</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/devops/cicd/github workflow+docker实现自动集成测试">CI/CD</a></li></ul></div><a class="navbar__item navbar__link" href="/docs/AI/AI Agent开发">AI</a><a class="navbar__item navbar__link" href="/docs/数据结构与算法/数据结构/链表/test">数据结构与算法</a><a class="navbar__item navbar__link" href="/docs/分布式系统/raft一致性算法论文">分布式系统</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">数据库</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/数据库/MySQL/MySQL亿级大表如何变更字段类型">MySQL</a></li><li><a class="dropdown__link" href="/docs/数据库/PostgreSQL/PG常用SQL">PostgreSQL</a></li><li><a class="dropdown__link" href="/docs/数据库/ClickHouse/test">ClickHouse</a></li><li><a class="dropdown__link" href="/docs/数据库/Redis/Redis集群模式演变">Redis</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">安全</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/安全/用户权限/OAuth 2.0是什么">用户权限</a></li><li><a class="dropdown__link" href="/docs/安全/软件/KeePassXC-本地密码安全管理">软件</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">我的开源项目</a><ul class="dropdown__menu"><li><a href="https://github.com/weihubeats/event-bus-rocketmq-all" target="_blank" class="dropdown__link">event-bus-rocketmq-all<svg width="12" height="12" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://github.com/weihubeats/spring-boot-nebula" target="_blank" class="dropdown__link">spring-boot-nebula<svg width="12" height="12" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://github.com/weihubeats/fluxcache" target="_blank" class="dropdown__link">fluxcache<svg width="12" height="12" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://github.com/weihubeats/ddd-example" target="_blank" class="dropdown__link">ddd-example<svg width="12" height="12" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://github.com/weihubeats/Asuna" target="_blank" class="dropdown__link">Asuna<svg width="12" height="12" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://github.com/weihubeats/mq-idempotent" target="_blank" class="dropdown__link">mq-idempotent<svg width="12" height="12" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li><a href="https://github.com/weihubeats/mybatis-plus-generator" target="_blank" class="dropdown__link">mybatis-plus-generator<svg width="12" height="12" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/weihubeats" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索 (Meta+k)" aria-keyshortcuts="Meta+k"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 24 24" aria-hidden="true"><circle cx="11" cy="11" r="8" stroke="currentColor" fill="none" stroke-width="1.4"></circle><path d="m21 21-4.3-4.3" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/java/性能优化/JMH使用"><span title="JMH使用" class="linkLabel_WmDU">JMH使用</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/java/性能优化/如何使用VisualVM进行性能分析本地java项目和远程java项目"><span title="如何使用VisualVM进行性能分析本地java项目和远程java项目" class="linkLabel_WmDU">如何使用VisualVM进行性能分析本地java项目和远程java项目</span></a></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">JMH使用</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>JMH使用</h1></header><h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="jmh简介">JMH简介<a href="#jmh简介" class="hash-link" aria-label="JMH简介的直接链接" title="JMH简介的直接链接" translate="no">​</a></h2>
<p>JMH (Java Microbenchmark Harness) 是 OpenJDK 团队开发的一个用于构建、运行和分析 Java 以及其他基于 JVM 语言的微基准测试（Microbenchmark）的工具。</p>
<p>它是一个专业的、高度精密的框架，旨在帮助开发者在 <code>JVM</code> 上准确地测量代码的性能</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="为什么需要jmh进行微基准测试">为什么需要JMH进行微基准测试<a href="#为什么需要jmh进行微基准测试" class="hash-link" aria-label="为什么需要JMH进行微基准测试的直接链接" title="为什么需要JMH进行微基准测试的直接链接" translate="no">​</a></h2>
<p>在 <code>JVM</code> 上进行准确的微基准测试非常困难，直接使用<code>System.nanoTime()</code> 或者简单的循环并不能得到可靠的性能测试结果</p>
<p>这主要是因为<code>JVM</code>在运行时会进行大量的优化，这些优化可能会极大地影响测量的准确性：</p>
<ol>
<li class="">
<p><code>JIT (Just-In-Time)</code> 编译器： <code>JVM</code> 会根据代码的执行情况进行即时编译，将热点代码编译成机器码以提高性能。这个过程本身需要时间，而且编译后的代码行为与解释执行时可能不同。简单的计时可能无法区分解释执行时间和编译后执行时间。</p>
</li>
<li class="">
<p>死代码消除 (Dead Code Elimination)： 如果你的测试代码计算了一个结果，但这个结果在测试方法中没有被使用或返回，JIT 编译器可能会认为这段计算是“死代码”而将其完全优化掉，导致你测量的结果是零开销。</p>
</li>
<li class="">
<p>常量折叠 (Constant Folding) 和逃逸分析 (Escape Analysis)： <code>JVM</code> 能够识别出在编译时就能确定的常量，或者确定对象不会逃逸出当前方法/线程，从而进行优化，例如将多次计算变为一次，或者在栈上分配对象而非堆上</p>
</li>
<li class="">
<p>垃圾回收 (Garbage Collection)： GC 暂停会影响你性能测试</p>
</li>
<li class="">
<p>分支预测 (Branch Prediction) 和缓存效应 (Cache Effects)： 这些底层硬件和操作系统层面的因素也会影响代码的执行速度，并且难以在简单的测试中控制。</p>
</li>
<li class="">
<p>方法内联 (Method Inlining): 小方法可能会被<code>JIT</code>直接嵌入到调用它的地方，消除方法调用的开销。</p>
</li>
<li class="">
<p>预热 (Warmup): <code>JVM</code> 和 <code>JIT</code> 编译器需要时间来“热身”，识别热点并进行优化。在优化完成之前测量的性能数据是不稳定的，不能代表代码在“完全优化”状态下的性能。</p>
</li>
</ol>
<p><code>JMH</code> 的目的就是通过精心设计的机制来应对这些挑战，提供一个相对可控和准确的环境来测量微小代码片段的性能</p>
<p>一些开源项目为了检验性能都会进行性能测试</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="jmh-特性">JMH 特性<a href="#jmh-特性" class="hash-link" aria-label="JMH 特性的直接链接" title="JMH 特性的直接链接" translate="no">​</a></h2>
<ul>
<li class="">
<p>处理<code>JVM</code>优化： 通过预热、运行多次迭代、防止死代码消除等方式，最大程度地减少<code>JIT</code>、<code>GC</code> 等因素对测量结果的影响。</p>
</li>
<li class="">
<p>多种测试模式： 支持吞吐量、平均时间、采样时间等多种性能指标测量。</p>
</li>
<li class="">
<p>状态管理： 允许定义和管理测试中使用的状态（数据），并控制状态的范围（Benchmark、Group、Thread）。</p>
</li>
<li class="">
<p>参数化测试： 支持通过<code>@Param</code> 注解使用不同的参数值运行同一基准测试方法。</p>
</li>
<li class="">
<p>控制运行环境： 可以控制线程数、JVM 分叉 (Fork) 数等，以模拟不同的并发场景和隔离测试。</p>
</li>
<li class="">
<p>丰富的输出： 提供详细的测试结果报告，包括得分、误差、单位等。</p>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="jmh-github地址">JMH GitHub地址<a href="#jmh-github地址" class="hash-link" aria-label="JMH GitHub地址的直接链接" title="JMH GitHub地址的直接链接" translate="no">​</a></h2>
<p><a href="https://github.com/openjdk/jmh" target="_blank" rel="noopener noreferrer" class="">https://github.com/openjdk/jmh</a></p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="常用注解介绍">常用注解介绍<a href="#常用注解介绍" class="hash-link" aria-label="常用注解介绍的直接链接" title="常用注解介绍的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="benchmark">@Benchmark<a href="#benchmark" class="hash-link" aria-label="@Benchmark的直接链接" title="@Benchmark的直接链接" translate="no">​</a></h3>
<p>作用：标记一个方法作为基准测试方法。JMH 会自动发现、运行并测量所有被 <code>@Benchmark</code> 注解标记的 public 方法（通常在带有 @State 注解的类中）</p>
<p>用法：直接放在方法声明前。方法通常没有参数，或者只接收 @State 对象作为参数</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Benchmark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public int myBenchmarkMethod() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 需要测试性能的代码块</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return 1 + 1; </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="benchmarkmode">@BenchmarkMode<a href="#benchmarkmode" class="hash-link" aria-label="@BenchmarkMode的直接链接" title="@BenchmarkMode的直接链接" translate="no">​</a></h3>
<ul>
<li class="">
<p>作用：定义基准测试的模式，即你想要测量的性能指标类型。可以作用于<strong>类或方法</strong>上。类级别的设置是默认值，方法级别的设置会覆盖类级别的设置</p>
</li>
<li class="">
<p>可选值：</p>
<ul>
<li class="">Mode.Throughput: 测量单位时间内操作完成的次数。例如，ops/sec (operations per second)。适用于衡量系统的处理能力</li>
<li class="">Mode.AverageTime：测量每次操作执行的平均时间。例如，ns/op (nanoseconds per operation)。适用于衡量单个操作的开销</li>
<li class="">Mode.SampleTime：测量操作时间的分布情况，可以得到中位数、百分位数等。适用于了解操作延迟的分布，识别长尾延迟</li>
<li class="">Mode.SingleShotTime：测量代码执行单次（或指定次数）的的总时间。不进行循环，主要用于测试初始化开销或不适合重复执行的代码</li>
<li class="">Mode.All: 同时运行所有模式</li>
</ul>
</li>
<li class="">
<p>用法：<code>@BenchmarkMode(Mode.AverageTime)</code> 或 <code>@BenchmarkMode({Mode.Throughput, Mode.AverageTime})</code></p>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="outputtimeunit">@OutputTimeUnit<a href="#outputtimeunit" class="hash-link" aria-label="@OutputTimeUnit的直接链接" title="@OutputTimeUnit的直接链接" translate="no">​</a></h3>
<ul>
<li class="">作用：指定基准测试结果报告中使用的时间单位。作用于类或方法上</li>
<li class="">可选值：<!-- -->
<ul>
<li class="">TimeUnit.NANOSECONDS：纳秒。</li>
<li class="">TimeUnit.MICROSECONDS：微秒。</li>
<li class="">TimeUnit.MILLISECONDS：毫秒。</li>
<li class="">TimeUnit.SECONDS：秒。</li>
</ul>
</li>
<li class="">用法：<code>@OutputTimeUnit(TimeUnit.NANOSECONDS)</code></li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="state">@State<a href="#state" class="hash-link" aria-label="@State的直接链接" title="@State的直接链接" translate="no">​</a></h4>
<ul>
<li class="">
<p>作用：定义测试的状态（测试中用到的数据）。</p>
</li>
<li class="">
<p>可选值：</p>
<ul>
<li class="">Scope.Benchmark：所有线程共享一个状态实例。</li>
<li class="">Scope.Thread：每个线程有自己的状态实例。</li>
<li class="">Scope.Group：每个线程组有自己的状态实例。</li>
</ul>
</li>
<li class="">
<p>用法：@State(Scope.Thread)。</p>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="setup">@Setup<a href="#setup" class="hash-link" aria-label="@Setup的直接链接" title="@Setup的直接链接" translate="no">​</a></h3>
<ul>
<li class="">
<p>作用：定义基准测试的状态对象。测试中需要用到的可变数据（如对象、集合、连接等）应该放在一个带有 @State 注解的类中。JMH 会负责创建和管理这些状态对象的实例</p>
</li>
<li class="">
<p>可选范围 (Scope)：</p>
</li>
<li class="">
<p><code>Scope.Benchmark</code>: 同一个基准测试的所有线程共享同一个状态实例。适用于测试需要共享资源或全局状态的场景。</p>
</li>
<li class="">
<p><code>Scope.Thread</code>: 每个执行基准测试的线程都拥有自己的独立状态实例。这是最常用的范围，适用于测试线程本地的性能，避免线程间的干扰。</p>
</li>
<li class="">
<p><code>Scope.Group</code>: (较少用) 每个线程组共享一个状态实例</p>
</li>
<li class="">
<p>用法：加在初始化方法上。</p>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="teardown">@TearDown<a href="#teardown" class="hash-link" aria-label="@TearDown的直接链接" title="@TearDown的直接链接" translate="no">​</a></h3>
<ul>
<li class="">
<p>作用：标记一个方法在测试结束后运行，用于清理资源。</p>
</li>
<li class="">
<p>用法：加在清理方法上。</p>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="warmup">@Warmup<a href="#warmup" class="hash-link" aria-label="@Warmup的直接链接" title="@Warmup的直接链接" translate="no">​</a></h3>
<ul>
<li class="">
<p>作用：在这个阶段，JMH 运行你的基准测试代码，但不记录性能数据。目的是让 JVM 完成 JIT 编译、加载类、进行各种优化等，使得后续的测量阶段在稳定的“热”状态下进行</p>
</li>
<li class="">
<p>可选值：</p>
<ul>
<li class="">iterations：预热迭代次数。</li>
<li class="">time：每轮预热迭代持续的时间</li>
<li class="">timeUnit：time 的时间单位（如 TimeUnit.SECONDS）</li>
<li class="">batchSize: 每轮迭代中执行操作的次数（默认是 1）</li>
</ul>
</li>
<li class="">
<p>用法：<code>@Warmup(iterations = 5, time = 1, timeUnit = TimeUnit.SECONDS)</code></p>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="measurement">@Measurement<a href="#measurement" class="hash-link" aria-label="@Measurement的直接链接" title="@Measurement的直接链接" translate="no">​</a></h3>
<ul>
<li class="">作用：配置测量阶段。在这个阶段，JMH 运行你的基准测试代码并记录性能数据。这些数据用于计算最终的得分</li>
<li class="">可选值：同@Warmup。</li>
<li class="">用法：<code>@Measurement(iterations = 5, time = 1, timeUnit = TimeUnit.SECONDS)</code>  表示进行 5 次测量迭代，每次迭代持续 1 秒</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="fork">@Fork<a href="#fork" class="hash-link" aria-label="@Fork的直接链接" title="@Fork的直接链接" translate="no">​</a></h3>
<ul>
<li class="">作用：指定运行基准测试的独立 JVM 进程数量。每个 Fork 会在一个全新的 JVM 进程中运行完整的 Warmup 和 Measurement 阶段。这有助于隔离不同基准测试之间的影响，避免 JVM 级别的状态（如系统属性、类加载器）相互干扰</li>
<li class="">用法：<code>@Fork(1)</code> 表示只在一个 JVM 进程中运行。<code>@Fork(value = 2, jvmArgs = &quot;-Xmx1g&quot;)</code> 表示在两个 JVM 进程中运行，并为每个进程设置 JVM 参数。对于准确的微基准测试，通常建议 @Fork(1) 或更多，以确保隔离性。@Fork(0) 可以用于调试，它在当前 JVM 进程中运行，但不推荐用于正式测量</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="threads">@Threads<a href="#threads" class="hash-link" aria-label="@Threads的直接链接" title="@Threads的直接链接" translate="no">​</a></h3>
<ul>
<li class="">
<p>作用：指定运行基准测试的线程数。这对于测试并发性能非常有用</p>
</li>
<li class="">
<p>用法：<code>@Threads(1)</code> 表示单线程运行。<code>@Threads(4)</code> 表示使用 4 个线程同时运行基准测试方法。默认值是可用处理器的数量</p>
</li>
</ul>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@State(Scope.Thread)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public static class ParamState {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Param({&quot;10&quot;, &quot;100&quot;, &quot;1000&quot;}) // 定义参数值列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int size; // JMH 会将列表中的值注入到这个字段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int[] data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Setup(Level.Trial)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        data = new int[size];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 初始化 data...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Benchmark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public int testParam(ParamState state) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 使用 state.size 和 state.data 进行测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return state.data.length;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="param">@Param<a href="#param" class="hash-link" aria-label="@Param的直接链接" title="@Param的直接链接" translate="no">​</a></h3>
<ul>
<li class="">
<p>作用： 参数化基准测试。允许同一个基准测试方法使用不同的输入参数值运行多次。这对于比较不同参数值对性能的影响非常方便</p>
</li>
<li class="">
<p>用法：@Param 注解标记 @State 类中的字段。JMH 会为 @Param 指定的每一个值运行一次完整的基准测试 Trial (Warmup + Measurement)</p>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="实战">实战<a href="#实战" class="hash-link" aria-label="实战的直接链接" title="实战的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="添加依赖">添加依赖<a href="#添加依赖" class="hash-link" aria-label="添加依赖的直接链接" title="添加依赖的直接链接" translate="no">​</a></h3>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.openjdk.jmh</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">jmh-core</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1.36</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.openjdk.jmh</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">jmh-generator-annprocess</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1.36</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="简单示例">简单示例<a href="#简单示例" class="hash-link" aria-label="简单示例的直接链接" title="简单示例的直接链接" translate="no">​</a></h3>
<p>这里我们以测试加法和乘法的简单基准测试进行演示</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import org.openjdk.jmh.annotations.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.openjdk.jmh.runner.Runner;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.openjdk.jmh.runner.RunnerException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.openjdk.jmh.runner.options.Options;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.openjdk.jmh.runner.options.OptionsBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.concurrent.TimeUnit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@State(Scope.Thread) // 定义状态范围为线程：每个测试线程拥有独立的状态实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@BenchmarkMode(Mode.AverageTime) // 测试模式：测量每次操作的平均执行时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@OutputTimeUnit(TimeUnit.NANOSECONDS) // 输出时间单位：结果将以纳秒为单位显示</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Warmup(iterations = 5, time = 1, timeUnit = TimeUnit.SECONDS) // 预热配置：进行5次预热迭代，每次持续1秒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Measurement(iterations = 5, time = 1, timeUnit = TimeUnit.SECONDS) // 测量配置：进行5次测量迭代，每次持续1秒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Fork(1) // Fork配置：在1个独立的JVM进程中运行测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Threads(1) // Threads配置：使用1个线程运行测试（默认也是可用核数）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SimpleBenchmark {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ------ State (状态) ------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 将测试中需要用到的变量或对象定义在这里</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int a;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int b;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ------ Setup (初始化) ------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // @Setup 方法用于在测试开始前初始化状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Level.Trial 表示在整个测试 Trial (Warmup + Measurement) 开始前执行一次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Setup(Level.Trial)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;Executing setup...&quot;); // 可选：打印信息看 setup 何时执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        a = 5; // 初始化变量 a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        b = 10; // 初始化变量 b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ------ TearDown (清理) ------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // @TearDown 方法用于在测试结束后进行清理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Level.Trial 表示在整个测试 Trial 结束后执行一次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @TearDown(Level.Trial)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void teardown() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;Executing teardown...&quot;); // 可选：打印信息看 teardown 何时执行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 在这个简单例子中没有需要清理的资源，但复杂的测试可能需要关闭连接、文件等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ------ Benchmarks (基准测试方法) ------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Benchmark // 标记这个方法是一个基准测试方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int testAddition() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 这是我们要测量性能的代码块：简单的加法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 返回结果有助于防止JMH优化掉整个计算（死代码消除）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return a + b;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Benchmark // 标记另一个基准测试方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int testMultiplication() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 这是我们要测量性能的代码块：简单的乘法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 返回结果有助于防止JMH优化掉整个计算</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return a * b;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ------ Main Method (运行入口) ------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 用于启动 JMH Runner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws RunnerException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 使用 OptionsBuilder 构建 JMH 运行选项</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Options opt = new OptionsBuilder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 指定要运行的基准测试类，可以使用正则表达式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // .include(SimpleBenchmark.class.getSimpleName()) // 精确匹配当前类</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .include(&quot;.*&quot; + SimpleBenchmark.class.getSimpleName() + &quot;.*&quot;) // 使用正则表达式匹配包含类名的任何方法</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 可以通过这里覆盖注解中的配置，或者添加更多配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // .threads(2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // .forks(2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // .warmupIterations(3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // .measurementIterations(3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建并运行 JMH Runner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Runner(opt).run();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>输出信息</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Benchmark                           Mode  Cnt  Score   Error  Units</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SimpleBenchmark.testAddition        avgt    5  0.559 ± 0.022  ns/op</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SimpleBenchmark.testMultiplication  avgt    5  0.582 ± 0.233  ns/op</span><br></span></code></pre></div></div>
<ul>
<li class="">
<p>Benchmark: 基准测试方法的名称 (类名.方法名)</p>
</li>
<li class="">
<p>Mode：测试模式 (avgt 表示 AverageTime)</p>
</li>
<li class="">
<p>Cnt：测量迭代的次数 (对应 @Measurement 的 iterations)</p>
</li>
<li class="">
<p>Score： JMH 计算出的得分</p>
<ul>
<li class="">如果 Mode 是 AverageTime (avgt)，Score 是每次操作的平均时间</li>
<li class="">如果 Mode 是 Throughput (thrpt)，Score 是每单位时间的平均操作次数</li>
</ul>
</li>
<li class="">
<p>Error：得分的置信区间误差 (通常是 99.9% 置信区间)。得分 ± Error 是得分可能落入的范围。误差越小，结果越稳定</p>
</li>
<li class="">
<p>Units： 得分的单位</p>
<ul>
<li class="">ns/op: 每次操作纳秒 (AverageTime)</li>
<li class="">ops/s: 每秒操作次数 (Throughput)</li>
<li class="">其他单位取决于 @OutputTimeUnit 和 @BenchmarkMode</li>
</ul>
</li>
</ul>
<p>在上面的例子中，testAddition 的平均耗时是 0.628 纳秒/操作，testMultiplication 是 0.623 纳秒/操作。误差值给出了结果的可信度范围。在这个例子中，加法和乘法操作的性能非常接近，且都非常快（微秒甚至纳秒级别）</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="并发测试">并发测试<a href="#并发测试" class="hash-link" aria-label="并发测试的直接链接" title="并发测试的直接链接" translate="no">​</a></h3>
<p>下面的例子演示<code>Scope.Thread</code> 和 <code>Scope.Benchmark</code> 的区别，</p>
<p>以及 <code>@Threads</code> 的用法。我们将测试一个简单的计数器，看看在单线程和多线程下，使用不同<code>Scope</code> 的状态类有什么表现</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@State(Scope.Benchmark) // 默认 Scope，这里显式指定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@BenchmarkMode(Mode.Throughput) // 测试吞吐量：每秒执行的操作次数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@OutputTimeUnit(TimeUnit.SECONDS) // 输出单位：秒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Warmup(iterations = 5, time = 1, timeUnit = TimeUnit.SECONDS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Measurement(iterations = 5, time = 1, timeUnit = TimeUnit.SECONDS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Fork(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class StateScopeBenchmark {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // --- State with Scope.Benchmark ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 所有线程共享同一个 BenchmarkState 实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @State(Scope.Benchmark)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static class BenchmarkState {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int counter = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AtomicInteger atomicCounter = new AtomicInteger(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Setup(Level.Trial)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;BenchmarkState Setup executed.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            counter = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            atomicCounter.set(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // --- State with Scope.Thread ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 每个线程拥有自己的 ThreadState 实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @State(Scope.Thread)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static class ThreadState {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int counter = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Setup(Level.Trial) // 注意这里 Level.Trial 对于 Scope.Thread 意味着每个线程在其 Trial 开始前执行一次</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;ThreadState Setup executed by thread: &quot; + Thread.currentThread().getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            counter = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // --- Benchmarks ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 测试共享状态下的非同步计数器 (在多线程下会有问题)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Benchmark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Threads(4) // 使用4个线程运行此基准测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int testSharedNonSyncCounter(BenchmarkState state) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 在多线程下，这个操作是线程不安全的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return state.counter++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 测试共享状态下的 AtomicInteger (线程安全)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Benchmark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Threads(4) // 使用4个线程运行此基准测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int testSharedAtomicCounter(BenchmarkState state) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // AtomicInteger 提供了原子操作，是线程安全的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return state.atomicCounter.getAndIncrement();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 测试线程本地状态下的计数器 (天然线程安全)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Benchmark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Threads(4) // 使用4个线程运行此基准测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int testThreadLocalCounter(ThreadState state) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 每个线程有自己的 state 实例，操作自己的 counter，所以是线程安全的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return state.counter++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 单线程运行共享状态的非同步计数器 (模拟单线程场景)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Benchmark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Threads(1) // 单线程运行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int testSharedNonSyncCounterSingleThread(BenchmarkState state) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return state.counter++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // --- Main Method ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws RunnerException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Options opt = new OptionsBuilder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .include(&quot;.*&quot; + StateScopeBenchmark.class.getSimpleName() + &quot;.*&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Runner(opt).run();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>输出信息</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Benchmark                                                  Mode  Cnt           Score           Error  Units</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StateScopeBenchmark.testSharedAtomicCounter               thrpt    5    44293326.270 ±   2074444.276  ops/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StateScopeBenchmark.testSharedNonSyncCounter              thrpt    5  1258488879.438 ±  76233314.786  ops/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StateScopeBenchmark.testSharedNonSyncCounterSingleThread  thrpt    5  1237277018.268 ± 431280040.241  ops/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">StateScopeBenchmark.testThreadLocalCounter                thrpt    5  5088064568.105 ± 597463435.932  ops/s</span><br></span></code></pre></div></div>
<blockquote>
<p>这里的模式是Mode.Throughput，吞吐量模式，<code>Score</code>越高，代表性能越强</p>
</blockquote>
<ul>
<li class="">
<p>testSharedAtomicCounter 在多线程下操作共享的 AtomicInteger，它提供了原子递增操作。性能最低，因为原子操作需要使用CPU的原子指令，会导致线程间的协调开销</p>
</li>
<li class="">
<p>testSharedNonSyncCounter 在多线程 (@Threads(4)) 下操作共享的非同步 counter。性能虽然高，但是结果是不正确的，因为线程间的竞争会导致计数不准确</p>
</li>
<li class="">
<p>testSharedNonSyncCounterSingleThread 在单线程下操作共享的非同步 counter，性能与多线程非同步版本相似，因为单线程不需要同步机制</p>
</li>
<li class="">
<p>testThreadLocalCounter 在多线程下操作线程本地的 counter，每个线程互不影响</p>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="参数化测试">参数化测试<a href="#参数化测试" class="hash-link" aria-label="参数化测试的直接链接" title="参数化测试的直接链接" translate="no">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import org.openjdk.jmh.annotations.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.openjdk.jmh.runner.Runner;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.openjdk.jmh.runner.RunnerException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.openjdk.jmh.runner.options.Options;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.openjdk.jmh.runner.options.OptionsBuilder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.concurrent.TimeUnit;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Random;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@State(Scope.Thread) // 每个线程拥有自己的状态实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@BenchmarkMode(Mode.AverageTime) // 测量平均时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@OutputTimeUnit(TimeUnit.MICROSECONDS) // 输出单位：微秒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Warmup(iterations = 5, time = 1, timeUnit = TimeUnit.SECONDS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Measurement(iterations = 5, time = 1, timeUnit = TimeUnit.SECONDS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Fork(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Threads(1) // 单线程测试，避免线程竞争对列表操作性能的影响</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ParameterizedBenchmark {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // --- State with @Param ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @State(Scope.Thread)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static class ListState {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 使用 @Param 定义参数，JMH 会自动为每个参数值运行一次完整的测试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Param({&quot;100&quot;, &quot;1000&quot;, &quot;10000&quot;}) // 测试列表大小为 100, 1000, 10000 的情况</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public int listSize; // 参数值会被注入到这个字段</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private List&lt;Integer&gt; list;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        private int elementToFind; // 用于 contains 操作的元素</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Setup(Level.Trial)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setup() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;Setting up list with size: &quot; + listSize);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            list = new ArrayList&lt;&gt;(listSize);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Random random = new Random(12345); // 使用固定种子保证可重复性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int i = 0; i &lt; listSize; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                list.add(random.nextInt()); // 填充随机整数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 选择一个可能在列表中的元素进行查找</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            elementToFind = list.get(listSize / 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @TearDown(Level.Trial)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void teardown() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            list = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // --- Benchmarks ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Benchmark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean testListContains(ListState state) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 测试 ArrayList 的 contains 方法性能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // state.listSize 会根据 @Param 的值变化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // state.list 是根据当前的 listSize 构建的列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return state.list.contains(state.elementToFind);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // --- Main Method ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws RunnerException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Options opt = new OptionsBuilder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .include(&quot;.*&quot; + ParameterizedBenchmark.class.getSimpleName() + &quot;.*&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 可以通过命令行参数指定要运行的参数，例如 -p listSize=100</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // .param(&quot;listSize&quot;, &quot;100&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Runner(opt).run();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="不同benchmarkmode">不同BenchmarkMode<a href="#不同benchmarkmode" class="hash-link" aria-label="不同BenchmarkMode的直接链接" title="不同BenchmarkMode的直接链接" translate="no">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@State(Scope.Thread)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Warmup(iterations = 5, time = 1, timeUnit = TimeUnit.SECONDS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Measurement(iterations = 5, time = 1, timeUnit = TimeUnit.SECONDS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Fork(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Threads(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ModeBenchmark {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int value = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // --- Benchmarks ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Benchmark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @BenchmarkMode(Mode.AverageTime) // 测量每次操作的平均时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @OutputTimeUnit(TimeUnit.NANOSECONDS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int testAverageTime() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 简单的递增操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return value++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Benchmark</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @BenchmarkMode(Mode.Throughput) // 测量每秒操作次数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @OutputTimeUnit(TimeUnit.SECONDS) // 结果单位是 ops/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int testThroughput() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 简单的递增操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return value++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // --- Main Method ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws RunnerException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Options opt = new OptionsBuilder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .include(&quot;.*&quot; + ModeBenchmark.class.getSimpleName() + &quot;.*&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Runner(opt).run();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<ul>
<li class="">
<p><code>testAverageTime</code> 使用 <code>Mode.AverageTime</code>，结果单位是 ns/op (纳秒/操作)。得分越低越好。</p>
</li>
<li class="">
<p><code>testThroughput</code> 使用 <code>Mode.Throughput</code>，结果单位是 ops/s (操作/秒)。得分越高越好</p>
</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="可视化">可视化<a href="#可视化" class="hash-link" aria-label="可视化的直接链接" title="可视化的直接链接" translate="no">​</a></h2>
<p>如果想要生成图形界面的结果，仅需将运行结果的json导入网站中</p>
<ul>
<li class=""><a href="http://deepoove.com/jmh-visual-chart/" target="_blank" rel="noopener noreferrer" class="">JMH Visual Chart</a></li>
<li class=""><a href="https://jmh.morethan.io/" target="_blank" rel="noopener noreferrer" class="">JMH Visualizer</a></li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="总结">总结<a href="#总结" class="hash-link" aria-label="总结的直接链接" title="总结的直接链接" translate="no">​</a></h2>
<p>JMH 是一个强大而专业的微基准测试工具，它能够帮助我们克服<code>JVM</code>优化带来的挑战，获取更准确的代码性能数据。</p>
<p>不过可以看到<code>JMH</code>的使用相对来说还是比较复杂的，想要写出合适的性能测试代码也是不容易的</p>
<p>如果早期对JMH不熟悉我们也可以多参考一些开源项目写的JMH程序。</p>
<p>比如我们可以参考<a href="https://github.com/FasterXML/jackson-benchmarks" target="_blank" rel="noopener noreferrer" class="">jackson</a>的性能测试代码，jackson单独提供了一个jackson-benchmarks进行性能测试，非常多的性能测试代码供我们学习研究</p>
<p>注意的高性能队列<code>disruptor</code>也有大量<code>JMH</code>测试代码，我们可以去学习</p>
<ul>
<li class=""><a href="https://github.com/LMAX-Exchange/disruptor/blob/master/src/jmh/java/com/lmax/disruptor/ArrayAccessBenchmark.java" target="_blank" rel="noopener noreferrer" class="">disruptor</a></li>
</ul>
<p>我们还需要注意微基准测试环境非常脆弱，任何微小的改动或外部干扰都可能影响结果。运行基准测试时，尽量在一个干净、稳定的环境中进行</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="参考">参考<a href="#参考" class="hash-link" aria-label="参考的直接链接" title="参考的直接链接" translate="no">​</a></h2>
<ul>
<li class=""><a href="https://github.com/openjdk/jmh" target="_blank" rel="noopener noreferrer" class="">https://github.com/openjdk/jmh</a></li>
<li class=""><a href="https://github.com/FasterXML/jackson-benchmarks" target="_blank" rel="noopener noreferrer" class="">https://github.com/FasterXML/jackson-benchmarks</a></li>
<li class=""><a href="https://github.com/openmessaging/benchmark" target="_blank" rel="noopener noreferrer" class="">https://github.com/openmessaging/benchmark</a></li>
<li class=""><a href="https://github.com/LMAX-Exchange/disruptor/tree/master/src/jmh/java/com/lmax/disruptor" target="_blank" rel="noopener noreferrer" class="">https://github.com/LMAX-Exchange/disruptor/tree/master/src/jmh/java/com/lmax/disruptor</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/java/性能优化/JMH使用.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--next" href="/docs/java/性能优化/如何使用VisualVM进行性能分析本地java项目和远程java项目"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">如何使用VisualVM进行性能分析本地java项目和远程java项目</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#jmh简介" class="table-of-contents__link toc-highlight">JMH简介</a></li><li><a href="#为什么需要jmh进行微基准测试" class="table-of-contents__link toc-highlight">为什么需要JMH进行微基准测试</a></li><li><a href="#jmh-特性" class="table-of-contents__link toc-highlight">JMH 特性</a></li><li><a href="#jmh-github地址" class="table-of-contents__link toc-highlight">JMH GitHub地址</a></li><li><a href="#常用注解介绍" class="table-of-contents__link toc-highlight">常用注解介绍</a><ul><li><a href="#benchmark" class="table-of-contents__link toc-highlight">@Benchmark</a></li><li><a href="#benchmarkmode" class="table-of-contents__link toc-highlight">@BenchmarkMode</a></li><li><a href="#outputtimeunit" class="table-of-contents__link toc-highlight">@OutputTimeUnit</a><ul><li><a href="#state" class="table-of-contents__link toc-highlight">@State</a></li></ul></li><li><a href="#setup" class="table-of-contents__link toc-highlight">@Setup</a></li><li><a href="#teardown" class="table-of-contents__link toc-highlight">@TearDown</a></li><li><a href="#warmup" class="table-of-contents__link toc-highlight">@Warmup</a></li><li><a href="#measurement" class="table-of-contents__link toc-highlight">@Measurement</a></li><li><a href="#fork" class="table-of-contents__link toc-highlight">@Fork</a></li><li><a href="#threads" class="table-of-contents__link toc-highlight">@Threads</a></li><li><a href="#param" class="table-of-contents__link toc-highlight">@Param</a></li></ul></li><li><a href="#实战" class="table-of-contents__link toc-highlight">实战</a><ul><li><a href="#添加依赖" class="table-of-contents__link toc-highlight">添加依赖</a></li><li><a href="#简单示例" class="table-of-contents__link toc-highlight">简单示例</a></li><li><a href="#并发测试" class="table-of-contents__link toc-highlight">并发测试</a></li><li><a href="#参数化测试" class="table-of-contents__link toc-highlight">参数化测试</a></li><li><a href="#不同benchmarkmode" class="table-of-contents__link toc-highlight">不同BenchmarkMode</a></li></ul></li><li><a href="#可视化" class="table-of-contents__link toc-highlight">可视化</a></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li><li><a href="#参考" class="table-of-contents__link toc-highlight">参考</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Tutorial</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/weihubeats" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>