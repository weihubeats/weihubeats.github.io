> è¿™é‡Œæ˜¯**weihubeats**,è§‰å¾—æ–‡ç« ä¸é”™å¯ä»¥å…³æ³¨å…¬ä¼—å·**å°å¥æŠ€æœ¯**ï¼Œæ–‡ç« é¦–å‘ã€‚æ‹’ç»è¥é”€å·ï¼Œæ‹’ç»æ ‡é¢˜å…š


## èƒŒæ™¯

å½“å‰çš„æ¶ˆè´¹è´Ÿè½½å‡è¡¡ç­–ç•¥æ˜¯ä»¥é˜Ÿåˆ—çš„ç»´åº¦æ¥è¿›è¡Œï¼Œæ‰€æœ‰è¡Œä¸ºå…¨éƒ¨æ˜¯ç”±**å®¢æˆ·ç«¯**ä¸»åŠ¨æ¥å®Œæˆï¼Œä¸»è¦åˆ†ä¸ºä¸‰æ­¥ï¼š

1. æ¯ä¸ªconsumerå®šæ—¶å»è·å–æ¶ˆè´¹çš„topicçš„é˜Ÿåˆ—æ€»æ•°ï¼Œä»¥åŠconsumeræ€»æ•°

2. å°†é˜Ÿåˆ—æŒ‰ç¼–å·ã€consumeræŒ‰ipæ’åºï¼Œç”¨ç»Ÿä¸€çš„åˆ†é…ç®—æ³•è®¡ç®—è¯¥consumeråˆ†é…å“ªäº›æ¶ˆè´¹é˜Ÿåˆ—

3. æ¯ä¸ªconsumerå»æ ¹æ®ç®—æ³•åˆ†é…å‡ºæ¥çš„é˜Ÿåˆ—ï¼Œæ‹‰å–æ¶ˆæ¯æ¶ˆè´¹


å­˜åœ¨çš„é—®é¢˜ï¼š

1. å®¢æˆ·ç«¯ä»£ç é€»è¾‘è¾ƒé‡ï¼Œè¦æ”¯æŒä¸€ç§æ–°è¯­è¨€çš„å®¢æˆ·ç«¯å°±å¿…é¡»å®ç°å®Œæ•´çš„é‡å¹³è¡¡é€»è¾‘ï¼Œæ­¤å¤–è¿˜éœ€è¦å®ç°æ‹‰æ¶ˆæ¯ã€ä½ç‚¹ç®¡ç†ã€æ¶ˆè´¹å¤±è´¥åå°†æ¶ˆæ¯å‘å› Broker é‡è¯•ç­‰é€»è¾‘ã€‚è¿™ç»™å¤šè¯­è¨€å®¢æˆ·ç«¯çš„æ”¯æŒé€ æˆå¾ˆå¤§çš„é˜»ç¢ã€‚
2. å½“å®¢æˆ·ç«¯å‡çº§æˆ–è€…ä¸‹çº¿æ—¶ï¼Œéƒ½è¦è¿›è¡Œé‡å¹³è¡¡æ“ä½œï¼Œå¯èƒ½é€ æˆæ¶ˆæ¯å †ç§¯ã€‚
3. å¦‚æœæœ‰ä¸€ä¸ªé˜Ÿåˆ—æœ‰å¼‚å¸¸ï¼ˆåº”ç”¨è‡ªèº«å¼‚å¸¸ï¼Œæˆ–æŸä¸ªbrokeråœ¨å‡çº§ï¼‰å¯¼è‡´æ¶ˆè´¹è¾ƒæ…¢æˆ–è€…åœæ­¢ï¼Œè¯¥é˜Ÿåˆ—ä¼šå‡ºç°å †ç§¯ç°è±¡ï¼Œå› ä¸ºé˜Ÿåˆ—ä¸ä¼šè¢«åˆ†é…ç»™å…¶ä»–æœºå™¨ï¼Œå› æ­¤å¦‚æœé•¿æ—¶é—´ä¸å¤„ç†ï¼Œé˜Ÿåˆ—çš„å †ç§¯ä¼šè¶Šæ¥è¶Šä¸¥é‡
4. æ¶ˆè´¹è€…æ— æ³•æ— é™æ‰©å±•ï¼Œå½“æ¶ˆè´¹è€…æ•°é‡æ‰©å¤§åˆ°å¤§äºé˜Ÿåˆ—æ•°é‡æ—¶ï¼Œæœ‰çš„æ¶ˆè´¹è€…å°†æ— æ³•åˆ†é…åˆ°é˜Ÿåˆ—ã€‚

## ç›®æ ‡
æ–°æ–¹æ¡ˆéœ€è¦ä¿è¯ä¸¤ç‚¹ï¼š

1. é«˜å¯ç”¨ï¼šå•ä¸€é˜Ÿåˆ—çš„æ¶ˆè´¹èƒ½åŠ›ä¸å—æŸä¸ªæ¶ˆè´¹å®¢æˆ·ç«¯å¼‚å¸¸çš„å½±å“

2. é«˜æ€§èƒ½ï¼šPOPè®¢é˜…å¯¹æ¶ˆæ¯æ¶ˆè´¹çš„å»¶è¿Ÿå’Œååçš„å½±å“åœ¨10%ä»¥å†…

## æ¶æ„è®¾è®¡

å½“å‰`pull`æ¨¡å¼æ¶æ„ä¸‹çš„æ¶ˆè´¹æ¨¡å‹å¦‚ä¸‹


![alt text](images/rocketmq-pull-design.png)

popçš„æ¶ˆè´¹æ¨¡å‹

![alt text](images/rocketmq-pop-design.png)

ä¸¾ä¸ªç®€å•ğŸŒ°

- topicåå­—: xiaozou
- queueæ•°é‡: 6(brokerA-Q1ã€brokerA-Q2ã€brokerB-Q1ã€brokerB-Q2ã€brokerC-Q1ã€brokerC-Q2)
- gid: gid_xiaozou
- æ¶ˆè´¹è€…æ•°é‡: 3(consumer-aã€consumer-bã€consumer-c)

- pushæ¶ˆè´¹æ¨¡å¼

consumer-a:brokerA-Q1ã€brokerB-Q1ã€brokerC-Q1

consumer-b: brokerA-Q2ã€okerB-Q2ã€bkerC-Q2

- popæ¶ˆè´¹æ¨¡å¼:

consumer-a:brokerA-Q1ã€brokerB-Q1ã€brokerC-Q1ã€brokerA-Q2ã€okerB-Q2ã€bkerC-Q2

consumer-b:brokerA-Q1ã€brokerB-Q1ã€brokerC-Q1ã€brokerA-Q2ã€okerB-Q2ã€bkerC-Q2


## popç‰¹æ€§

- å•ä¸ªå®¢æˆ·ç«¯æ¶ˆè´¹æ‰€æœ‰`queue`,é¿å…å•ä¸ª`client`å‡æ­»é€ æˆæ¶ˆæ¯å †ç§¯

- `Rebalance`åœ¨`broker`å®ç°ï¼Œæ–¹ä¾¿å¤šè¯­è¨€`client`å®ç°ç»´æŠ¤

## å¦‚ä½•åˆ‡æ¢

ç›®å‰æä¾›äº†ä¸¤ç§æ–¹å¼åˆ‡æ¢

### ç®¡ç†åå°åˆ‡æ¢

```
mqadmin setConsumeMode -c cluster -t topic -g group -m POP -q 8
```

### ä»£ç åˆ‡æ¢

```java
public class PopPushConsumer {

    public static final String CONSUMER_GROUP = "gid_pop_xiao-zou-topic";
    public static final String TOPIC = "xiao-zou-topic";

    // Or use AdminTools directly: mqadmin setConsumeMode -c cluster -t topic -g group -m POP -n 8
    private static void switchPop() throws Exception {

        DefaultMQAdminExt mqAdminExt = new DefaultMQAdminExt();
        mqAdminExt.setNamesrvAddr("http://localhost:9876");
        mqAdminExt.start();
        ClusterInfo clusterInfo = mqAdminExt.examineBrokerClusterInfo();
        Set<String> brokerAddrs = clusterInfo.getBrokerAddrTable().values().stream().map(BrokerData::selectBrokerAddr).collect(Collectors.toSet());
        for (String brokerAddr : brokerAddrs) {
            mqAdminExt.setMessageRequestMode(brokerAddr, TOPIC, CONSUMER_GROUP, MessageRequestMode.POP, 8, 3_000);
        }
    }

    public static void main(String[] args) throws Exception {
        switchPop();
        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(CONSUMER_GROUP);
        consumer.subscribe(TOPIC, "*");
        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET);
        consumer.registerMessageListener((MessageListenerConcurrently) (msgs, context) -> {
            System.out.printf("%s Receive New Messages: %s %n", Thread.currentThread().getName(), msgs);
            return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
        });
        consumer.setClientRebalance(false);
        consumer.start();
        System.out.printf("Consumer Started.%n");
    }
}
```

## æ€»ç»“

`pop`æ¶ˆè´¹æ–¹å¼çš„å‡ºç°ä¸»è¦æ˜¯ä¸ºäº†è§£å†³ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š
1. `Rebalance`åœ¨`broker`å®ç°ï¼Œæ–¹ä¾¿å¤šè¯­è¨€`client`å®ç°ç»´æŠ¤.æ›´ç¬¦åˆäº‘åŸç”Ÿ
2. å•ä¸ªå®¢æˆ·ç«¯æ¶ˆè´¹æ‰€æœ‰`queue`,é¿å…å•ä¸ª`client`å‡æ­»é€ æˆæ¶ˆæ¯å †ç§¯
3. é¿å…å‡ºç°å› ä¸ºqueueä¸è¶³å¯¼è‡´çš„æ‰©å±•`consumer`æå‡æ¶ˆè´¹èƒ½åŠ›å¼‚å¸¸
4. é¿å…æ¶ˆæ¯é˜Ÿåˆ—æ•°é‡ä¸`consumer`æ•°é‡æ¯”ä¾‹ä¸å‡è¡¡æ—¶å¯¼è‡´çš„æŸäº›`consumer`æ‰¿æ‹…è¿‡å¤šçš„æ¶ˆæ¯

åç»­æœ‰æœºä¼šå†åˆ†æä¸‹`pop`æ¶ˆè´¹æ—¶é—´çš„æºç ä»¥åŠæ›´å¤šç»†èŠ‚

## å‚è€ƒ
- [[RIP 19] Server side rebalance, lightweight consumer client support
](https://github.com/apache/rocketmq/wiki/%5BRIP-19%5D-Server-side-rebalance,--lightweight-consumer-client-support)

- [RocketMQ 5.0ï¼šPOP æ¶ˆè´¹æ¨¡å¼ åŸç†è¯¦è§£ & æºç è§£æ
](https://hscarb.github.io/rocketmq/20221212-rocketmq-consumer-7-pop-consume.html)
