
## 主要预发

- 开始: sequenceDiagram
- 自动生成数字序列: autonumber
- 颜色包裹: `rect rgb(255, 250, 240) end`
- A对象到B对象: `A->>B: xxx`
- 备注：`Note right of AC_TRANSIT: xx备注`
- 虚箭头: `A-->>B: xxx`
- 单个流程开始: `A->>+B: xxx`
- 单个流程结束: `A->>-B: xxx`
- 定义节点: `participant ass xxx`


## 一个比较好的例子

```Mermaid
sequenceDiagram
    autonumber
    actor User as 👨‍💻 运维/DBA
    participant Aurora as 🗄️ 上游 Aurora
    participant Ghost as 👻 gh-ost
    participant DTS as 🔄 阿里云 DTS
    participant Down as 📉 下游 RDS/ADB

    Note over User, Down: 🛑 第一阶段：前置配置 (防止流量爆炸)
    User->>DTS: 1. 修改 DTS 配置，过滤表对象<br/>(屏蔽 _.*_gho, _.*_del)
    DTS-->>User: 配置生效 (DTS 此时不再同步临时表)

    Note over User, Down: 🚀 第二阶段：启动迁移 (上游开始跑数据)
    User->>Ghost: 2. 启动 gh-ost (screen后台)<br/>带参数 --postpone-cut-over-flag-file
    Ghost->>Aurora: 创建 _gho 临时表
    Ghost->>Aurora: 开始全量拷贝 + Binlog 应用
    
    rect rgb(240, 248, 255)
        Note right of Ghost: ⏳ 耗时操作：数据拷贝中... <br/>(DTS 保持运行，业务无感知)
    end

    Note over User, Down: 🛠️ 第三阶段：下游并行改造 (利用拷贝空窗期)
    User->>DTS: 3. 暂停 DTS 任务
    User->>Down: 4. 手动执行 ALTER TABLE ... MODIFY INT
    Down-->>User: 执行完成 (下游已变成 INT)
    User->>DTS: 5. 恢复 DTS 任务
    
    rect rgb(230, 255, 230)
        Note right of DTS: ✅ 兼容状态：<br/>Aurora(TINYINT) -> DTS -> Down(INT)<br/>同步正常进行
    end

    Note over User, Down: ✂️ 第四阶段：正式切换 (Cut-over)
    Ghost-->>User: 进度 100%, 状态: Postponing cut-over
    User->>User: 6. 确认 Aurora 无长事务/慢SQL
    User->>Ghost: 7. 删除标志文件 (触发切换)
    
    activate Ghost
    Ghost->>Aurora: 8. 获取 MDL 锁, 执行 RENAME TABLE
    Aurora-->>Ghost: 切换成功 (旧表变 _del, 新表上位)
    deactivate Ghost
    
    Note over Aurora, DTS: ⚠️ 关键时刻：DTS 处理 RENAME
    Aurora->>DTS: Binlog 推送 RENAME DDL

    alt DTS 策略 A (已配置忽略DDL)
        DTS->>DTS: 自动忽略 RENAME, 继续同步
    else DTS 策略 B (默认报错)
        DTS--x User: ❌ 任务报错挂起 (Table doesn't exist)
        User->>DTS: 9. 控制台点击 "跳过/忽略" 当前 DDL
        DTS->>Down: 恢复同步
    end

    Note over User, Down: 🎉 第五阶段：收尾
    User->>Down: 验证数据写入正常
    User->>Aurora: (24小时后) 删除 _del 表
```